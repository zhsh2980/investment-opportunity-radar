{% extends "base.html" %}

{% block title %}æ§åˆ¶å° - æŠ•èµ„æœºä¼šé›·è¾¾{% endblock %}

{% block content %}
<div class="space-y-8">

    <!-- Welcome Section -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-slate-900">æ—©å®‰, {{ username }}</h1>
            <p class="text-slate-500 mt-1">è¿™æ˜¯ä»Šå¤©çš„æŠ•èµ„æœºä¼šåˆ†ææ¦‚è§ˆã€‚</p>
        </div>
        <div class="flex flex-col md:flex-row gap-3">
            <a href="/health" id="health-check-btn"
                class="inline-flex items-center justify-center px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors shadow-sm w-full md:w-auto gap-2">
                å¥åº·æ£€æŸ¥
                <svg class="w-4 h-4 text-slate-300 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
            </a>
            <button onclick="runAnalysisNow(this)"
                class="inline-flex items-center justify-center px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 transition-colors shadow-sm w-full md:w-auto">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                ç«‹å³åˆ†æ
            </button>
            <a href="/daily/{{ today_date }}"
                class="inline-flex items-center justify-center px-4 py-2 bg-indigo-600 border border-transparent rounded-lg text-sm font-medium text-white hover:bg-indigo-700 transition-colors shadow-sm w-full md:w-auto">
                æŸ¥çœ‹ä»Šæ—¥æ—¥æŠ¥
            </a>
        </div>
    </div>

    <!-- Status Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Card 1: Analysis Progress -->
        <div id="analysis-progress-card"
            class="bg-white rounded-lg border border-slate-200 shadow-sm p-6 flex flex-col justify-between h-full hover:shadow-md transition-shadow">

            <!-- ç©ºé—²çŠ¶æ€ -->
            <div id="idle-state">
                <dt class="text-sm font-medium text-slate-500 uppercase tracking-wider">å¾…åˆ†ææ–‡ç« </dt>
                <dd id="pending-count" class="mt-2 text-3xl font-bold text-slate-900 leading-none">--</dd>
                <div class="mt-4">
                    <div class="text-sm text-slate-500">ä»Šæ—¥æ€»è®¡è·å–</div>
                </div>
            </div>

            <!-- åˆ†æä¸­çŠ¶æ€ -->
            <div id="analyzing-state" style="display:none;">
                <dt class="text-sm font-medium text-slate-500 uppercase tracking-wider mb-3">ğŸ“Š åˆ†æè¿›åº¦</dt>

                <!-- è¿›åº¦æ¡ -->
                <div class="w-full bg-slate-100 rounded-full h-2 mb-3">
                    <div id="progress-fill" class="bg-indigo-600 h-2 rounded-full transition-all duration-500"
                        style="width: 0%"></div>
                </div>

                <!-- è¿›åº¦ä¿¡æ¯ -->
                <div class="space-y-2">
                    <div class="text-sm">
                        <span class="text-slate-600">æ­£åœ¨åˆ†æ:</span>
                        <span id="current-title" class="text-slate-900 font-medium">--</span>
                    </div>
                    <div class="text-sm text-slate-600">
                        å…± <span id="total-count">0</span> ç¯‡ | å·²åˆ†æ <span id="analyzed-count">0</span> ç¯‡ | å‰©ä½™ <span
                            id="remaining-count">0</span> ç¯‡
                    </div>
                    <div class="text-sm text-slate-500">
                        é¢„è®¡å‰©ä½™: <span id="estimated-time">--</span> åˆ†é’Ÿ
                    </div>
                </div>
            </div>
        </div>


        <!-- Card 2: Opportunities -->
        <div
            class="bg-white rounded-lg border border-slate-200 shadow-sm p-6 flex flex-col justify-between h-full hover:shadow-md transition-shadow">
            <div>
                <dt class="text-sm font-medium text-slate-500 uppercase tracking-wider">ä»Šæ—¥æœºä¼š</dt>
                <dd class="mt-2 text-3xl font-bold text-indigo-600 leading-none">--</dd>
            </div>
            <div class="mt-4">
                <span
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-50 text-indigo-700 ring-1 ring-inset ring-indigo-700/10">
                    é«˜æ½œåŠ›
                </span>
            </div>
        </div>

        <!-- Card 3: Push Status -->
        <div
            class="bg-white rounded-lg border border-slate-200 shadow-sm p-6 flex flex-col justify-between h-full hover:shadow-md transition-shadow">
            <div>
                <dt class="text-sm font-medium text-slate-500 uppercase tracking-wider">æ¨é€æ¬¡æ•°</dt>
                <dd class="mt-2 text-3xl font-bold text-slate-900 leading-none">--</dd>
            </div>
            <div class="mt-4">
                <div class="flex gap-1 h-1.5 mt-2">
                    <!-- 5 slots visual representation -->
                    <div class="flex-1 bg-slate-100 rounded-lr" title="07:00"></div>
                    <div class="flex-1 bg-slate-100 rounded-lr" title="12:00"></div>
                    <div class="flex-1 bg-slate-100 rounded-lr" title="14:00"></div>
                    <div class="flex-1 bg-slate-100 rounded-lr" title="18:00"></div>
                    <div class="flex-1 bg-slate-100 rounded-lr" title="22:00"></div>
                </div>
                <div class="mt-2 text-xs text-slate-400 flex justify-between font-mono">
                    <span>07:00</span>
                    <span>22:00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Usage/Info Section -->
    <div class="bg-white rounded-lg border border-slate-200 shadow-sm divide-y divide-slate-100">
        <div class="p-6">
            <h3 class="text-base font-semibold text-slate-900">ç³»ç»ŸçŠ¶æ€</h3>
        </div>
        <div class="p-6">
            <ul class="space-y-4">
                <li class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-slate-50 rounded-lg text-slate-500 ring-1 ring-slate-900/5">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <p class="font-medium text-slate-900">WeRSS è¿æ¥</p>
                            <p id="werss-message" class="text-sm text-slate-500">æ­£åœ¨æ£€æµ‹...</p>
                        </div>
                    </div>
                    <span id="werss-status"
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600 ring-1 ring-inset ring-slate-500/10">
                        æ£€æµ‹ä¸­
                    </span>
                </li>
                <li class="flex items-center justify-between pt-4 border-t border-slate-50">
                    <div class="flex items-center gap-4">
                        <div class="p-3 bg-slate-50 rounded-lg text-slate-500 ring-1 ring-slate-900/5">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                    d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <p class="font-medium text-slate-900">DeepSeek API</p>
                            <p id="deepseek-message" class="text-sm text-slate-500">æ­£åœ¨æ£€æµ‹...</p>
                        </div>
                    </div>
                    <span id="deepseek-status"
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600 ring-1 ring-inset ring-slate-500/10">
                        æ£€æµ‹ä¸­
                    </span>
                </li>
            </ul>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // ===== Toast é€šçŸ¥ =====
    function showToast(message, isSuccess = true) {
        // ç§»é™¤æ—§çš„ toast
        const oldToast = document.getElementById('toast');
        if (oldToast) oldToast.remove();

        const toast = document.createElement('div');
        toast.id = 'toast';
        toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${isSuccess ? 'bg-green-500 text-white' : 'bg-red-500 text-white'}`;
        toast.innerHTML = message.replace(/\n/g, '<br>');
        document.body.appendChild(toast);

        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    async function runAnalysisNow(btn) {
        if (btn.disabled) return;

        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = `
            <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            åˆ†æä¸­
        `;

        try {
            const response = await fetch('/api/run-now', {
                method: 'POST',
            });
            const result = await response.json();

            if (result.status === 'success') {
                showToast('âœ… ' + result.message);
                startProgressPolling();  // å¯åŠ¨è¿›åº¦è½®è¯¢
                // æˆåŠŸæ—¶ä¿æŒç¦ç”¨çŠ¶æ€ï¼Œç­‰å¾…åˆ†æå®Œæˆåç”±è½®è¯¢é€»è¾‘æ¢å¤
            } else {
                // å¤±è´¥ï¼ˆå¦‚æœ‰ä»»åŠ¡æ­£åœ¨æ‰§è¡Œï¼‰
                showToast('âš ï¸ ' + result.message, false);
                // æ¢å¤æŒ‰é’®
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        } catch (error) {
            showToast('âŒ è¯·æ±‚å¤±è´¥: ' + error.message, false);
            // æ¢å¤æŒ‰é’®
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    // ===== è¿›åº¦è½®è¯¢é€»è¾‘ =====
    let progressInterval = null;

    async function fetchProgress() {
        try {
            const response = await fetch('/api/analysis-progress');
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('è·å–è¿›åº¦å¤±è´¥:', error);
            return null;
        }
    }

    function updateProgressUI(data) {
        const idleState = document.getElementById('idle-state');
        const analyzingState = document.getElementById('analyzing-state');
        const pendingCount = document.getElementById('pending-count');
        const progressFill = document.getElementById('progress-fill');
        const currentTitle = document.getElementById('current-title');
        const totalCount = document.getElementById('total-count');
        const analyzedCount = document.getElementById('analyzed-count');
        const remainingCount = document.getElementById('remaining-count');
        const estimatedTime = document.getElementById('estimated-time');

        if (data.is_running && data.total_initial > 0) {
            // æ˜¾ç¤ºåˆ†æä¸­çŠ¶æ€
            idleState.style.display = 'none';
            analyzingState.style.display = 'block';

            // æ›´æ–°è¿›åº¦æ¡
            const percent = data.total_initial > 0
                ? (data.analyzed_count / data.total_initial) * 100
                : 0;
            progressFill.style.width = percent + '%';

            // æ›´æ–°å½“å‰æ–‡ç« 
            if (data.current_article && data.current_article.title) {
                currentTitle.textContent = data.current_article.title;
            } else {
                currentTitle.textContent = 'å‡†å¤‡ä¸­...';
            }

            // æ›´æ–°è¿›åº¦æ•°å­—
            totalCount.textContent = data.total_initial || 0;
            analyzedCount.textContent = data.analyzed_count || 0;
            remainingCount.textContent = data.remaining || 0;
            estimatedTime.textContent = data.estimated_remaining_minutes || '--';
        } else {
            // æ˜¾ç¤ºç©ºé—²çŠ¶æ€
            idleState.style.display = 'block';
            analyzingState.style.display = 'none';
            pendingCount.textContent = data.total_pending || '--';
        }
    }

    async function pollProgress() {
        const data = await fetchProgress();
        if (data) {
            updateProgressUI(data);

            // å¦‚æœåˆ†æå®Œæˆï¼Œåœæ­¢è½®è¯¢
            if (!data.is_running) {
                stopProgressPolling();
            }
        }
    }

    function startProgressPolling() {
        if (progressInterval) return; // é˜²æ­¢é‡å¤å¯åŠ¨

        // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        pollProgress();

        // æ¯5ç§’è½®è¯¢ä¸€æ¬¡
        progressInterval = setInterval(pollProgress, 5000);
    }

    function stopProgressPolling() {
        if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
        }
        // æ¢å¤"ç«‹å³åˆ†æ"æŒ‰é’®
        resetAnalysisButton();
    }

    function resetAnalysisButton() {
        const btn = document.querySelector('button[onclick*="runAnalysisNow"]');
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = `
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                ç«‹å³åˆ†æ
            `;
        }
    }

    // ===== ç³»ç»ŸçŠ¶æ€æ£€æµ‹ =====
    async function checkSystemStatus() {
        const werssMessage = document.getElementById('werss-message');
        const werssStatus = document.getElementById('werss-status');
        const deepseekMessage = document.getElementById('deepseek-message');
        const deepseekStatus = document.getElementById('deepseek-status');

        try {
            const response = await fetch('/api/system-status');
            const data = await response.json();

            // æ›´æ–° WeRSS çŠ¶æ€
            if (data.werss) {
                werssMessage.textContent = data.werss.message;
                if (data.werss.status === 'ok') {
                    werssStatus.textContent = 'æ­£å¸¸';
                    werssStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-700 ring-1 ring-inset ring-green-600/20';
                } else {
                    werssStatus.textContent = 'å¼‚å¸¸';
                    werssStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-50 text-red-700 ring-1 ring-inset ring-red-600/20';
                }
            }

            // æ›´æ–° DeepSeek çŠ¶æ€
            if (data.deepseek) {
                deepseekMessage.textContent = data.deepseek.message;
                if (data.deepseek.status === 'ok') {
                    deepseekStatus.textContent = 'å°±ç»ª';
                    deepseekStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-50 text-green-700 ring-1 ring-inset ring-green-600/20';
                } else {
                    deepseekStatus.textContent = 'å¼‚å¸¸';
                    deepseekStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-50 text-red-700 ring-1 ring-inset ring-red-600/20';
                }
            }
        } catch (error) {
            console.error('æ£€æŸ¥ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
            // æ˜¾ç¤ºæ£€æµ‹å¤±è´¥çŠ¶æ€
            werssMessage.textContent = 'æ£€æµ‹å¤±è´¥';
            werssStatus.textContent = 'æœªçŸ¥';
            werssStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-50 text-amber-700 ring-1 ring-inset ring-amber-600/20';
            deepseekMessage.textContent = 'æ£€æµ‹å¤±è´¥';
            deepseekStatus.textContent = 'æœªçŸ¥';
            deepseekStatus.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-50 text-amber-700 ring-1 ring-inset ring-amber-600/20';
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„åˆ†æ
    document.addEventListener('DOMContentLoaded', async () => {
        // æ£€æŸ¥åˆ†æè¿›åº¦
        const data = await fetchProgress();
        if (data) {
            updateProgressUI(data);
            if (data.is_running) {
                startProgressPolling();
                // ç¦ç”¨æŒ‰é’®å¹¶æ˜¾ç¤ºåˆ†æä¸­çŠ¶æ€
                const btn = document.querySelector('button[onclick*="runAnalysisNow"]');
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = `
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        åˆ†æä¸­
                    `;
                }
            }
        }

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        checkSystemStatus();

        // æ£€æŸ¥å¥åº·æŒ‰é’®çŠ¶æ€
        checkHealthButton();
    });

    // ===== é¦–é¡µæŒ‰é’®å¥åº·æ£€æŸ¥ =====
    async function checkHealthButton() {
        const btn = document.getElementById('health-check-btn');
        const iconContainer = btn.querySelector('svg');

        try {
            const response = await fetch('/healthz?detailed=true');
            const data = await response.json();

            if (data.status === 'ok') {
                // Green check
                iconContainer.outerHTML = '<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
            } else {
                // Red alert
                iconContainer.outerHTML = '<svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>';
            }
        } catch (e) {
            console.error('Health check failed', e);
            // Gray question mark
            iconContainer.outerHTML = '<svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        }
    }

</script>
{% endblock %}