{% extends "base.html" %}

{% block title %}Prompt ç®¡ç† - æŠ•èµ„æœºä¼šé›·è¾¾{% endblock %}

{% block content %}
<div class="prompts-page">
    <header class="page-header">
        <h1>ğŸ“ Prompt ç®¡ç†</h1>
        <p class="page-desc">ç®¡ç† DeepSeek åˆ†æä½¿ç”¨çš„æç¤ºè¯æ¨¡æ¿</p>
    </header>

    {% for name, versions in prompts_by_name.items() %}
    <section class="prompt-section">
        <div class="prompt-header">
            <h2>{{ name }}</h2>
            {% if name in active_prompts %}
            <span class="active-badge">å½“å‰ç‰ˆæœ¬: v{{ active_prompts[name].version }}</span>
            {% endif %}
        </div>

        <!-- å½“å‰æ´»è·ƒç‰ˆæœ¬ -->
        {% if name in active_prompts %}
        {% set active = active_prompts[name] %}
        <div class="active-prompt-card">
            <div class="prompt-meta">
                <span class="version-tag">v{{ active.version }}</span>
                <span class="status-active">âœ“ æ´»è·ƒ</span>
                <span class="create-time">åˆ›å»ºäº {{ active.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
            </div>

            <div class="prompt-content-section">
                <h4>ç³»ç»Ÿæç¤ºè¯ (System Prompt)</h4>
                <div class="prompt-textarea-wrapper">
                    <textarea id="system-{{ name }}" class="prompt-textarea"
                        readonly>{{ active.system_prompt }}</textarea>
                </div>
            </div>

            <div class="prompt-content-section">
                <h4>ç”¨æˆ·æç¤ºè¯æ¨¡æ¿ (User Prompt Template)</h4>
                <div class="prompt-textarea-wrapper">
                    <textarea id="user-{{ name }}" class="prompt-textarea"
                        readonly>{{ active.user_template }}</textarea>
                </div>
            </div>

            {% if active.threshold %}
            <div class="prompt-info">
                <span><strong>æ¨é€é˜ˆå€¼:</strong> {{ active.threshold }} åˆ†</span>
            </div>
            {% endif %}

            <div class="prompt-actions">
                <button class="btn-edit" onclick="enableEdit('{{ name }}')">âœï¸ ç¼–è¾‘</button>
                <button class="btn-copy" onclick="copyPrompt('{{ name }}')">ğŸ“‹ å¤åˆ¶</button>
            </div>
        </div>
        {% endif %}

        <!-- å†å²ç‰ˆæœ¬åˆ—è¡¨ -->
        {% if versions|length > 1 %}
        <div class="version-history">
            <h4>ğŸ“š å†å²ç‰ˆæœ¬</h4>
            <table class="version-table">
                <thead>
                    <tr>
                        <th>ç‰ˆæœ¬</th>
                        <th>çŠ¶æ€</th>
                        <th>åˆ›å»ºæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for v in versions %}
                    {% if not v.is_active %}
                    <tr>
                        <td>v{{ v.version }}</td>
                        <td><span class="status-inactive">æœªæ¿€æ´»</span></td>
                        <td>{{ v.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            <button class="btn-sm btn-view" onclick="viewVersion({{ v.id }})">æŸ¥çœ‹</button>
                            <form action="/api/prompts/{{ v.id }}/activate" method="POST" style="display:inline;">
                                <button type="submit" class="btn-sm btn-activate">æ¿€æ´»</button>
                            </form>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </section>
    {% endfor %}

    {% if not prompts_by_name %}
    <div class="empty-state">
        <p>æš‚æ—  Prompt é…ç½®</p>
        <p class="hint">è¯·è¿è¡Œ <code>python src/manage.py init-prompts</code> åˆå§‹åŒ–é»˜è®¤ Prompt</p>
    </div>
    {% endif %}
</div>

<!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
<div id="editModal" class="modal" style="display:none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ç¼–è¾‘ Prompt</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="editForm" action="/api/prompts" method="POST">
            <input type="hidden" name="name" id="editName">
            <div class="form-group">
                <label>ç³»ç»Ÿæç¤ºè¯</label>
                <textarea name="system_prompt" id="editSystemPrompt" rows="10"></textarea>
            </div>
            <div class="form-group">
                <label>ç”¨æˆ·æç¤ºè¯æ¨¡æ¿</label>
                <textarea name="user_template" id="editUserTemplate" rows="10"></textarea>
            </div>
            <div class="form-group">
                <label>æ¨é€é˜ˆå€¼</label>
                <input type="number" name="threshold" id="editThreshold" min="0" max="100" value="60">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="submit" class="btn-save">ä¿å­˜æ–°ç‰ˆæœ¬</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function enableEdit(name) {
        document.getElementById('editName').value = name;
        document.getElementById('editSystemPrompt').value = document.getElementById('system-' + name).value;
        document.getElementById('editUserTemplate').value = document.getElementById('user-' + name).value;
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    function copyPrompt(name) {
        const system = document.getElementById('system-' + name).value;
        const user = document.getElementById('user-' + name).value;
        const text = `=== System Prompt ===\n${system}\n\n=== User Template ===\n${user}`;
        navigator.clipboard.writeText(text).then(() => {
            alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        });
    }

    function viewVersion(id) {
        window.location.href = '/prompts/' + id;
    }
</script>
{% endblock %}