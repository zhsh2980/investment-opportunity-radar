{% extends "base.html" %}

{% block title %}ç³»ç»Ÿè®¾ç½® - æŠ•èµ„æœºä¼šé›·è¾¾{% endblock %}

{% block content %}
<div class="settings-page">
    <header class="page-header">
        <h1>âš™ï¸ ç³»ç»Ÿè®¾ç½®</h1>
        <p class="page-desc">é…ç½®ç³»ç»Ÿè¿è¡Œå‚æ•°</p>
    </header>

    <form id="settingsForm" action="/api/settings" method="POST" class="settings-form">
        <!-- æ¨é€è®¾ç½® -->
        <section class="settings-section">
            <h2>ğŸ“£ æ¨é€è®¾ç½®</h2>

            <div class="setting-item">
                <div class="setting-info">
                    <label for="push_score_threshold">æ¨é€é˜ˆå€¼</label>
                    <p class="setting-desc">åªæœ‰è¯„åˆ†è¾¾åˆ°æ­¤é˜ˆå€¼çš„æœºä¼šæ‰ä¼šæ¨é€åˆ°é’‰é’‰</p>
                </div>
                <div class="setting-control">
                    <input type="number" id="push_score_threshold" name="push_score_threshold"
                        value="{{ settings.push_score_threshold }}" min="0" max="100" step="5">
                    <span class="unit">åˆ†</span>
                </div>
            </div>
        </section>

        <!-- ç™»å½•è®¾ç½® -->
        <section class="settings-section">
            <h2>ğŸ” ç™»å½•è®¾ç½®</h2>

            <div class="setting-item">
                <div class="setting-info">
                    <label for="remember_me_days">è®°ä½ç™»å½•å¤©æ•°</label>
                    <p class="setting-desc">å‹¾é€‰"è®°ä½æˆ‘"å Cookie çš„æœ‰æ•ˆæœŸ</p>
                </div>
                <div class="setting-control">
                    <input type="number" id="remember_me_days" name="remember_me_days"
                        value="{{ settings.remember_me_days }}" min="1" max="365">
                    <span class="unit">å¤©</span>
                </div>
            </div>
        </section>

        <!-- åˆ†æè®¾ç½® -->
        <section class="settings-section">
            <h2>ğŸ” åˆ†æè®¾ç½®</h2>

            <div class="setting-item">
                <div class="setting-info">
                    <label for="window_days">åˆ†æçª—å£å¤©æ•°</label>
                    <p class="setting-desc">æ¯æ¬¡è¿è¡Œæ—¶å›æº¯å¤šå°‘å¤©çš„æ–‡ç« è¿›è¡Œåˆ†æ</p>
                </div>
                <div class="setting-control">
                    <input type="number" id="window_days" name="window_days" value="{{ settings.window_days }}" min="1"
                        max="7">
                    <span class="unit">å¤©</span>
                </div>
            </div>
        </section>

        <!-- å®šæ—¶ä»»åŠ¡ï¼ˆåªè¯»ï¼‰ -->
        <section class="settings-section">
            <h2>â° å®šæ—¶ä»»åŠ¡</h2>

            <div class="setting-item">
                <div class="setting-info">
                    <label>è°ƒåº¦æ—¶é—´ç‚¹</label>
                    <p class="setting-desc">ç³»ç»Ÿæ¯å¤©åœ¨è¿™äº›æ—¶é—´ç‚¹è‡ªåŠ¨è¿è¡Œåˆ†æä»»åŠ¡</p>
                </div>
                <div class="setting-control readonly">
                    <div class="schedule-slots">
                        {% for slot in settings.schedule_slots %}
                        <span class="slot-badge">{{ slot }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <p class="setting-note">
                ğŸ’¡ ä¿®æ”¹è°ƒåº¦æ—¶é—´éœ€è¦ç¼–è¾‘ <code>celery_app.py</code> å¹¶é‡å¯ Beat æœåŠ¡
            </p>
        </section>

        <!-- ä¿å­˜æŒ‰é’® -->
        <div class="form-actions">
            <button type="submit" class="btn-save">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
            <button type="reset" class="btn-reset">â†©ï¸ é‡ç½®</button>
        </div>
    </form>

    <!-- ç³»ç»Ÿä¿¡æ¯ -->
    <section class="settings-section info-section">
        <h2>â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</h2>
        <div class="info-grid">
            <div class="info-item">
                <span class="info-label">ç‰ˆæœ¬</span>
                <span class="info-value">v0.1.0</span>
            </div>
            <div class="info-item">
                <span class="info-label">Python</span>
                <span class="info-value">3.11</span>
            </div>
            <div class="info-item">
                <span class="info-label">æ•°æ®åº“</span>
                <span class="info-value">PostgreSQL</span>
            </div>
            <div class="info-item">
                <span class="info-label">ç¼“å­˜</span>
                <span class="info-value">Redis</span>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.getElementById('settingsForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = {};
        formData.forEach((value, key) => {
            data[key] = parseInt(value) || value;
        });

        try {
            const response = await fetch('/api/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                alert('è®¾ç½®å·²ä¿å­˜');
            } else {
                const err = await response.json();
                alert('ä¿å­˜å¤±è´¥: ' + (err.detail || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (error) {
            alert('ä¿å­˜å¤±è´¥: ' + error.message);
        }
    });
</script>
{% endblock %}