{% extends "base.html" %}

{% block title %}{{ report_date }} æ—¥æŠ¥ - æŠ•èµ„æœºä¼šé›·è¾¾{% endblock %}

{% block content %}
<div class="daily-page">
    <!-- æ—¥æŠ¥å¤´éƒ¨ -->
    <header class="daily-header">
        <div class="date-nav">
            <a href="/daily/{{ (report_date - timedelta(days=1)).isoformat() }}" class="nav-arrow">â† å‰ä¸€å¤©</a>
            <h1>ğŸ“Š {{ report_date.strftime('%Yå¹´%mæœˆ%dæ—¥') }} æ—¥æŠ¥</h1>
            <a href="/daily/{{ (report_date + timedelta(days=1)).isoformat() }}" class="nav-arrow">åä¸€å¤© â†’</a>
        </div>

        <!-- ä»Šæ—¥ç»“è®º -->
        <div class="daily-conclusion {% if opportunities %}has-opp{% else %}no-opp{% endif %}">
            {% if opportunities %}
            <div class="conclusion-icon">ğŸ¯</div>
            <div class="conclusion-text">
                <h2>å‘ç° {{ opportunities|length }} ä¸ªæŠ•èµ„æœºä¼š</h2>
                <p>æœ€é«˜è¯„åˆ†: {{ opportunities[0].score if opportunities else 0 }} åˆ†</p>
            </div>
            {% else %}
            <div class="conclusion-icon">ğŸ“­</div>
            <div class="conclusion-text">
                <h2>ä»Šæ—¥æ— æŠ•èµ„æœºä¼š</h2>
                <p>é˜ˆå€¼: {{ threshold }} åˆ†</p>
            </div>
            {% endif %}
        </div>

        <!-- Slot è¿›åº¦ -->
        <div class="slots-progress-bar">
            {% set slot_labels = {'07:00': 1, '12:00': 2, '14:00': 3, '18:00': 4, '22:00': 5} %}
            {% for slot_label in ['07:00', '12:00', '14:00', '18:00', '22:00'] %}
            {% set slot_done = slots | selectattr('slot', 'equalto', slot_label) | selectattr('status', 'equalto', 1) |
            list %}
            <div class="slot-progress-item {% if slot_done %}done{% else %}pending{% endif %}">
                <span class="slot-label">{{ slot_label }}</span>
                <span class="slot-status">{% if slot_done %}âœ“{% else %}â—‹{% endif %}</span>
            </div>
            {% endfor %}
        </div>
    </header>

    <!-- æµ“ç¼©èµ„è®¯ -->
    {% if report and report.digest_md %}
    <section class="digest-section">
        <h2 class="section-title">ğŸ“‹ æµ“ç¼©èµ„è®¯</h2>
        <div class="digest-content markdown-body">
            {{ report.digest_md | safe }}
        </div>
    </section>
    {% endif %}

    <!-- ä»Šæ—¥æœºä¼š Top 3 -->
    {% if opportunities %}
    <section class="top-opportunities-section">
        <h2 class="section-title">ğŸ¯ ä»Šæ—¥æœºä¼š Top {{ [opportunities|length, 3]|min }}</h2>
        <div class="opportunity-cards">
            {% for analysis in opportunities[:3] %}
            <a href="/analysis/{{ analysis.id }}" class="opp-card">
                <div
                    class="opp-card-score score-{{ 'high' if analysis.score >= 80 else ('medium' if analysis.score >= 60 else 'low') }}">
                    {{ analysis.score }}
                </div>
                <div class="opp-card-body">
                    <h4>{{ analysis.content_item.title[:50] }}{% if analysis.content_item.title|length > 50 %}...{%
                        endif %}</h4>
                    <p class="meta">{{ analysis.content_item.mp_name or 'æœªçŸ¥' }} Â· {{
                        analysis.content_item.published_at.strftime('%H:%M') }}</p>
                    <p class="summary">{{ analysis.summary_md[:80] }}...</p>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endif %}

    <!-- å…¨é‡åˆ†æåˆ—è¡¨ -->
    <section class="all-analyses-section">
        <h2 class="section-title">ğŸ“ å…¨éƒ¨åˆ†æï¼ˆ{{ analyses|length }} ç¯‡ï¼‰</h2>

        {% if analyses %}
        <div class="filter-bar">
            <label>
                <input type="checkbox" id="onlyOpportunities" onchange="filterAnalyses()">
                ä»…çœ‹æœºä¼š
            </label>
        </div>

        <div class="analysis-list" id="analysisList">
            {% for analysis in analyses %}
            <div class="analysis-row {% if analysis.has_opportunity and analysis.score >= threshold %}is-opportunity{% endif %}"
                data-score="{{ analysis.score }}"
                data-opportunity="{{ 'true' if analysis.has_opportunity and analysis.score >= threshold else 'false' }}">
                <div
                    class="row-score score-{{ 'high' if analysis.score >= 80 else ('medium' if analysis.score >= 60 else 'low') }}">
                    {{ analysis.score }}
                </div>
                <div class="row-content">
                    <h4>{{ analysis.content_item.title }}</h4>
                    <p class="row-meta">
                        {{ analysis.content_item.mp_name or 'æœªçŸ¥' }} Â·
                        {{ analysis.content_item.published_at.strftime('%H:%M') }}
                    </p>
                </div>
                <a href="/analysis/{{ analysis.id }}" class="row-link">æŸ¥çœ‹ â†’</a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>å½“æ—¥æš‚æ— åˆ†æç»“æœ</p>
        </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function filterAnalyses() {
        const onlyOpp = document.getElementById('onlyOpportunities').checked;
        const rows = document.querySelectorAll('.analysis-row');
        rows.forEach(row => {
            if (onlyOpp && row.dataset.opportunity !== 'true') {
                row.style.display = 'none';
            } else {
                row.style.display = 'flex';
            }
        });
    }
</script>
{% endblock %}