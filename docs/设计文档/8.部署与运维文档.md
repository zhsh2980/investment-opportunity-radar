According to a document from **2026-01-08**,WeRSS 推荐同机用 `http://localhost:8001` 访问，API 基础路径是 `/api`，并且除 RSS 订阅外的 API 需要 Bearer Token 认证（默认 `expires_in=259200` 秒）。下面是**第 8 份文档：部署与运维文档（Docker Compose + Nginx + 日志/备份/升级/告警 Runbook）**。

------

# 文档 8/10：部署与运维文档（Deployment & Ops）

## 0. 目标与部署原则

- **公网可访问、无域名**：用公网 IP + Nginx 反代。
- **服务稳定、可重启自恢复**：容器化（Docker Compose）+ 自动重启策略。
- **可观测、可回溯**：日志、批次运行记录、推送记录、失败重试。
- **不直连 WeRSS 的 SQLite**：统一通过 WeRSS HTTP API 读取数据（同机也需要 Token）。

------

## 1. 运行拓扑（推荐）

同一台 Ubuntu 服务器上跑：

- **Nginx**（宿主机）：对外暴露 `80`（可选 `443`）
- **机会雷达（本系统）**：Docker Compose
  - `radar-web`：FastAPI Web + HTML 页面
  - `radar-worker`：Celery Worker（分析任务）
  - `radar-beat`：Celery Beat（北京时间 5 次定时）
  - `postgres`：业务库（保存原文快照、分析结果、日报、推送日志、prompt 版本等）
  - `redis`：session / token cache / task broker（也可只做 broker）
- **WeRSS**：已存在（你已有项目），本系统通过 `http://localhost:8001/api/*` 调用。

------

## 2. 服务器前置准备（Ubuntu）

### 2.1 基础软件

- 安装 Docker + Docker Compose plugin
- 安装 Nginx（宿主机反代）

### 2.2 时区与时间同步

- 服务器时区设为北京时间（Asia/Shanghai）
- NTP 保持准确（避免钉钉签名 timestamp 偏差引发失败）

------

## 3. 目录规划（宿主机）

建议统一放在 `/srv/opportunity-insight`：

```
/srv/opportunity-insight/
  app/                   # 你的代码
  docker-compose.yml
  .env                   # 生产环境变量（不入 git）
  nginx/
    radar.conf
  data/
    postgres/            # PG 数据卷
    redis/               # Redis 数据卷（可选）
    backups/             # 备份落盘
  logs/                  # 宿主机日志（可选）
```

------

## 4. 关键环境变量（.env 示例）

> 敏感信息只放 `.env`，不要提交到代码库。

### 4.1 WeRSS（通过 API 读取）

WeRSS API 需要 Bearer Token，且同服务器访问也需要 Token；除 RSS 订阅接口外都需要认证。

```bash
# WeRSS
WERSS_BASE_URL=http://localhost:8001
WERSS_API_PREFIX=/api
WERSS_USERNAME=admin
WERSS_PASSWORD=admin@123
```

⚠️ WeRSS 文档明确提示生产环境要修改默认密码。

### 4.2 DeepSeek

```bash
DEEPSEEK_BASE_URL=https://api.deepseek.com
DEEPSEEK_API_KEY=xxx
DEEPSEEK_MODEL=deepseek-reasoner
DEEPSEEK_RESPONSE_FORMAT=json_object
```

### 4.3 钉钉机器人（加签）

```bash
DINGTALK_WEBHOOK=https://oapi.dingtalk.com/robot/send?access_token=xxx
DINGTALK_SECRET=xxx
```

### 4.4 Web 登录（本系统）

```bash
RADAR_ADMIN_USERNAME=admin
RADAR_ADMIN_PASSWORD=change_me_strong
RADAR_SESSION_SECRET=change_me_very_long_random
REMEMBER_ME_DAYS=30
```

### 4.5 业务库/Redis

```bash
POSTGRES_DB=radar
POSTGRES_USER=radar_app
POSTGRES_PASSWORD=change_me_strong

REDIS_URL=redis://redis:6379/0
```

------

## 5. Docker Compose（生产建议配置）

> 这里给一个**可直接落地**的 `docker-compose.yml` 框架（你实现时按实际镜像/命令补齐）。

```yaml
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      TZ: Asia/Shanghai
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    restart: always

  redis:
    image: redis:7
    command: ["redis-server", "--appendonly", "yes"]
    environment:
      TZ: Asia/Shanghai
    volumes:
      - ./data/redis:/data
    restart: always

  radar-web:
    build: .
    environment:
      TZ: Asia/Shanghai
      # 读取 .env：WeRSS/DeepSeek/DingTalk/DB/Redis 等
    env_file: .env
    depends_on: [postgres, redis]
    restart: always
    ports:
      - "127.0.0.1:9000:9000"  # 只对本机，给 Nginx 反代
    command: ["bash", "-lc", "uvicorn app.main:app --host 0.0.0.0 --port 9000"]

  radar-worker:
    build: .
    env_file: .env
    environment:
      TZ: Asia/Shanghai
    depends_on: [postgres, redis]
    restart: always
    command: ["bash", "-lc", "celery -A app.tasks.celery_app worker -l INFO --concurrency=2"]

  radar-beat:
    build: .
    env_file: .env
    environment:
      TZ: Asia/Shanghai
    depends_on: [postgres, redis]
    restart: always
    command: ["bash", "-lc", "celery -A app.tasks.celery_app beat -l INFO"]
```

### 5.1 启动/停止

```bash
cd /srv/opportunity-insight
docker compose up -d --build
docker compose ps
docker compose logs -f radar-web
```

------

## 6. Nginx 反代（公网 IP 访问）

### 6.1 Nginx 配置（无域名）

`/etc/nginx/conf.d/radar.conf`（示例）：

```nginx
server {
  listen 80;
  server_name _;

  client_max_body_size 10m;

  location / {
    proxy_pass http://127.0.0.1:9000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
```

重载：

```bash
nginx -t && systemctl reload nginx
```

> 你已经采用“页面登录（cookie session + 记住我）”，所以 Nginx 不必再加 basic auth。
> 如果你想再加一道保险，可以做 IP 白名单（只允许你家/公司出口 IP）。

------

## 7. 定时任务（北京时间 5 次）落地方式

采用 **Celery Beat**（推荐），在应用里用 crontab 定义：

- 07:00、12:00、14:00、18:00、22:00（Asia/Shanghai）
- 触发同一个任务 `run_slot(slot)`

**关键点**：容器内 `TZ=Asia/Shanghai`，并且 Celery 配置 `timezone="Asia/Shanghai"`。

------

## 8. WeRSS 调用与 Token 运维策略（必须做）

### 8.1 WeRSS API 调用规则（你必须遵守）

- 服务地址：同机建议 `http://localhost:8001`，API 基础路径 `/api`。
- 除 RSS 订阅接口外，所有 API 都需要 Bearer Token。
- Token 默认 `expires_in=259200` 秒（3 天）。
- 同服务器访问也需要 token（不要以为 localhost 免认证）。

### 8.2 Token 自动续期（推荐实现）

- 首选：调用 `POST /api/auth/refresh` 刷新 token（长期运行程序适合）。
- 兜底：refresh 失败 → 重新 `POST /api/auth/token` 登录获取新 token。

### 8.3 401 故障排查

- 若 WeRSS API 返回 401（token 失效），按上面 refresh/login 流程自动恢复（不应人工干预）。

### 8.4 WeRSS 扫码授权风险（影响抓取源头）

WeRSS 抓取公众号首次需要扫码授权，cookie 可能几天到几周后过期，需要重新扫码；WeRSS 也会定时检查授权状态。

**运维建议**：

- 你给 WeRSS 管理后台留一个“授权检查”入口；当我们发现连续 24h 无新文章时，在 22:00 日报里提示“疑似抓取停摆，请检查 WeRSS 授权”。

------

## 9. 日志与可观测性（MVP 也要有）

### 9.1 容器日志

- `docker compose logs -f radar-worker`
- 建议应用日志用 JSON 格式（方便后期接 Loki/ELK）

### 9.2 关键业务指标（至少落库/日志）

- slot_run：每次批次拉取数、新增数、分析成功/失败数、机会数
- notification_log：每次推送成功/失败
- deepseek 调用耗时、429 次数（限流）、重试次数

------

## 10. 数据备份与恢复（强烈建议）

> 你的“历史机会/原文/日报/prompt 版本”都在 Postgres，要备份。

### 10.1 每日备份（pg_dump）

在宿主机加一个 cron（北京时间 02:30）：

```bash
mkdir -p /srv/opportunity-insight/data/backups
```

crontab：

```bash
30 2 * * * docker exec -t opportunity-insight-postgres-1 \
  pg_dump -U radar_app -d radar | gzip > /srv/opportunity-insight/data/backups/radar_$(date +\%F).sql.gz
```

### 10.2 保留策略

- 本地保留 30 天
- 每周/每月再同步到对象存储（腾讯云 COS）——后续你要我可以把 COS 同步脚本也写进文档 8（可选）。

### 10.3 恢复

```bash
gunzip -c radar_2026-01-08.sql.gz | docker exec -i opportunity-insight-postgres-1 psql -U radar_app -d radar
```

------

## 11. 发布与升级流程（不影响运行）

建议采用“滚动替换容器”方式：

1. 拉取新代码
2. 构建镜像并重启 web/worker/beat
3. 跑数据库迁移（Alembic）
4. 观察日志与健康检查

示例：

```bash
cd /srv/opportunity-insight
git pull
docker compose up -d --build radar-web radar-worker radar-beat
docker compose logs -f --tail=200 radar-web
```

------

## 12. 常见故障 Runbook（你用得上的）

### 12.1 22:00 必推没收到

排查顺序：

1. `notification_log` 是否记录发送？
2. `radar-beat` 是否在跑（容器日志）
3. 钉钉 webhook/secret 是否变更
4. 系统时间是否正确（timestamp 偏差会导致签名失败）

### 12.2 WeRSS 拉不到新文章

- WeRSS 本身可能需要重新扫码授权（cookie 过期），按 WeRSS 授权流程处理。

### 12.3 WeRSS API 401

- 触发 token refresh/login（你程序应自动做），因为 token 默认 3 天会过期。

### 12.4 DeepSeek 429/超时

- worker 自动重试（指数退避），并把失败条目进入日报 failures 区块（不阻塞其他文章）

------

## 13. 上线检查清单（Checklist）

-  Nginx 反代 OK：公网 IP 能打开 `/login`
-  登录 OK：remember_me 生效（关闭浏览器再打开仍登录）
-  WeRSS API 可用：`GET http://localhost:8001/api/mps` 携带 Bearer token 成功
-  Token 自动刷新 OK：过期后不会影响任务（refresh 或重登）
-  5 个时段定时 OK：slot_run 每天 5 条
-  22:00 必推 OK：无机会也会推日报链接
-  备份 OK：每天产生 pg_dump 文件，可恢复

------

如果你确认这份部署运维文档没问题，我继续输出 **文档 9/10：任务编排与核心流程技术文档（Celery 任务、幂等、重试、推送策略、数据流时序图）**。