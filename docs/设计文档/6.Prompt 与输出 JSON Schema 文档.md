# 文档 6/10：Prompt 与输出 JSON Schema 文档（DeepSeek 思考模型）

> 适用范围：
>
> - 单篇文章分析：`opportunity_analyzer`（每篇公众号文章一次）
> - 当日日报生成：`daily_digest`（每天 22:00 生成/更新）
>
> 技术前提：DeepSeek API 兼容 OpenAI Chat Completions（`base_url=https://api.deepseek.com`），并且 **`deepseek-reasoner` 对应思考模式**，必须使用它。([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/))

------

## 1. DeepSeek 调用关键约束（实现必须遵守）

### 1.1 必须使用思考模型

- 固定：`model="deepseek-reasoner"`（思考模式）([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/))

### 1.2 强制 JSON 输出（必须）

DeepSeek 官方给出的 JSON Output 使用要点（必须满足）：

1. 请求参数设置：`response_format={"type":"json_object"}`
2. system 或 user prompt 里必须包含 **`json`** 字样，并给出想要的 JSON 样例
3. 合理设置 `max_tokens`，避免 JSON 截断
4. JSON Output 可能会偶发返回空 content，需要在工程侧重试兜底 ([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/guides/json_mode/))

### 1.3 `reasoning_content` 处理（重要）

`deepseek-reasoner` 输出会包含 `reasoning_content`（思维链）与 `content`（最终答案）。在下一轮对话中，**如果把 `reasoning_content` 放进输入 messages，会直接 400**，因此必须在工程侧剥离，不回传。([DeepSeek API Docs](https://api-docs.deepseek.com/guides/reasoning_model))

### 1.4 参数限制（实现侧注意）

`deepseek-reasoner` 不支持 Function Calling 等特性；并且若设置 `temperature/top_p` 等参数，要么无效要么报错（官方列出不支持参数/特性）。([DeepSeek API Docs](https://api-docs.deepseek.com/guides/reasoning_model))

------

## 2. Prompt 管理规范（版本化与可回溯）

### 2.1 Prompt 版本对象（与 DB `prompt_version` 对齐）

每个 Prompt 版本建议包含：

- `name`：`opportunity_analyzer` / `daily_digest`
- `version`：递增整数
- `is_active`：是否生效
- `threshold`：推送阈值（默认 60，可改）
- `prompt_text`：完整 system prompt 文本（可含示例）
- `response_schema`：本文件中的 JSON Schema（用于校验）

### 2.2 运行时绑定

- 每次分析都要记录：`prompt_version_id`
- 解析 JSON 失败、缺字段、空 content：工程侧做自动重试（见第 5 节）

------

## 3. 输入载荷格式（给模型看的“用户消息”结构）

### 3.1 单篇文章输入（推荐模板）

将 HTML 清洗为纯文本后，拼成一个 user message（不要塞 HTML）：

- `TITLE:` 文章标题
- `MP_NAME:` 公众号名
- `PUBLISHED_AT:` ISO 时间（+08:00）
- `URL:` 原文链接
- `CONTENT_TEXT:` 纯文本正文（建议截断到合理长度，例如 12k~20k 字符；并在末尾提示“已截断”）

> 原文 HTML 只用于你自己的详情页展示，不要直接喂给模型，避免噪声和脚本污染。

### 3.2 日报输入（推荐模板）

把当天全部分析结果抽成“输入包”，每条只给最关键字段：

- 标题、公众号、发布时间、score、top_type、summary_md、opportunities（最多 1~2 条摘要）

这样日报生成更稳定、更短、更可控。

------

## 4. `opportunity_analyzer`（单篇分析）——Prompt 与 JSON Schema

### 4.1 System Prompt（完整模板，可直接入库）

> 注意：必须包含 `json` 字样，并提供 JSON 示例。([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/guides/json_mode/))
> 输出必须是 **纯 JSON**，禁止任何额外文本（包括 markdown 代码块）。

**SYSTEM（opportunity_analyzer）**：

你是一个“投资/套利机会雷达”的分析助手。用户会给你一篇公众号文章的标题与正文（纯文本），你要判断是否存在**可执行的赚钱机会**（例如：可转债打新、可转债上市交易策略、基金套利、其他明确可落地的交易/操作机会）。

你必须严格输出 **json**（只输出一个 JSON object），不得输出任何非 JSON 内容。

分析要求（非常重要）：

1. **可执行**：如果你认为存在机会，必须给出“具体怎么做”的步骤（action_steps），包括：需要的账户/工具、关键时间点、关键参数（如代码/日期/溢价率/申购规则等），以及最小行动方案。
2. **风险与边界**：明确风险点与不适用条件（risk_warnings、constraints）。
3. **评分**：给出 0-100 的 score。评分越高代表越值得立即行动。
   - 0-29：基本无机会/广告/无法落地
   - 30-59：信息有价值但不够明确，建议观察
   - 60-79：有较明确机会，可执行但仍需核验
   - 80-100：机会明确且时效性强，建议立即行动
4. **上网搜索（按用户要求）**：如果你判断存在发财/套利机会（尤其是可转债打新、上市、基金套利等），你必须“尝试上网搜索核验关键细节”。即使你无法真正联网，也必须给出：
   - search_suggestions：具体的搜索关键词（至少 3 条）
   - verification_checklist：需要核验的信息清单（例如：申购日、债券代码、上市日期、基金溢价率、公告链接等）
   - recommended_sources：推荐优先核验的官方/权威来源（如交易所公告、基金公司公告、巨潮资讯等）
5. **引用原文证据**：从文章中提取 1-3 条关键句（短句）作为 evidence（不需要长引用）。

输出字段必须符合下方 JSON 示例结构，字段名必须一致，缺失字段会导致系统重试。

EXAMPLE JSON OUTPUT:
{
"score": 72,
"conclusion_level": "actionable",
"has_opportunity": true,
"summary": "一句话结论：这篇文章提到XX可转债申购窗口，值得按规则参与，但需核验申购日期与代码。",
"opportunity_types": ["convertible_bond_ipo"],
"opportunities": [
{
"type": "convertible_bond_ipo",
"title": "XX转债打新机会",
"why": ["文章指出申购收益/策略要点", "满足常见打新条件（需核验）"],
"action_steps": [
"核验：搜索“XX转债 申购 日期 代码”确认公告与时间",
"准备：确保证券账户可申购，开通可转债权限（如需）",
"申购：在申购日按顶格申购/按资金分配（按公告规则）",
"上市：记录上市日，按风险偏好设置卖出计划"
],
"constraints": ["需要证券账户", "可能中签率低", "市场波动导致上市价格不确定"],
"time_window": {
"start": "2026-01-10T09:30:00+08:00",
"end": "2026-01-10T15:00:00+08:00",
"timezone": "Asia/Shanghai",
"confidence": 0.4
},
"key_numbers": {
"codes": ["转债代码(如文中提到)"],
"expected_profit_range": "不确定/区间",
"other_params": ["顶格申购", "申购上限"]
},
"verification_checklist": [
"是否真的有该转债申购（公告/交易所）",
"申购日期与代码是否一致",
"申购权限/顶格规则/资金要求",
"上市日期与历史类似转债表现"
],
"search_suggestions": [
"XX转债 申购 日期 代码 公告",
"XX转债 上市 日期 发行规模",
"可转债 打新 顶格 规则 券商"
],
"recommended_sources": [
"交易所公告（上交所/深交所）",
"发行人公告/募集说明书",
"券商公告/交易软件提示"
],
"confidence": 0.55
}
],
"risk_warnings": [
"本文仅为信息分析，需自行核验公告与规则",
"可转债上市价格受市场影响，可能低于预期"
],
"no_opportunity_reason": "",
"evidence": [
{"quote": "原文关键句1（短）", "location_hint": "段落/小节/表格"},
{"quote": "原文关键句2（短）", "location_hint": "段落/小节/表格"}
]
}

### 4.2 User Prompt（运行时填充模板）

**USER（opportunity_analyzer）**：

TITLE: {title}
MP_NAME: {mp_name}
PUBLISHED_AT: {published_at_iso}
URL: {url}

CONTENT_TEXT:
{content_text}

（如果正文过长被截断，请你在结论里说明“可能存在缺失信息，需要核验原文”。）

------

### 4.3 `opportunity_analyzer` JSON Schema（Draft 风格，供本地校验）

> 说明：工程侧校验建议“强必填 + 合理容错”。模型偶发会加字段，是否允许 `additionalProperties` 可由你实现时决定。这里给出**严格版**（推荐），失败则触发重试。

```json
{
  "type": "object",
  "additionalProperties": false,
  "required": [
    "score",
    "conclusion_level",
    "has_opportunity",
    "summary",
    "opportunity_types",
    "opportunities",
    "risk_warnings",
    "no_opportunity_reason",
    "evidence"
  ],
  "properties": {
    "score": { "type": "integer", "minimum": 0, "maximum": 100 },
    "conclusion_level": {
      "type": "string",
      "enum": ["none", "watch", "actionable"]
    },
    "has_opportunity": { "type": "boolean" },
    "summary": { "type": "string", "minLength": 1, "maxLength": 600 },
    "opportunity_types": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": [
          "convertible_bond_ipo",
          "convertible_bond_listing",
          "fund_arbitrage",
          "other"
        ]
      },
      "minItems": 0
    },
    "opportunities": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "type",
          "title",
          "why",
          "action_steps",
          "constraints",
          "time_window",
          "key_numbers",
          "verification_checklist",
          "search_suggestions",
          "recommended_sources",
          "confidence"
        ],
        "properties": {
          "type": {
            "type": "string",
            "enum": [
              "convertible_bond_ipo",
              "convertible_bond_listing",
              "fund_arbitrage",
              "other"
            ]
          },
          "title": { "type": "string", "minLength": 1, "maxLength": 200 },
          "why": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
          "action_steps": { "type": "array", "items": { "type": "string" }, "minItems": 2 },
          "constraints": { "type": "array", "items": { "type": "string" }, "minItems": 0 },
          "time_window": {
            "type": "object",
            "additionalProperties": false,
            "required": ["start", "end", "timezone", "confidence"],
            "properties": {
              "start": { "type": "string" },
              "end": { "type": "string" },
              "timezone": { "type": "string" },
              "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
            }
          },
          "key_numbers": {
            "type": "object",
            "additionalProperties": true
          },
          "verification_checklist": { "type": "array", "items": { "type": "string" }, "minItems": 2 },
          "search_suggestions": { "type": "array", "items": { "type": "string" }, "minItems": 3 },
          "recommended_sources": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
          "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
        }
      }
    },
    "risk_warnings": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
    "no_opportunity_reason": { "type": "string" },
    "evidence": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["quote", "location_hint"],
        "properties": {
          "quote": { "type": "string" },
          "location_hint": { "type": "string" }
        }
      },
      "minItems": 0,
      "maxItems": 3
    }
  }
}
```

------

## 5. `daily_digest`（当日日报）——Prompt 与 JSON Schema

### 5.1 System Prompt（完整模板，可直接入库）

> 同样必须包含 `json` 字样，并给 JSON 示例。([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/guides/json_mode/))

**SYSTEM（daily_digest）**：

你是“投资/套利机会雷达”的日报编辑。用户会给你“今天（北京时间）所有已分析文章”的结构化摘要（包含标题、公众号、发布时间、score、机会要点等）。你需要生成一个“浓缩资讯日报”，方便用户 1-2 分钟快速过一遍。

你必须严格输出 **json**（只输出一个 JSON object），不得输出任何非 JSON 内容。

要求：

1. 输出必须包含 digest_md（markdown 格式的浓缩资讯正文，用于网页直接展示）。
2. 明确“今日是否有可行动机会”（has_opportunity）。
3. 若有机会：列出 top_opportunities（按 score 从高到低取前 3）
4. 若无机会：digest_md 顶部必须明确写“今日无投资机会”（但仍要把重要资讯要点列出来，例如风险提示、市场事件、值得关注的未来时间点）。
5. 对每条机会/关注点，必须给出“下一步该做什么”或“需要核验什么”。
6. 不要编造不存在的代码/日期/公告；不确定就写“需核验”，并给出 search_suggestions（关键词）与 recommended_sources（权威来源）。

EXAMPLE JSON OUTPUT:
{
"date": "2026-01-08",
"has_opportunity": false,
"top_opportunities": [],
"digest_md": "## 2026-01-08 日报\n\n**今日无投资机会。**\n\n### 今日浓缩资讯\n- ...\n\n### 明日/未来关注\n- ...",
"watchlist": [
{
"title": "需要关注的主题",
"why": "为什么重要",
"next_actions": ["下一步怎么做"],
"search_suggestions": ["关键词1","关键词2"],
"recommended_sources": ["交易所/基金公司/巨潮等"]
}
],
"stats": {
"articles_analyzed": 10,
"opportunities_found": 0,
"failures": 0
}
}

### 5.2 User Prompt（运行时填充模板）

**USER（daily_digest）**：

DATE: {date_yyyy_mm_dd}
THRESHOLD: {push_score_threshold}

TODAY_ANALYSES (JSON array):
{today_analyses_compact_json}

说明：

- 数组中每项包含：title、mp_name、published_at、score、has_opportunity、top_type、summary、opportunities_brief、analysis_url。

------

### 5.3 `daily_digest` JSON Schema（严格版）

```json
{
  "type": "object",
  "additionalProperties": false,
  "required": ["date", "has_opportunity", "top_opportunities", "digest_md", "watchlist", "stats"],
  "properties": {
    "date": { "type": "string" },
    "has_opportunity": { "type": "boolean" },
    "top_opportunities": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["analysis_url", "title", "score", "type", "next_actions", "verification_checklist"],
        "properties": {
          "analysis_url": { "type": "string" },
          "title": { "type": "string" },
          "score": { "type": "integer", "minimum": 0, "maximum": 100 },
          "type": { "type": "string" },
          "next_actions": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
          "verification_checklist": { "type": "array", "items": { "type": "string" }, "minItems": 1 }
        }
      }
    },
    "digest_md": { "type": "string", "minLength": 1 },
    "watchlist": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["title", "why", "next_actions", "search_suggestions", "recommended_sources"],
        "properties": {
          "title": { "type": "string" },
          "why": { "type": "string" },
          "next_actions": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
          "search_suggestions": { "type": "array", "items": { "type": "string" }, "minItems": 2 },
          "recommended_sources": { "type": "array", "items": { "type": "string" }, "minItems": 1 }
        }
      }
    },
    "stats": {
      "type": "object",
      "additionalProperties": false,
      "required": ["articles_analyzed", "opportunities_found", "failures"],
      "properties": {
        "articles_analyzed": { "type": "integer", "minimum": 0 },
        "opportunities_found": { "type": "integer", "minimum": 0 },
        "failures": { "type": "integer", "minimum": 0 }
      }
    }
  }
}
```

------

## 6. 工程侧“解析/校验/修复”策略（建议直接照做）

### 6.1 请求参数建议（reasoner + JSON Output）

- `model="deepseek-reasoner"`（固定）([DeepSeek API Docs](https://api-docs.deepseek.com/guides/reasoning_model))
- `response_format={"type":"json_object"}`（固定）([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/guides/json_mode/))
- `max_tokens`：要留够（注意：reasoner 的 max_tokens 统计包含 CoT 与最终答案）。([DeepSeek API Docs](https://api-docs.deepseek.com/guides/reasoning_model))
- `stream=false`（先用非流式，减少解析复杂度）

### 6.2 失败重试触发条件

- HTTP 429/5xx
- 返回 `content` 为空（JSON Output 已知概率问题）([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/guides/json_mode/))
- JSON 解析失败 / schema 校验失败

### 6.3 重试动作（最多 3 次）

第 1 次失败 → 原 prompt 不变直接重试
第 2 次失败 → 在 user prompt 末尾追加一句“务必只输出 JSON，不要输出任何其它字符”
第 3 次失败 → 追加“请严格按 EXAMPLE JSON OUTPUT 的字段顺序输出，缺字段用空值补齐”

> 仍失败：标记该篇为失败（进入日报 failures），但不阻塞其他文章。

------

## 7. 你关心的“发财机会就去上网搜索”如何体现（当前版本的落地方式）

因为本期不接真实搜索工具链，所以我们把“去搜索”落实为三件事（都在 JSON 里强制输出）：

1. `search_suggestions`：可直接复制到搜索引擎的关键词（至少 3 条）
2. `recommended_sources`：优先核验的权威来源列表
3. `verification_checklist`：需要核验的关键事实清单（日期/代码/规则/公告）

这能保证你点开详情页就能“按清单操作”，后续你若要 V2 真正自动搜，我们再把这些 query 交给搜索模块执行即可。

------

如果你认可这份 Prompt/Schema 文档，下一份我会输出 **文档 7/10：UI/交互设计说明**（包含页面信息架构、PC/手机布局、日报页“浓缩资讯”模块结构、筛选字段、以及钉钉落地链接的交互流）。