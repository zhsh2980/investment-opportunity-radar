According to a document from **2026-01-08**, WeRSS 在同机/本地访问时推荐用 `http://localhost:8001`，并且所有 `/api/*` 都需要 Bearer Token（只有 `/rss/*`、`/feed/*` 例外不需要）。基于你已经确认的约束（API 模式读库、必须用 DeepSeek 思考模型、详情页需要登录且“记住我”、每天 5 次定时、阈值 60、22:00 必推日报等），下面是**第 1 份文档：需求规格说明书（SRS/PRD）**的完整稿。

------

# 机会雷达（Investment Opportunity Radar）需求规格说明书（SRS/PRD）

## 1. 文档信息

- 文档名称：机会雷达（Investment Opportunity Radar）需求规格说明书
- 版本：v1.0
- 状态：草案（可直接进入设计/实现）
- 目标读者：开发实现 AI/工程师、后续运维人员、产品使用者（你）
- 时区：北京时间（Asia/Shanghai）
- 关键外部系统：
  - WeRSS（公众号抓取与只读查询）
  - DeepSeek API（必须使用思考模型）
  - 钉钉自定义机器人（加签）

------

## 2. 背景与目标

### 2.1 背景

你在腾讯云 Ubuntu 服务器上部署了 WeRSS，用于定时抓取微信公众号文章并写入数据库；WeRSS 提供只读 HTTP API 供外部程序查询文章数据。

### 2.2 目标

构建一个“机会雷达”系统，按固定时间点从 WeRSS 拉取近 3 天文章，逐篇调用 DeepSeek（思考模型）分析是否存在**可执行的赚钱机会**（如：可转债打新、上市价格预测、基金套利等），并：

- 有机会：在钉钉推送一条**只包含链接**的通知（链接可打开机会详情页）
- 无机会：前 4 次不推；每天 22:00 必推日报（无机会则写“今日无投资机会”）
- 提供 Web 界面：可回溯历史分析，且详情页同时展示“分析结论 + 原文”（PC 左右分栏、手机上下布局）
- Prompt 可随时修改迭代，分析结果可追溯到当时的 Prompt 版本

------

## 3. 范围说明

### 3.1 本期（MVP）范围

1. **数据来源**：仅微信公众号文章（通过 WeRSS API 获取）
2. **分析能力**：DeepSeek 思考模型分析，强制输出 JSON，包含评分、机会类型、可执行步骤、风险提示、时效性、核验清单等
3. **调度**：每天 5 次定时任务（07:00/12:00/14:00/18:00/22:00）
4. **推送**：钉钉加签机器人，推送只含链接
5. **界面**：机会列表、机会详情页、当日日报页；详情页需登录且支持“记住我”
6. **去重**：同一篇文章只分析一次（被分析过就标记，不再重复分析）

### 3.2 明确不做（本期不实现）

1. 真正的“联网搜索工具”自动抓取并回填（本期只在 Prompt 中要求模型“自行上网搜索/给出搜索建议”，不保证真实搜到）
2. 多渠道采集（网站/RSS/手动粘贴）**只做扩展接口设计**，不做实际接入
3. 复杂权限体系/多用户体系（本期仅单管理员账号即可）
4. 域名/HTTPS 证书（你明确不需要域名；本期默认公网 IP 访问）

------

## 4. 术语与定义

- **WeRSS**：公众号抓取系统，提供只读 HTTP API（BasePath `/api`）
- **文章**：WeRSS 中的 articles 记录，正文为 HTML 字符串 `content`
- **机会**：模型判断存在可执行盈利/套利空间的结论，需给出具体操作步骤与风险点
- **日报**：当天（自然日）5 次分析的汇总浓缩内容
- **阈值**：机会推送评分阈值，默认 60，可配置
- **已分析标记**：机会雷达系统自己的数据库标记，避免重复分析

------

## 5. 用户画像与使用场景

### 5.1 用户画像

- 单一用户（你）：希望每天 5 次扫描公众号内容，尽量不错过套利/打新机会；但不希望被无意义推送打扰

### 5.2 核心使用场景

1. **日内提醒**：7/12/14/18 任一时点出现机会 → 钉钉收到一条通知 → 点链接直接看结论与原文
2. **日终复盘**：22:00 必收到日报 → 快速浏览当日浓缩资讯（即使无机会，也确认“今天扫描过”）
3. **历史追溯**：随时打开 Web 界面看历史机会与原文，复盘模型判断质量、优化 Prompt

------

## 6. 总体业务规则（必须严格实现）

### 6.1 拉取范围规则

- 每次任务从 WeRSS 拉取**最近 3 天**文章进行增量处理（文章发布时间 publish_time 在近 72 小时内）
- 目的：覆盖“晚上 22 点后发布、第二天早上 7 点才抓到”的情况（你明确的最大跨度）

> 注：WeRSS 的 `publish_time` 为 Unix 时间戳（秒），可在应用层筛选日期范围。

### 6.2 去重规则（已分析不再分析）

- 若文章 `article_id` 在机会雷达系统中已存在“分析成功记录”，则不再重复分析该文章

### 6.3 推送规则（5 次/天）

- 07:00 / 12:00 / 14:00 / 18:00：
  - 若本次新增机会 **score ≥ 阈值（默认 60）** → 推送一条钉钉消息（链接指向“本次最高分机会详情页”或“本次机会列表页”）
  - 若无任何机会达到阈值 → **不推送**
- 22:00（最后一次）：
  - **无论有无机会都必须推送**
  - 有机会：推送“当日日报页链接”
  - 无机会：推送“今日无投资机会 + 当日日报页链接”

### 6.4 展示规则（详情页必须带原文）

- 机会详情页必须同时展示：
  - DeepSeek 分析结论（结构化、可执行）
  - 原文 HTML（WeRSS 提供的 content）
- PC：左右分栏；Mobile：上下布局

------

## 7. 功能需求（Functional Requirements）

> 编号为 FR-x，均为强制需求（MVP 必须满足）。

### FR-1：WeRSS 数据读取（API 模式）

- 系统必须通过 WeRSS HTTP API 获取公众号与文章数据，不得直连 SQLite
- WeRSS 访问方式：
  - 同机优先 `http://localhost:8001`
  - API BasePath `/api`

#### FR-1.1：Token 获取与续期（自动）

- 系统必须自动处理 WeRSS Bearer Token：
  - 登录：`POST /api/auth/token`（form 表单）
  - token 默认有效期 3 天（`expires_in=259200`）
  - 允许刷新：`POST /api/auth/refresh`（使用旧 token）
- 系统不得依赖人工介入刷新 token（长期运行）

#### FR-1.2：文章列表与全文获取

- 系统必须支持两种获取方式（实现可选其一或同时支持）：
  1. 列表接口直接返回全文：`GET /api/articles?...&has_content=true`（返回 `content` 字段）
  2. 列表拿 id，再单篇取全文：`GET /api/articles/{article_id}`（返回完整 HTML `content`）

### FR-2：定时任务调度

- 系统必须每天在北京时间以下 5 个时间点触发分析任务：
  - 07:00、12:00、14:00、18:00、22:00
- 任务触发必须具备幂等性：同一时点重复触发不会导致重复分析或重复推送

### FR-3：文章清洗与输入构造

- 系统必须把每篇文章的：
  - 标题 title
  - 正文 content（HTML）
  - 公众号信息（mp_name / mp_id）
  - 原文链接 url
  - 发布时间 publish_time
    构造成 DeepSeek 请求输入
- 系统必须对 HTML 做基础清洗为纯文本（用于模型理解），但仍需保留原 HTML 用于详情页展示

### FR-4：DeepSeek 分析（必须思考模型）

- 系统必须调用 DeepSeek API（base_url = `https://api.deepseek.com`，你已指定）
- **必须使用思考模型**进行分析（实现上固定为“思考模型”配置，不允许被误改为非思考模型）
- 每篇文章必须得到一个**强制 JSON**的分析结果（见 FR-5）

### FR-5：强制 JSON 输出（结构化）

- 系统必须要求模型输出 JSON（严格可解析）
- JSON 必须包含至少以下字段（字段名可在后续 Prompt 文档中定稿，本 SRS 先定义语义要求）：
  - `score`：0-100 分（整数或一位小数）
  - `has_opportunity`：布尔
  - `opportunity_types`：数组（如 可转债打新/上市预测/基金套利/其他）
  - `summary`：一句话结论
  - `action_steps`：可执行步骤（分点、可落地）
  - `time_window`：机会有效时间/关键日期
  - `risk_warnings`：风险点与止损/风控建议
  - `verification_checklist`：需要你二次核验的清单
  - `search_suggestions`：当发现机会时，要求“上网搜索”的关键词/建议站点（按你要求写入提示词）

### FR-6：评分阈值与推送策略可配置

- 系统必须支持配置项：
  - `push_score_threshold`：默认 60，可随时修改（无需改代码/重启或可热更新）
- 该阈值仅影响**前 4 次**是否推送；22:00 必推不受阈值影响

### FR-7：已分析标记与历史留存

- 系统必须记录每篇文章的分析状态（成功/失败/跳过）
- 已分析成功的文章必须被标记，后续任务不再分析
- 系统必须长期保存：
  - 原文 HTML
  - 清洗文本
  - 分析 JSON
  - 评分
  - 触发批次（哪一次定时任务分析的）
  - 关联的 Prompt 版本

### FR-8：日报生成（22:00 必用）

- 系统必须生成“当日日报页”数据，包括：
  - 当天共分析文章数
  - 发现机会数、最高分机会
  - 当天最重要的“浓缩资讯”（把重要内容分析出来，像压缩一篇资讯快速过一遍）
  - 每篇文章的摘要条目（标题/公众号/评分/是否机会/详情链接）
- 22:00 推送必须指向当日日报页

### FR-9：钉钉机器人推送（加签）

- 系统必须支持钉钉自定义机器人（加签方式）推送
- 推送消息必须使用统一模板，且内容只包含：
  - 简短结论
  - 链接（机会详情页或日报页）
- 不允许在钉钉正文内直接贴长文（原文必须在 Web 界面里看）

### FR-10：Web 界面（带登录 + 记住我）

- 系统必须提供可公网访问的 Web 界面（IP 访问，无域名）
- 必须具备登录功能（账号密码）
- 必须支持“Cookie Session + 记住我”：
  - 记住我开启后，浏览器在有效期内再次打开链接不需要重复登录（直到 cookie 过期或手动退出）
- 页面要求：
  1. **机会详情页**
     - PC 左右分栏：左=结论，右=原文
     - 手机上下：上=结论，下=原文
  2. **当日日报页**
     - 顶部：浓缩资讯（今日重点）
     - 下方：文章/机会列表（可点进详情）
  3. **历史列表页**
     - 按日期、机会类型、评分过滤
     - 可回溯任意一天

### FR-11：Prompt 管理（可编辑可回滚）

- 系统必须提供 Prompt 管理能力：
  - 在线编辑
  - 保存版本
  - 标记“当前生效版本”
- 每次分析必须记录所用 Prompt 版本号

### FR-12：可扩展的数据源适配（只做接口）

- 系统必须预留“内容来源适配器”扩展点（插件/模块接口）
- MVP 只实现 WeRSSAdapter，但架构必须允许未来新增 Website/RSS/其它来源而不重写核心流程

------

## 8. 非功能需求（Non-Functional Requirements）

### NFR-1：稳定性与容错

- DeepSeek 调用失败（超时/限流/异常）必须：
  - 记录失败原因
  - 支持自动重试（次数可配置）
  - 不影响本批次其他文章继续处理
- 钉钉推送失败必须记录并可重试（至少保留失败日志）

### NFR-2：性能

- 当前规模：每天 ≤10 篇文章
- 目标：每次批次在合理时间内完成（以分钟级为目标），并对外可查看进度/结果

### NFR-3：安全

- 所有敏感信息必须通过环境变量/配置文件注入（不写死在代码仓库）：
  - WeRSS 用户名密码（用于自动拿 token）
  - DeepSeek API Key
  - 钉钉 webhook/secret
  - Web 登录账号密码（或初始管理员密码）
- WeRSS 本地访问必须使用 `localhost`（避免不必要的公网绕行）
- Web 登录 Cookie：
  - httpOnly
  - 有过期时间（记住我更长）
  - 无域名情况下仍可在 IP 下生效（注意：若不用 HTTPS，cookie 的 secure 属性可能无法启用）

### NFR-4：可观测性

- 必须有日志：
  - 每批次 run 开始/结束、文章数量、成功/失败、机会数量、是否推送
  - 单篇文章的分析耗时、失败原因
- 必须有可追溯性：
  - 机会详情页能看到：文章元信息、分析时间、Prompt 版本、score、原文链接

------

## 9. 外部接口与依赖（摘要）

### 9.1 WeRSS API（只读）

- 服务地址（本地）：`http://localhost:8001`
- BasePath：`/api`
- Token 登录：`POST /api/auth/token`
- Token 默认有效期：3 天（259200 秒）
- Token 刷新：`POST /api/auth/refresh`
- 文章列表：`GET /api/articles`（支持 `has_content`，返回 `content` HTML）
- 文章详情：`GET /api/articles/{article_id}`
- 公众号列表：`GET /api/mps`（文档示例提及）

> 认证规则：/api 需要 token；/rss、/feed 不需要。

### 9.2 DeepSeek API

- Base URL：`https://api.deepseek.com`
- 必须使用“思考模型”（实现时固定配置）
- 输出必须为严格 JSON

### 9.3 钉钉机器人

- 自定义机器人 + 加签（timestamp + sign）
- 消息体使用 Markdown，包含链接

------

## 10. 验收标准（Acceptance Criteria）

### AC-1 定时任务

- 在北京时间 07:00/12:00/14:00/18:00/22:00 准时触发（允许分钟级偏差可配置）
- 每次任务只处理近 72 小时范围内新增且未分析的文章

### AC-2 去重

- 同一篇文章不会被重复分析（除非手工清理记录/未来另设重跑机制）

### AC-3 推送规则正确

- 前 4 次：仅当存在 score ≥ 60 的机会才推送
- 22:00：必推；无机会时推送包含“今日无投资机会”

### AC-4 详情页体验

- 链接打开后若未登录：要求登录
- 登录勾选“记住我”后，在有效期内再次打开链接无需重复登录
- 详情页必须同时看到分析结论与原文（PC 左右、手机上下）

### AC-5 JSON 结构化可解析

- 每篇文章分析结果均可被系统解析并入库
- 列表页能按 score、机会类型过滤

### AC-6 历史可追溯

- 至少可按天查看日报
- 至少可查看历史机会详情，并看到其对应原文与 Prompt 版本

------

## 11. 风险与约束（明确记录）

1. 仅通过 Prompt 要求模型“上网搜索”，并不保证模型真的联网获得最新信息（本期接受该限制）
2. 无域名、公网 IP 访问且可能为 HTTP，会降低传输安全性；通过强密码登录 + 记住我 cookie 缓解（后续可升级 HTTPS/域名）
3. WeRSS token 默认 3 天过期，需要自动续期/刷新机制，否则服务会在第 4 天开始失败。

------

如果你认可这份 SRS 的结构和细节，我下一份就按你选的“10 份文档方案”继续输出 **第 2 份：概要设计文档（HLD）**（会把模块、流程、扩展点、部署形态、关键页面与数据流画清楚）。