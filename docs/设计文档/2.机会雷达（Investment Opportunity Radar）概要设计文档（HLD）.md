According to a document from **2026-01-08**, WeRSS 在同机调用时建议用 `http://localhost:8001`，API 基础路径为 `/api`，并且 **API 需要 Bearer Token**（RSS/Feed 订阅接口例外）。下面是**第 2 份文档：概要设计文档（HLD）**完整稿（已纳入你最新决定：**只走 WeRSS API**、详情页登录且 **Cookie Session + 记住我**、DeepSeek 必须思考模型、5 次定时+22:00 必推日报、阈值默认 60 可改）。

------

# 机会雷达（Investment Opportunity Radar）概要设计文档（HLD）

## 1. 文档信息

- 文档名称：机会雷达概要设计（High Level Design）
- 版本：v1.0
- 时区：北京时间（Asia/Shanghai）
- 部署环境：腾讯云 Ubuntu（公网 IP 访问，无域名）
- 外部依赖：
  - WeRSS（只读 API 获取公众号/文章，Bearer Token）
  - DeepSeek API（base_url=[https://api.deepseek.com；必须思考模型）](https://api.deepseek.xn--com;)-cf3il50ceuae53et63cwi2c/)
  - 钉钉自定义机器人（加签）
- 数据窗口：最近 72 小时（近 3 天，按 publish_time 筛选）

------

## 2. 设计目标与原则

### 2.1 目标

1. **准时**：每天固定 5 次（07:00/12:00/14:00/18:00/22:00）扫描并分析
2. **不打扰**：前 4 次只有命中机会（score≥阈值）才推送；22:00 必推日报
3. **可追溯**：保存“分析结论 + 原文”，可回看历史机会
4. **可迭代**：Prompt 可在线修改并版本化；阈值可配置
5. **可扩展**：未来接入其它渠道（网站/RSS/其它）不重写核心链路

### 2.2 原则

- **幂等优先**：同一文章只分析一次；同一时间点重复触发不重复推送
- **接口解耦**：数据源（WeRSS）/分析（DeepSeek）/通知（钉钉）均用 Adapter 抽象
- **最小权限**：Web 端仅提供查看与配置；抓取与分析由 Worker 完成
- **面向故障**：网络失败可重试；失败可在后台查看并手动重跑（后续 LLD 细化）

------

## 3. 系统上下文（Context Diagram）

```
┌────────────────────┐         ┌──────────────────────┐
│      DingTalk       │<--------│  Radar Notifier      │
│  (custom robot)     │  push   │  (sign + template)   │
└────────────────────┘         └───────────┬──────────┘
                                            │
                                            │ links (opportunity / daily)
                                            ▼
                                   ┌──────────────────────┐
                                   │   Radar Web (UI)     │
                                   │  login + report page │
                                   └───────────┬──────────┘
                                               │ read/write
                                               ▼
┌────────────────────┐          ┌──────────────────────┐
│       WeRSS         │--------->│  Radar Worker        │
│  /api (token)       │  fetch   │  analyze + persist   │
└────────────────────┘          └───────────┬──────────┘
                                            │ call
                                            ▼
                                   ┌──────────────────────┐
                                   │   DeepSeek API       │
                                   │  (reasoning model)   │
                                   └──────────────────────┘
```

**WeRSS 接口约束**：WeRSS API 基础路径 `/api`，建议同机用 `http://localhost:8001`；API 为只读查询且需要 Bearer Token。

------

## 4. 总体架构（Component Diagram）

建议用 docker-compose 部署以下组件（可单机）：

1. **radar-web**（Web/UI + 内部 API）

- 页面：登录页、机会详情页、当日日报页、历史列表页、Prompt 管理页、系统配置页（阈值等）
- 鉴权：Cookie Session + 记住我

1. **radar-worker**（异步任务 Worker）

- 拉取 WeRSS 文章（近 72 小时）
- 逐篇调用 DeepSeek（必须思考模型）
- 写入数据库（原文+结果+索引字段）
- 根据规则触发钉钉推送

1. **radar-scheduler**（定时触发器）

- 北京时间 5 个时间点触发 run
- 产生 “批次 run” 记录（run_id）

1. **redis**

- 任务队列 / 任务状态（可选：也可做 session store，但推荐）

1. **postgres**（推荐）

- 保存分析结果、日报汇总、配置、Prompt 版本、用户账号等

1. **nginx**

- 对外暴露 80 端口（公网 IP 访问）
- 反向代理到 radar-web
  -（可选）基础限流/访问日志

> 你已经明确“要带界面”，因此 Web 服务是必要组件；Worker/Scheduler 用队列拆开，减少互相影响、利于重试与扩展。

------

## 5. 关键数据流（Data Flow）

### 5.1 单次定时批次 run（07/12/14/18/22）

**输入**：WeRSS 近 72 小时文章列表（按 publish_time）
**输出**：机会列表/日报内容 +（可能）钉钉推送

流程：

1. Scheduler 生成 `run_id`（例如 `2026-01-08T07:00+0800`）并触发 `RunJob(run_id)`
2. Worker 调用 WeRSS：
   - 登录获取 token：`POST /api/auth/token`，token `expires_in=259200`（3 天）
   - 拉文章列表：`GET /api/articles`（可带 `has_content=true` 直接拿全文 HTML）
   - 在应用层按 publish_time 过滤近 72 小时（WeRSS 文档也建议应用层筛选）
3. 去重：若该文章 `article_id` 已存在“分析成功记录”，跳过
4. 逐篇分析：
   - 构造输入：标题 + 清洗后的正文（保留原 HTML 另存）
   - 调用 DeepSeek 思考模型 → 强制 JSON 输出
5. 结果落库：
   - 保存：原文 HTML、纯文本、模型 JSON、score、是否机会、机会类型、关键时间点、Prompt 版本、run_id
6. 推送判断：
   - run ∈ {07,12,14,18}：若存在 `score ≥ threshold(默认60)` 的新增机会 → 推送“最高分机会详情页链接”
   - run = 22：必推“当日日报页链接”（无机会则文案“今日无投资机会”）

### 5.2 当日日报生成（22:00 必用）

日报内容由系统汇总当天 5 次 run 的分析产出：

- 今日总分析篇数、机会数、最高分
- “浓缩资讯”（把当天重要内容压缩成一篇快速浏览的摘要）
- 列表：文章标题/公众号/评分/是否机会/详情链接

------

## 6. 核心模块划分（Responsibilities）

### 6.1 WeRSSClient（数据源适配器：WeRSS）

职责：

- 维护 Bearer Token（自动登录/续期/刷新）
- 查询公众号列表 / 文章列表 / 文章详情
- 支持在同机走 localhost（最佳实践）

关键约束（来自你上传的 WeRSS 文档）：

- API 基础信息：本地访问 `http://localhost:8001`，BasePath `/api`
- `/api/*` 需要 token；RSS/Feed `/rss/*`、`/feed/*` 不需要 token
- 获取 token：`POST /api/auth/token`，默认 3 天过期（259200 秒）
- 获取全文：`GET /api/articles?...&has_content=true` 或 `GET /api/articles/{article_id}`

> 设计决定：本项目**仅用 API 模式**访问 WeRSS（不直连 SQLite），符合你最新要求。

### 6.2 Analyzer（分析器：DeepSeek）

职责：

- 统一封装 DeepSeek 调用（固定思考模型）
- 强制 JSON 输出与校验（不可解析则重试/降级）
- 将“发现机会就上网搜索”的要求体现在 Prompt 与输出字段（search_suggestions / verification_checklist）

> 说明：本期只在 Prompt 中要求“自行上网搜索/给出搜索建议”，不实现真实搜索工具链（后续可升级）。

### 6.3 Opportunity Engine（机会判定与聚合）

职责：

- score ≥ 阈值 ⇒ 机会（阈值默认 60，可配置）
- 机会类型标准化（可转债打新/上市预测/基金套利/其它）
- 选择“本次最高分机会”作为前 4 次推送的落点

### 6.4 Report Builder（日报构建器）

职责：

- 按自然日汇总当天所有 runs 的结果
- 生成“浓缩资讯”与结构化摘要
- 输出日报页可直接渲染的数据结构（供 Web）

### 6.5 Notifier（通知适配器：钉钉）

职责：

- 生成消息模板（只含链接）
- 机器人加签（timestamp+sign）
- 推送策略执行（前 4 次命中才推；22:00 必推）

### 6.6 Web UI（带登录 + 记住我）

职责：

- 登录页（账号密码）
- Session Cookie（服务端 session store），支持“记住我”延长有效期
- 页面：
  - 机会详情页：PC 左右分栏；移动端上下布局
  - 当日日报页：顶部浓缩资讯 + 下方列表
  - 历史列表页：按日期/类型/评分过滤
  - 配置页：阈值、推送策略参数（可扩展）
  - Prompt 管理页：编辑、发布、回滚

------

## 7. 关键页面与 URL 规划（High-level）

对外（钉钉链接打开）：

- `GET /login`
- `GET /opps/{opportunity_id}`：机会详情页（需要登录）
- `GET /daily/{YYYY-MM-DD}`：当日日报页（需要登录）

对内（Web 调用 API，后续详细设计会给完整接口表）：

- `GET /api/opps?date=&min_score=&type=`
- `GET /api/opps/{id}`
- `GET /api/daily/{date}`
- `GET/PUT /api/settings`（threshold 等）
- `GET/POST /api/prompts`（版本管理）

------

## 8. 数据存储与一致性（High-level）

### 8.1 数据分类

1. **文章快照（Article Snapshot）**：来自 WeRSS 的文章元数据与原文 HTML（用于展示与追溯）
2. **分析结果（Analysis Result）**：DeepSeek JSON、score、机会类型、关键时间窗、风险、核验清单
3. **机会（Opportunity）**：从分析结果中抽取出的“可推送/可列表化”的结构化记录
4. **日报（Daily Report）**：每日汇总内容
5. **配置与 Prompt**：阈值、时间点、Prompt 版本等
6. **推送记录（Push Log）**：何时推送、推送内容摘要、链接目标、是否成功

### 8.2 幂等与唯一性（设计要点）

- `analysis` 唯一键建议：`(source, article_id, prompt_version)`
  - 默认逻辑：同 article_id + 当前 prompt_version 只分析一次
  - 后续若你希望“prompt 改了重跑”，也能通过新 prompt_version 触发
- `push_log` 唯一键建议：`(date, run_slot, push_type)`，防止重复推送

------

## 9. 鉴权与安全（High-level）

### 9.1 Web 登录（你已选择方案 A）

- 方式：账号密码登录 + Cookie Session
- “记住我”：勾选后 session TTL 更长（例如 30 天），否则短 TTL（例如 12 小时）
- Session 存储：推荐 Redis（便于失效控制、支持多进程）

### 9.2 WeRSS 凭证与 Token

- WeRSS API 即使同机也必须提供 token
- 同机访问最佳实践：base_url 使用 localhost，且可将 token 缓存到文件/redis（减少重复登录）

------

## 10. 部署拓扑（High-level）

```
Internet
  |
  |  http://<公网IP>/
  v
[Nginx:80]
  |
  +--> [radar-web:8000] --- (read/write) ---> [Postgres]
                    |
                    +--- (session) ---> [Redis]
  |
  +--> (internal only)
        [radar-scheduler] ---> [Redis Queue] ---> [radar-worker]
                                                 |
                                                 +--> WeRSS (http://localhost:8001/api/*)
                                                 +--> DeepSeek (https://api.deepseek.com)
                                                 +--> DingTalk robot webhook
```

WeRSS 的 API 基础信息与本地访问建议：`http://localhost:8001`，`/api`

------

## 11. 可观测性（High-level）

- 统一日志字段（建议）：
  - `run_id`、`run_slot`（07/12/14/18/22）、`article_id`、`mp_id`、`status`、`elapsed_ms`
- 最少应有的后台可视化：
  - 当天批次执行情况（成功/失败/跳过）
  - 最近失败原因（WeRSS 401/DeepSeek 超时/钉钉失败等）
- WeRSS token 过期会导致 401（文档示例也提到 401 表现），因此 worker 必须有“自动续期/刷新”机制。

------

## 12. 扩展点（High-level）

### 12.1 内容来源扩展（Source Adapter）

接口形态（概念）：

- `list_articles(since_ts, until_ts) -> [ArticleMeta]`
- `get_article(article_id) -> ArticleDetail`

MVP 实现：`WeRSSAdapter`（调用 WeRSS API）
未来可加：`WebsiteAdapter` / `RSSAdapter` / `ManualAdapter`

### 12.2 通知渠道扩展（Notifier Adapter）

- `send(message: NotificationMessage) -> SendResult`
  MVP：DingTalkRobotNotifier
  未来：企业微信/飞书/邮件

------

## 13. 关键设计决策汇总

1. **只读 API 拉取 WeRSS 数据**（不直连 SQLite），并同机使用 localhost
2. **/api 必须 Bearer Token**，token 默认 3 天（259200 秒），需要自动维护
3. **全文获取用 has_content=true 或 article detail**
4. **Web 登录采用 Cookie Session + 记住我**（降低反复输入密码）
5. **22:00 必推日报**，前 4 次命中阈值（默认 60）才推机会链接
6. **DeepSeek 必须思考模型**、输出必须为严格 JSON（具体 schema 在第 6 份 Prompt/JSON 文档定稿）

------

如果你觉得这份 HLD OK，我下一份会输出 **第 3 份：详细设计文档（LLD）**：会把每个模块的类/函数边界、数据库表（字段级）、内部 API 路由、任务队列结构、幂等键、重试策略、以及“22:00 日报生成”的具体算法与数据结构全部写死。