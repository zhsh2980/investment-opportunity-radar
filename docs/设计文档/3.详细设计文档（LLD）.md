# 文档 3/10：详细设计文档（LLD）

> 项目：机会分析（WeRSS + DeepSeek + 钉钉推送 + Web 界面）
> 时区：北京时间（Asia/Shanghai）
> 设计前提：**不直连 SQLite**，统一用 WeRSS 的 HTTP API 拉取文章（API 基础路径 `/api`，Bearer Token 认证）。

------

## 1. 目标与约束（落到实现层）

### 1.1 核心目标

- 每天 5 次定时执行（07:00 / 12:00 / 14:00 / 18:00 / 22:00），拉取最近三天公众号文章，逐篇调用 DeepSeek（**思考模型**）分析“赚钱机会/可转债打新/基金套利”等。
- 每篇文章只分析一次（分析后标记）。
- **推送策略**：
  - 前 4 次：仅当存在“机会评分 ≥ 阈值(默认 60，可配置)”才推送钉钉。
  - 22:00：无论有没有机会，都要推送当日“日报页”链接；若无机会，明确写“今日无投资机会”。

### 1.2 关键约束（与外部系统对齐）

- WeRSS：本机访问建议 `http://localhost:8001`，API 基础路径 `/api`。
- WeRSS：**即使同服务器访问，API 也需要 TOKEN**（RSS/Feed 路径不需要）。
- WeRSS 文章列表接口：支持 `has_content` 控制是否返回完整内容（默认 false）。
- WeRSS：`publish_time` 是 Unix 时间戳（秒），默认按 `publish_time` 降序，需要在应用层做日期范围筛选。
- DeepSeek：使用 OpenAI 兼容接口 `POST https://api.deepseek.com/chat/completions`。 ([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/?utm_source=chatgpt.com))
  - 必须使用思考模型：`model = deepseek-reasoner`。([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/guides/thinking_mode?utm_source=chatgpt.com))
  - 强制 JSON：`response_format = {"type":"json_object"}`，且 prompt 中需包含 “json” 并给示例；并注意可能出现空 content，要做重试兜底。([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/guides/json_mode/?utm_source=chatgpt.com))
- 钉钉自定义机器人：
  - 发送接口：`POST https://oapi.dingtalk.com/robot/send`，支持 `markdown`，并支持 `msgUuid` 幂等键。([open.dingtalk.com](https://open.dingtalk.com/document/development/custom-robots-send-group-messages?utm_source=chatgpt.com))
  - 加签：`timestamp + "\n" + secret` 做 HmacSHA256 → Base64 → urlEncode；timestamp 毫秒，误差不超 1 小时。([open.dingtalk.com](https://open.dingtalk.com/document/robots/customize-robot-security-settings?utm_source=chatgpt.com))
  - 频率限制：每机器人每分钟最多 20 条。([open.dingtalk.com](https://open.dingtalk.com/document/development/custom-robots-send-group-messages?utm_source=chatgpt.com))

------

## 2. 代码仓库结构（可直接照此建目录）

```
opportunity-insight/
  app/
    main.py
    config.py
    logging.py

    clients/
      werss_client.py
      deepseek_client.py
      dingtalk_client.py

    core/
      security.py
      session.py
      html_extract.py
      json_schema.py
      time_utils.py

    domain/
      models.py               # SQLAlchemy ORM
      schemas.py              # Pydantic schemas (API)
      enums.py

    services/
      ingest_service.py       # 拉取/入库/去重
      analyze_service.py      # 调用 deepseek + 解析 + 打分
      report_service.py       # 当天日报生成
      notify_service.py       # 钉钉推送聚合与幂等
      prompt_service.py       # 提示词版本管理
      plugin_sources.py       # 未来扩展：其他来源

    tasks/
      celery_app.py
      schedules.py            # beat 定时配置（北京时间）
      jobs.py                 # 任务编排（slot run）
      workers.py              # 具体任务（analyze_one 等）

    web/
      routers/
        auth.py
        dashboard.py
        items.py
        reports.py
        prompts.py
      templates/
        base.html
        login.html
        dashboard.html
        item_detail.html
        report_daily.html
        prompts.html
      static/
        app.css
        app.js

  alembic/                    # 数据库迁移
  docker-compose.yml
  Dockerfile
  .env.example
  README.md
```

------

## 3. 数据库设计（本系统自己的库，不是 WeRSS 的 SQLite）

> 目的：保存“已分析标记/机会结论/日报/推送日志/提示词版本”，形成历史可追溯列表页。

### 3.1 表：`content_item`（内容条目，来自 WeRSS 等来源）

| 字段            | 类型           | 说明                                      |
| --------------- | -------------- | ----------------------------------------- |
| id              | bigserial PK   | 内部ID                                    |
| source_type     | varchar        | `werss` / `web` / `other`                 |
| source_id       | varchar        | 来源实例ID（预留，多来源时区分）          |
| external_id     | varchar unique | WeRSS article_id（如 `MP_WXS_xxx-...`）   |
| title           | text           | 标题                                      |
| url             | text           | 原文链接                                  |
| mp_id           | varchar        | 公众号ID（WeRSS feeds.id）                |
| mp_name         | text           | 公众号名                                  |
| published_at    | timestamptz    | 发布时间（由 `publish_time` 转）          |
| fetched_at      | timestamptz    | 拉取时间                                  |
| raw_html        | text           | 原文HTML（WeRSS content）                 |
| raw_text        | text           | 从HTML提取的纯文本（给模型用）            |
| content_hash    | char(64)       | sha256(raw_html)                          |
| analyzed_status | smallint       | 0=未分析，1=已分析，2=跳过(无内容/已删除) |
| analyzed_at     | timestamptz    | 已分析时间                                |
| meta            | jsonb          | 其他元信息（封面、摘要等）                |

**去重/跳过规则：**

- `external_id` 唯一：保证同一篇文章不会重复入库。
- 若 WeRSS `status=1000(已删除)` 或 content 为空：`analyzed_status=2`（跳过）。WeRSS articles 表定义：`status(1=正常,1000=已删除)`，content 为 HTML。

### 3.2 表：`analysis_result`

| 字段              | 类型         | 说明                                                         |
| ----------------- | ------------ | ------------------------------------------------------------ |
| id                | bigserial PK |                                                              |
| content_item_id   | bigint FK    | 关联 content_item                                            |
| prompt_version_id | bigint FK    | 关联提示词版本                                               |
| model             | varchar      | 固定 `deepseek-reasoner` ([DeepSeek API Docs](https://api-docs.deepseek.com/guides/reasoning_model?utm_source=chatgpt.com)) |
| score             | int          | 0-100                                                        |
| has_opportunity   | boolean      | 是否发现机会（通常 `score>=threshold`）                      |
| opportunities     | jsonb        | 机会结构化列表（见 5.2 JSON schema）                         |
| summary_md        | text         | 适合展示的结论（markdown）                                   |
| reasoning_meta    | jsonb        | 可选：模型返回的额外字段（不展示 CoT，留存 debug）           |
| created_at        | timestamptz  |                                                              |

约束：

- `unique(content_item_id)`：默认“一篇文章只保留一次分析”（满足你“分析过就标记不再分析”）。
- 如果未来你想“提示词升级后重跑”，再加 `unique(content_item_id, prompt_version_id)`，并在 UI 加“重新分析”按钮（暂不启用）。

### 3.3 表：`daily_report`

| 字段                | 类型         | 说明                                  |
| ------------------- | ------------ | ------------------------------------- |
| id                  | bigserial PK |                                       |
| report_date         | date unique  | 北京时间日期                          |
| slots_done          | jsonb        | 哪些时段已跑完（用于UI展示 5 次进度） |
| digest_md           | text         | 当日资讯浓缩（22:00 生成）            |
| opportunities_index | jsonb        | 当日机会索引（便于快速列表）          |
| created_at          | timestamptz  |                                       |
| updated_at          | timestamptz  |                                       |

### 3.4 表：`notification_log`

| 字段             | 类型           | 说明                                                         |
| ---------------- | -------------- | ------------------------------------------------------------ |
| id               | bigserial PK   |                                                              |
| report_date      | date           |                                                              |
| slot             | varchar        | `07:00/12:00/14:00/18:00/22:00`                              |
| channel          | varchar        | `dingtalk`                                                   |
| msg_uuid         | varchar unique | 钉钉 `msgUuid`（用于幂等重试）([open.dingtalk.com](https://open.dingtalk.com/document/development/custom-robots-send-group-messages?utm_source=chatgpt.com)) |
| request_payload  | jsonb          | 发出去的 body                                                |
| response_payload | jsonb          | 钉钉返回                                                     |
| status           | smallint       | 0=失败 1=成功                                                |
| created_at       | timestamptz    |                                                              |

### 3.5 表：`prompt_version`

| 字段            | 类型         | 说明                                    |
| --------------- | ------------ | --------------------------------------- |
| id              | bigserial PK |                                         |
| name            | varchar      | `opportunity_analyzer` / `daily_digest` |
| version         | int          | 递增版本                                |
| is_active       | boolean      | 仅 1 条 active                          |
| threshold       | int          | 默认 60（可在 UI 改）                   |
| prompt_text     | text         | 完整提示词（含 json 示例）              |
| response_schema | jsonb        | 期望 JSON schema（用于校验）            |
| created_at      | timestamptz  |                                         |

------

## 4. 外部接口客户端（实现细节）

## 4.1 WeRSSClient（只读拉取）

### 4.1.1 认证（Token 缓存 + 自动刷新）

- 登录：`POST /api/auth/token`（form 表单 `username/password`），返回 `expires_in=259200`（秒）。
- 刷新：`POST /api/auth/refresh`（Bearer token）。
- 本系统实现：把 `token` 与 `expires_at` 缓存到 Redis（或本系统 DB 的 `kv_settings`），并在过期前 5 分钟刷新；如果刷新失败则重新登录。
- 同机访问也需要 token（不要因为 localhost 而跳过）。

> 你上传的总结也给了“存储 token 文件/用环境变量存敏感信息”的做法，可作为实现参考（但我们用 Redis/DB 更稳）。

### 4.1.2 拉取公众号列表

- `GET /api/mps?limit=100`（Bearer token）。（示例代码里这样用）

### 4.1.3 拉取文章列表（轻量）

- `GET /api/articles?...&has_content=false`：仅取元数据用于去重、筛选。
- 过滤策略（应用层）：
  - `publish_time` 是 Unix 秒级时间戳，按最近三天筛选；列表默认 publish_time 降序。

### 4.1.4 拉取单篇详情（重）

- `GET /api/articles/{article_id}`：拿到 `content`（完整 HTML）。

### 4.1.5 HTML → 纯文本

- `core/html_extract.py`：用 BeautifulSoup 去掉 script/style，保留段落/标题/表格文本，合并空白；同时保留原 HTML 给右侧原文展示。

------

## 4.2 DeepSeekClient（思考模型 + JSON 强制）

### 4.2.1 调用方式

- Base URL：`https://api.deepseek.com`
- Endpoint：`POST /chat/completions`（OpenAI 兼容）。([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/?utm_source=chatgpt.com))

### 4.2.2 必须使用思考模型

- `model = "deepseek-reasoner"`（Reasoning Model）。([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/guides/thinking_mode?utm_source=chatgpt.com))

### 4.2.3 强制 JSON 输出

- 使用 JSON Output：`response_format = {"type":"json_object"}`。([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/guides/json_mode/?utm_source=chatgpt.com))
- 约束：prompt 中必须包含 “json” 字样并给输出示例；并要设置足够的 max_tokens 防止 JSON 截断；且可能返回空 content，需要重试兜底。([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/guides/json_mode/?utm_source=chatgpt.com))

### 4.2.4 重试策略（推荐）

- 触发重试条件：
  1. HTTP 429/5xx
  2. content 为空（JSON Output 已知概率问题）([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/guides/json_mode/?utm_source=chatgpt.com))
  3. JSON parse 失败 / schema 校验失败
- 重试：指数退避 `1s,2s,4s`，最多 3 次；仍失败则标记该篇分析失败（不推送，但进日报“失败列表”）。

------

## 4.3 DingTalkClient（加签机器人 + 幂等）

### 4.3.1 发送接口

- `POST https://oapi.dingtalk.com/robot/send?access_token=xxx&timestamp=xxx&sign=xxx`。 ([open.dingtalk.com](https://open.dingtalk.com/document/development/custom-robots-send-group-messages?utm_source=chatgpt.com))
- payload 支持 `markdown`，并支持 `msgUuid` 幂等键（重试不重复发）。([open.dingtalk.com](https://open.dingtalk.com/document/development/custom-robots-send-group-messages?utm_source=chatgpt.com))

### 4.3.2 加签算法

- `stringToSign = timestamp + "\n" + secret`
- `sign = urlEncode(base64(hmac_sha256(secret, stringToSign)))`
- timestamp 单位毫秒，误差不超过 1 小时。([open.dingtalk.com](https://open.dingtalk.com/document/robots/customize-robot-security-settings?utm_source=chatgpt.com))

### 4.3.3 发送频率控制

- 每机器人每分钟最多 20 条，超了会限流。([open.dingtalk.com](https://open.dingtalk.com/document/development/custom-robots-send-group-messages?utm_source=chatgpt.com))
- 本系统做法：**每个时段最多发送 1 条聚合消息**（机会列表/日报链接），不会触发频率限制。

------

## 5. 任务系统设计（Celery Beat + Worker）

## 5.1 定时编排

- Beat 时区：Asia/Shanghai（北京时间）
- crontab：
  - 07:00、12:00、14:00、18:00、22:00 各触发一次 `run_slot(slot)`

## 5.2 任务流（slot 运行）

`run_slot(slot)`（编排任务）：

1. 计算 `window_start = now - 3 days`（用于补抓“昨晚 22 点后文章”）。
2. `ingest_service.fetch_new_items(window_start)`：
   - 拉 `mps` 列表（limit=100）。
   - 对每个 mp 拉 `articles?has_content=false`，按 publish_time 过滤近三天。
   - 对未入库 external_id 的文章，逐个拉详情 `/api/articles/{id}` 存入 `content_item`。
3. 找出待分析：`content_item.analyzed_status=0` 且 raw_html 非空
4. 对每篇入队：`analyze_one(content_item_id)`
5. 等所有 analyze 完成后，汇总本 slot 结果：
   - `slot_opportunities = analysis_result where created_at in this slot and score>=threshold`
6. 推送判定：
   - slot != 22:00：若 `slot_opportunities` 为空 → 不推送；否则推送机会聚合消息。
   - slot == 22:00：生成/更新 `daily_report`，**无论是否有机会都推送日报链接**。

## 5.3 单篇分析任务：`analyze_one(content_item_id)`

1. 从 DB 读 `content_item`（title, raw_text, url, mp_name, published_at）
2. 加载 active 的 `prompt_version(name="opportunity_analyzer")`
3. 调 DeepSeek：
   - model = deepseek-reasoner（思考模型）([DeepSeek API Docs](https://api-docs.deepseek.com/guides/reasoning_model?utm_source=chatgpt.com))
   - response_format={"type":"json_object"}（强制 JSON）([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/guides/json_mode/?utm_source=chatgpt.com))
   - messages：system + user（包含标题 + 摘要文本 + 原文链接）
4. JSON schema 校验（本地）：
   - 必备字段：score、opportunities[]、summary_md、need_search_queries[]
5. 写入 `analysis_result` + 更新 `content_item.analyzed_status=1`
6. 如果失败：记录错误（status=failed），并保持 `analyzed_status=0` 或置为 `2`（看错误类型：解析失败可重试，内容缺失则跳过）

------

## 6. 机会分析 JSON 规范（强制输出）

> 下面是“opportunity_analyzer”提示词要求模型返回的 JSON 结构（本系统也会据此校验）。

```json
{
  "score": 0,
  "conclusion_level": "none | watch | actionable",
  "opportunities": [
    {
      "type": "convertible_bond_ipo | convertible_bond_listing | fund_arbitrage | other",
      "title": "机会标题",
      "why": "为什么可能赚钱（要点）",
      "how_to": [
        "可执行步骤1",
        "步骤2（包含具体券商/基金/规则/时间点）"
      ],
      "constraints": [
        "门槛/资金/账户要求/风险提示"
      ],
      "time_window": "YYYY-MM-DD HH:mm ~ YYYY-MM-DD HH:mm (Asia/Shanghai) or 'unknown'",
      "numbers": {
        "expected_profit": "区间或不确定",
        "key_params": ["转债代码/基金代码/溢价率等（如文章提到）"]
      },
      "need_search_queries": [
        "建议上网搜索的关键词1",
        "关键词2"
      ],
      "confidence": 0.0
    }
  ],
  "summary_md": "给人看的 markdown 总结（适合网页展示）",
  "no_opportunity_reason": "如果 score 很低，说明为何不值得做",
  "source_evidence": [
    {
      "quote": "从原文摘一句关键句（可短）",
      "location_hint": "段落/小节/表格"
    }
  ]
}
```

规则：

- `score>=threshold(默认60)` 才认为 “has_opportunity=true”，进入推送候选。
- 前 4 次只推送候选；22:00 永远推送日报页链接。

------

## 7. 日报生成（22:00 必做）

### 7.1 生成逻辑

`generate_daily_report(report_date)`：

1. 读取当天所有 `analysis_result`（包括低分/无机会/失败）
2. 形成一个“当日资讯输入包”（每篇：标题、评分、机会要点、作者/公众号、链接）
3. 调 DeepSeek 生成 digest（可用独立 prompt_version：`daily_digest`）：
   - 仍用 deepseek-reasoner + JSON Output（便于结构化展示）。([DeepSeek API Docs](https://api-docs.deepseek.com/guides/reasoning_model?utm_source=chatgpt.com))
4. 保存到 `daily_report.digest_md` + `opportunities_index`

### 7.2 日报页展示内容（网页）

- 今日结论：是否有机会（有则列机会卡片；无则醒目提示“今日无投资机会”）
- “浓缩资讯”：5~10 条 bullet，把重要信息压缩展示
- “全量分析列表”：按时间倒序，支持展开查看每篇文章详情（左分析右原文）

------

## 8. Web 界面（带登录 + 适配 PC/手机）

## 8.1 登录（你选的方案 a：cookie session + remember me）

- 路由：
  - `GET /login`：表单（username/password + remember_me）
  - `POST /login`：校验成功后写 session cookie
  - `POST /logout`：清 cookie
- remember_me：
  - 勾选：cookie `Max-Age=30d`
  - 不勾选：会话 cookie（关闭浏览器失效）
- 安全：
  - 密码 bcrypt
  - 简易防爆破：同 IP 失败 10 次锁 10 分钟（内存/Redis）

## 8.2 页面与路由

- `GET /`（Dashboard）
  - 今日机会卡片（按 score desc）
  - 今日 5 次任务进度（哪些时段已跑）
  - 最近 7 天日报入口
- `GET /r/{YYYY-MM-DD}`（当日日报页）
  - digest_md（上）
  - 全量列表（下）
- `GET /i/{content_item_id}`（机会详情页/文章详情页）
  - PC：左右分栏（左：analysis summary；右：原文 HTML）
  - Mobile：上下布局（先结论后原文）
- `GET /prompts`（提示词管理）
  - 当前 active prompt 展示/编辑
  - 保存后新建 version，并将其置 active
  - 阈值 threshold 在这里调（默认 60）

------

## 9. 推送消息模板（钉钉 markdown，只有链接）

> 只发送“摘要 + 链接”，不在钉钉里贴全文；用 1 条消息聚合。

### 9.1 机会推送（前 4 次，仅当有机会）

- title：`【机会提醒】{slot} 发现 {N} 条`
- text（markdown）示例结构：
  - 机会列表（title + score）
  - “点击查看详情：日报页/机会页链接”
- 发送用 `msgtype=markdown`。([open.dingtalk.com](https://open.dingtalk.com/document/development/custom-robots-send-group-messages?utm_source=chatgpt.com))

### 9.2 22:00 日报推送（永远发）

- 若无机会：markdown 第一行写“今日无投资机会”，仍附日报链接
- 同样带 `msgUuid` 幂等：`msg_uuid = sha1(report_date + slot + payload_hash)`。([open.dingtalk.com](https://open.dingtalk.com/document/development/custom-robots-send-group-messages?utm_source=chatgpt.com))

------

## 10. 可扩展性（为未来“新增渠道”预留）

在 `services/plugin_sources.py` 定义接口：

```text
SourcePlugin:
  - name: str
  - fetch_items(window_start, window_end) -> List[RawItem]
RawItem:
  - external_id, title, url, published_at, raw_html/raw_text, meta
```

现阶段只实现 `WeRSSPlugin`：

- external_id = WeRSS `article_id`
- 拉取方式严格走 WeRSS API（不是 sqlite）

未来扩展网站/其他来源：

- 只要实现 `fetch_items`，后续 ingest/analyze/report/notify 不用改。

------

## 11. 关键边界场景与处理

1. **22:00 后发文，次日 07:00 才抓到**

- 通过“最近三天窗口”保证补抓（window_start = now-3days）。

1. **WeRSS Token 过期/401**

- 自动 refresh（/api/auth/refresh），失败再 login。参考你文档里的 refresh 示例。

1. **DeepSeek JSON 输出为空 / 不合法**

- 按 JSON Output 文档：允许概率性空 content → 重试；并做 schema 校验失败重试。([DeepSeek API Docs](https://api-docs.deepseek.com/zh-cn/guides/json_mode/?utm_source=chatgpt.com))

1. **钉钉网络超时导致重复推送**

- 用 `msgUuid` 幂等，重试仍是同一个 uuid。([open.dingtalk.com](https://open.dingtalk.com/document/development/custom-robots-send-group-messages?utm_source=chatgpt.com))

1. **原文 HTML 潜在不安全脚本**

- 展示前做 sanitize（去 script/iframe/on* 事件），或用 iframe sandbox（推荐）。

------

## 12. 本文交付物清单（LLD 该给到的“实现级”信息）

- 目录结构、模块职责
- 本系统数据库表设计（字段/约束/索引建议）
- 三大外部客户端（WeRSS/DeepSeek/钉钉）的调用参数、重试、幂等
- 定时任务与任务编排的执行序列
- 强制 JSON schema 与评分阈值机制
- Web 页面路由与 PC/手机布局规则
- 扩展插件接口（未来多来源）

------

如果你说 “OK”，我继续输出 **文档 4/10（接口设计文档：本系统对外/对内 API & 页面路由协议）**。