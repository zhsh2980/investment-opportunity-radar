According to a document from **2026-01-08**, WeRSS 在同机访问建议使用 `http://localhost:8001`，API 基础路径为 `/api`，并且除 RSS 订阅外的 API 需要 Bearer Token 认证。下面是**第 4 份文档（10 份中的第 4 份）：接口设计文档（API & Web 路由协议）**完整稿。

------

# 机会雷达（Investment Opportunity Radar）接口设计文档（API Spec）

## 1. 文档信息

- 文档名称：接口设计文档（Web 路由 + JSON API + 外部依赖接口）
- 版本：v1.0
- 时区：北京时间（Asia/Shanghai）
- 部署方式：公网 IP 可访问（无域名），Nginx 反代到 Web 服务
- 鉴权方式：Cookie Session + 记住我（Remember Me）

------

## 2. 约定与通用规范

### 2.1 Base URL 约定

- **机会雷达对外 Web**：`http://<公网IP>/`
- **机会雷达对内 JSON API**：`http://<公网IP>/api/v1/`（版本化，便于未来兼容）

### 2.2 统一响应格式（JSON API）

成功：

```json
{
  "code": 0,
  "message": "ok",
  "data": {}
}
```

失败：

```json
{
  "code": 12345,
  "message": "error",
  "detail": "human readable detail",
  "request_id": "uuid"
}
```

### 2.3 分页约定

- Query 参数：`limit`（默认 20，最大 100）、`offset`（默认 0）
- 列表返回：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "list": [],
    "total": 0,
    "limit": 20,
    "offset": 0
  }
}
```

### 2.4 时间与日期字段

- API 输入输出尽量使用：
  - 日期：`YYYY-MM-DD`（按北京时间自然日）
  - 时间：ISO8601（带时区偏移），例如 `2026-01-08T07:00:00+08:00`
- 对外展示都以北京时间为准。

------

## 3. 鉴权与会话（Cookie Session + Remember Me）

### 3.1 访问控制规则

- 允许匿名访问：
  - `GET /login`
  - `POST /api/v1/auth/login`
  - `GET /healthz`（健康检查）
- 其余页面与 API：**必须登录**，否则：
  - Web 页面：302 重定向到 `/login?next=<urlencoded>`
  - JSON API：返回 401（`code=40101`）

### 3.2 会话 Cookie 规范（建议）

- Cookie 名：`radar_session`
- 属性建议：
  - `HttpOnly=true`
  - `SameSite=Lax`
  - `Path=/`
  - `Max-Age`：
    - remember_me=true：30 天（可配置）
    - remember_me=false：浏览器会话级或 12 小时（可配置）
- Session 存储：Redis（推荐）或数据库（可选）

### 3.3 登录跳转（next）

- 用户点击钉钉链接打开：`/analysis/{id}` 或 `/daily/{date}`
- 未登录 → `/login?next=/analysis/xxx`
- 登录成功 → 302 到 `next`

------

## 4. Web 页面路由（给浏览器/钉钉打开）

> 页面路由是“用户可见”的入口，钉钉消息里只放这些链接。

### 4.1 登录页

- `GET /login`
  - Query：`next`（可选）
- `POST /login`
  - Form：
    - `username`
    - `password`
    - `remember_me`（`0/1`）
    - `next`（隐藏字段）

> 说明：也可以完全走 JSON API 登录（见 5.1），但提供表单页能降低实现复杂度。

### 4.2 首页（Dashboard）

- `GET /`
  - 今日概览：5 次 slot 进度、今日机会数、最高分机会、近 7 天日报入口
  - 需要登录

### 4.3 机会/文章分析详情页（核心）

- `GET /analysis/{analysis_id}`
  - 需要登录
  - **布局要求**：
    - PC：左（分析结论）/右（原文 HTML）
    - 手机：上（分析结论）/下（原文 HTML）

> 该页面用于钉钉“机会提醒”的落地页。

### 4.4 当日日报页（22:00 必推落地）

- `GET /daily/{date}`（date=`YYYY-MM-DD`）
  - 需要登录
  - 展示：
    - 今日结论（有无机会）
    - 浓缩资讯（digest）
    - 当天所有文章列表（可点进 `/analysis/{id}`）

### 4.5 历史列表页

- `GET /history`
  - 需要登录
  - 提供筛选：日期范围、最低分、机会类型、关键词

### 4.6 Prompt 管理页

- `GET /prompts`
- `POST /prompts`（保存新版本、激活）
  - 需要登录

### 4.7 系统配置页（阈值/调度等）

- `GET /settings`
- `POST /settings`
  - 需要登录

------

## 5. JSON API（给前端/脚本调用）

### 5.1 Auth

#### 5.1.1 登录

- `POST /api/v1/auth/login`
- Body（JSON）：

```json
{ "username": "admin", "password": "xxx", "remember_me": true }
```

- Response：

```json
{ "code": 0, "message": "ok", "data": { "username": "admin" } }
```

- Side Effect：写入 `radar_session` cookie

#### 5.1.2 登出

- `POST /api/v1/auth/logout`
- Response：`code=0`（并清 cookie）

#### 5.1.3 当前用户

- `GET /api/v1/auth/me`
- Response：

```json
{ "code": 0, "message": "ok", "data": { "username": "admin" } }
```

------

### 5.2 分析结果与机会

> 说明：我们把“每篇文章一次 DeepSeek 分析产出”作为一个 `analysis` 资源；其中可能包含多个 opportunities（机会点）。

#### 5.2.1 分析列表（支持筛选）

- `GET /api/v1/analyses`
- Query：
  - `date`：`YYYY-MM-DD`（可选，仅看某天）
  - `min_score`：整数（可选）
  - `type`：机会类型（可选）
  - `q`：关键词（标题/公众号/摘要）（可选）
  - `limit` / `offset`
- Response（示例）：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "list": [
      {
        "analysis_id": 123,
        "content_item_id": 456,
        "title": "xxx",
        "mp_name": "xxx",
        "published_at": "2026-01-08T06:40:00+08:00",
        "score": 78,
        "has_opportunity": true,
        "top_type": "convertible_bond_ipo",
        "summary": "一句话结论"
      }
    ],
    "total": 1,
    "limit": 20,
    "offset": 0
  }
}
```

#### 5.2.2 分析详情

- `GET /api/v1/analyses/{analysis_id}`
- Response（关键字段）：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "analysis_id": 123,
    "content_item": {
      "content_item_id": 456,
      "title": "xxx",
      "url": "https://mp.weixin.qq.com/s/...",
      "mp_name": "xxx",
      "published_at": "2026-01-08T06:40:00+08:00",
      "raw_html": "<div>...</div>"
    },
    "result_json": { "score": 78, "opportunities": [ ... ] },
    "score": 78,
    "prompt_version": 12,
    "created_at": "2026-01-08T07:01:23+08:00"
  }
}
```

#### 5.2.3 原文 HTML（可选拆分接口）

- `GET /api/v1/content-items/{content_item_id}/raw-html`
- Response：`text/html`（已 sanitize 后）

> 建议：详情页也可以直接走 `/api/v1/analyses/{id}` 一次性拿到 raw_html，减少请求数；拆分接口是为了后续缓存与大字段优化。

------

### 5.3 日报（Daily Report）

#### 5.3.1 获取某日日报

- `GET /api/v1/reports/daily/{date}`
- Response：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "date": "2026-01-08",
    "slots_done": ["07:00","12:00","14:00","18:00","22:00"],
    "has_opportunity": false,
    "digest_md": "### 今日浓缩资讯\n- ...",
    "top_opportunities": []
  }
}
```

------

### 5.4 Prompt 管理

#### 5.4.1 获取当前生效 Prompt（按 name）

- `GET /api/v1/prompts/active?name=opportunity_analyzer`
- Response：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "prompt_id": 12,
    "name": "opportunity_analyzer",
    "version": 12,
    "threshold": 60,
    "prompt_text": "..."
  }
}
```

#### 5.4.2 新增 Prompt 版本并可选激活

- `POST /api/v1/prompts`
- Body：

```json
{
  "name": "opportunity_analyzer",
  "prompt_text": "...",
  "threshold": 60,
  "activate": true
}
```

#### 5.4.3 激活某个 Prompt 版本

- `POST /api/v1/prompts/{prompt_id}/activate`

------

### 5.5 系统设置

#### 5.5.1 获取设置

- `GET /api/v1/settings`
- Response（示例）：

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "push_score_threshold": 60,
    "remember_me_days": 30,
    "schedule_slots": ["07:00","12:00","14:00","18:00","22:00"]
  }
}
```

#### 5.5.2 更新设置

- `PUT /api/v1/settings`
- Body：同上

------

### 5.6 运维与管理（受保护）

#### 5.6.1 健康检查

- `GET /healthz`
- Response：

```json
{ "status": "ok" }
```

#### 5.6.2 手工触发一个 slot（可选但强烈建议）

- `POST /api/v1/admin/run`
- Body：

```json
{ "slot": "07:00", "window_days": 3 }
```

- 权限：必须登录（可额外要求管理员角色，MVP 可省略）

------

## 6. 钉钉推送接口（外部依赖）

### 6.1 发送消息（自定义机器人）

- Endpoint：`POST https://oapi.dingtalk.com/robot/send`
- Query：
  - `access_token`
  - 若启用“加签安全设置”：追加 `timestamp` 与 `sign`（拼在 URL 上）([open.dingtalk.com](https://open.dingtalk.com/document/development/custom-robots-send-group-messages?utm_source=chatgpt.com))
- Body（markdown）支持：
  - `msgtype: "markdown"`
  - `msgUuid`：幂等 key（接口超时重试时用同一个 msgUuid 防重复）([open.dingtalk.com](https://open.dingtalk.com/document/development/custom-robots-send-group-messages?utm_source=chatgpt.com))
- 频率限制：每机器人每分钟最多 20 条，超过会被限流（官方说明）([open.dingtalk.com](https://open.dingtalk.com/document/development/custom-robots-send-group-messages?utm_source=chatgpt.com))

### 6.2 本系统“推送落地链接”规范

- 机会提醒（前 4 次命中阈值）：链接到
  - `http://<公网IP>/analysis/{analysis_id}`
- 22:00 日报（必推）：链接到
  - `http://<公网IP>/daily/{YYYY-MM-DD}`

> 原则：钉钉消息只放摘要 + 链接，不在钉钉里贴全文。

------

## 7. DeepSeek 接口（外部依赖）

### 7.1 Chat Completions

- Endpoint：`POST https://api.deepseek.com/chat/completions`
- `model` 可用值包含 `deepseek-chat` 与 `deepseek-reasoner`（我们必须使用 reasoner）。([DeepSeek API Docs](https://api-docs.deepseek.com/api/create-chat-completion/))
- 强制 JSON：
  - `response_format: { "type": "json_object" }` 可保证输出为有效 JSON
  - **但仍需在 system/user prompt 明确要求输出 JSON**，否则可能“卡住”（官方重要提示）。([DeepSeek API Docs](https://api-docs.deepseek.com/api/create-chat-completion/))
- `deepseek-reasoner` 会返回 `reasoning_content`（推理内容）与最终 `content`（答案）这类字段结构（官方 schema 描述）。([DeepSeek API Docs](https://api-docs.deepseek.com/api/create-chat-completion/))

------

## 8. WeRSS 接口（外部依赖，仅用于读取公众号文章）

> 本系统**不直连 SQLite**，统一调用 WeRSS HTTP API。

### 8.1 服务信息与认证总则

- 本地访问：`http://localhost:8001`
- API 基础路径：`/api`
- 访问限制：只读；API 需要 Bearer Token；建议同机走 localhost
- 补充规则：同服务器访问也需要 TOKEN；RSS/Feed 路径不需要

### 8.2 登录获取 Token

- `POST /api/auth/token`（form 表单）
- 返回 `expires_in=259200`（3 天）

### 8.3 刷新 Token（可选）

- `POST /api/auth/refresh`（Authorization: Bearer OLD_TOKEN）

### 8.4 获取公众号列表

- `GET /api/mps`（Bearer Token）

### 8.5 获取文章列表（支持 has_content）

- `GET /api/articles`
- Query 关键参数：
  - `mp_id`、`limit`、`offset`、`search`
  - `has_content`：是否返回完整内容（默认 false）
- 返回字段包含 `publish_time`（Unix 秒）等；并提示可在应用层按日期筛选、默认按 publish_time 降序

### 8.6 获取文章详情（含完整 HTML content）

- `GET /api/articles/{article_id}`（Bearer Token）
- 获取全文的两种方式：
  - 列表带 `has_content=true`
  - 或单篇详情接口

### 8.7 最近三天窗口筛选依据

- `publish_time` 是 Unix 时间戳（秒），推荐在应用层筛选日期范围

------

## 9. 错误码（建议最小集）

- `40101`：未登录或会话过期
- `40301`：无权限（预留）
- `42901`：请求过于频繁（本系统限流）
- `50001`：内部错误
- `50002`：DeepSeek 调用失败
- `50003`：钉钉推送失败
- `50004`：WeRSS 调用失败 / token 无效

------

## 10. 实现建议（对接层关键点）

- **钉钉消息幂等**：为每次 slot 推送生成固定 `msgUuid`（例如 `sha1(date+slot+type)`），超时重试不会重复发。([open.dingtalk.com](https://open.dingtalk.com/document/development/custom-robots-send-group-messages?utm_source=chatgpt.com))
- **WeRSS 拉取策略**：先 `articles(has_content=false)` 做筛选与去重，再对新增文章逐篇 `GET /api/articles/{id}` 拿全文入库，减少带宽与解析压力
- **DeepSeek JSON 输出**：必须同时设置 `response_format=json_object` + prompt 明确“只输出 JSON”，并设置足够 max_tokens 防截断。([DeepSeek API Docs](https://api-docs.deepseek.com/api/create-chat-completion/))

------

如果你认可这份接口设计，下一份我会输出 **文档 5/10：数据库设计文档（Schema/ERD + 索引/唯一约束/幂等键/保留策略）**，并把“分析过不再分析”和“22:00 日报必推”的幂等约束写成可直接落表的唯一键与索引。