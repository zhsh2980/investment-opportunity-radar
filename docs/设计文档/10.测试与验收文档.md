# 文档 10/10：测试与验收文档（Test Plan & Acceptance）

> 目标：把你提出的所有硬性需求（5 次定时、近 3 天窗口、已分析不再分析、阈值可调、前 4 次无机会不推、22:00 必推、只推链接、详情页需登录且记住我、DeepSeek 思考模型+强制 JSON、历史可追溯）落实为**可执行的测试用例与验收标准**，你拿着这份就能让 AI/工程师照着跑通。

------

## 1. 测试范围

### 1.1 覆盖范围（必须）

- WeRSS API 对接（Token 登录/刷新/401 自恢复、拉文章列表/详情）
- 定时任务（北京时间 5 次、幂等、失败重试）
- DeepSeek 调用（必须思考模型、强制 JSON、解析/校验/重试）
- 数据库落库（去重、状态机、机会抽取、日报生成）
- 钉钉推送（加签、幂等 msgUuid、前 4 次推送策略、22:00 必推）
- Web UI（登录/记住我、机会详情页分栏、日报页浓缩资讯、历史查询）

### 1.2 不在本期测试范围（允许不测）

- 真正联网搜索（当前仅在 Prompt 中要求模型“去搜索”，不验证搜索真实性）
- 多数据源接入（仅验证 WeRSS 适配器）

------

## 2. 测试环境与前置条件

### 2.1 环境

- 服务器：腾讯云 Ubuntu
- 部署：Docker Compose + Nginx（公网 IP 访问）
- 时区：Asia/Shanghai（北京时间）

### 2.2 依赖可用性（前置）

- WeRSS 服务可用，并能通过 `http://localhost:8001/api/*` 访问
- 已配置 WeRSS 登录账号密码（用于自动获取 token）
- 已配置 DeepSeek API Key，并明确使用思考模型
- 已配置钉钉机器人 webhook + secret（加签方式）
- 已创建本系统管理员账号（Web 登录）

### 2.3 测试数据准备

建议至少准备 3 类文章（可通过 WeRSS 抓取或手工造数据模拟）：

1. 明确机会：可转债申购/上市套利类（应 score ≥ 60）
2. 价值一般：宏观观点/市场复盘（应 score < 60）
3. 垃圾/广告：课程/付费群（应 score 很低且无机会）

------

## 3. 测试策略（怎么测）

- **单元测试**：对关键纯逻辑模块（签名、窗口计算、HTML 清洗、schema 校验、幂等键生成）
- **集成测试**：对 WeRSS/DeepSeek/钉钉三方接口（建议用 mock + 少量真实调用）
- **端到端 E2E**：完整跑一遍 slot，验证“入库→分析→推送→页面可打开”
- **回归测试**：每次改 Prompt/阈值/调度后重复跑关键用例

------

## 4. 验收标准（Acceptance Criteria 总表）

> 通过以下所有验收项视为“上线可用”。

1. 每天 5 个时段定时触发成功（07/12/14/18/22，北京时间）
2. 每次仅处理近 72 小时文章，覆盖 22:00 后发文次日 07:00 可分析
3. 同一文章只分析一次（重启/重复触发不重复分析）
4. DeepSeek 必须使用思考模型；输出严格 JSON，可被系统解析并入库
5. 前 4 次：无机会不推；有机会推“链接”且只推链接
6. 22:00：无论是否有机会都推日报链接；无机会文案为“今日无投资机会”
7. 机会详情页必须登录；勾选“记住我”后 30 天内不反复输入
8. 详情页 PC 左右分栏、手机上下布局，且展示“结论 + 原文”
9. 日报页展示“浓缩资讯 + 全量列表 + 失败列表（若有）”
10. 历史列表可按日期/评分/类型筛选并能回溯原文与结论
11. 失败可观测：slot_run、notification_log、analysis 失败原因可查
12. 系统重启后可继续运行（token 自动续期，任务继续触发）

------

## 5. 测试用例（按模块）

### 5.1 WeRSS 对接测试

#### TC-WERSS-01：Token 登录成功

- 前置：WeRSS 用户名密码正确
- 步骤：
  1. 调用 WeRSS 登录接口获取 token
  2. 存储 token 与 expires_at
- 期望：
  - 返回 token 非空
  - expires_in=259200（或至少>0）
  - 后续携带 Bearer token 调 /api/mps 成功

#### TC-WERSS-02：Token 过期自动刷新/重登

- 前置：将缓存 token 设为过期（或手工写入无效 token）
- 步骤：
  1. 用无效 token 调用 /api/articles
  2. 捕获 401
  3. 自动 refresh（如实现）或重新登录
  4. 重试原请求
- 期望：
  - 最终请求成功（无人工干预）
  - 日志记录“401→refresh/login→retry success”

#### TC-WERSS-03：近 72 小时窗口筛选

- 前置：WeRSS 中存在 4 天前文章 + 1 天内文章
- 步骤：触发 ingest_window
- 期望：
  - 4 天前文章不入库/不分析
  - 1 天内文章入库并进入待分析队列

#### TC-WERSS-04：文章详情获取全文 HTML

- 步骤：
  1. 拉 meta 列表（has_content=false）
  2. 对新增文章调用详情接口拉 content
- 期望：
  - content_item.raw_html 非空
  - content_item.raw_text 为清洗后文本（非空或合理）

------

### 5.2 DeepSeek 分析测试

#### TC-DS-01：必须使用思考模型

- 步骤：触发 analyze_one
- 期望：
  - 调用参数 model 固定为 deepseek-reasoner（可从日志/DB 记录验证）
  - 任何配置误改会导致测试失败（断言）

#### TC-DS-02：强制 JSON 可解析

- 步骤：对一篇文章调用
- 期望：
  - 返回 content 是严格 JSON（json.loads 成功）
  - schema 校验通过
  - analysis_result 入库成功

#### TC-DS-03：JSON 缺字段触发重试

- 方法：用 mock 让模型返回缺字段 JSON
- 期望：
  - 系统重试（最多 3 次）
  - 最终成功则入库；最终失败则标记 analyzed_status=失败待重试

#### TC-DS-04：空 content 触发重试

- 方法：mock 返回空字符串
- 期望：
  - 重试发生，日志可见重试次数
  - 最终按策略成功或失败入 failure 列表

------

### 5.3 幂等与去重测试

#### TC-IDEMP-01：同一文章不重复入库

- 步骤：
  1. ingest_window 执行两次
- 期望：
  - content_item external_id 唯一不重复
  - 第二次执行新增数为 0（或接近 0）

#### TC-IDEMP-02：同一文章不重复分析

- 步骤：
  1. analyze_one 同一 content_item_id 执行两次
- 期望：
  - analysis_result 只有 1 条
  - 第二次直接返回“已存在”

#### TC-IDEMP-03：同一 slot 不重复推送

- 步骤：
  1. finalize_and_notify 同一 run_id 重复执行
- 期望：
  - notification_log 只有 1 条成功记录（msg_uuid 唯一）
  - 钉钉不重复收到消息

------

### 5.4 推送策略测试（核心验收点）

#### TC-PUSH-01：前 4 次无机会不推

- 前置：当次 slot 所有文章 score < threshold
- 步骤：运行 slot=07:00（或 12/14/18）
- 期望：
  - notification_log 无该 slot 的 opportunity 推送记录
  - 钉钉无消息

#### TC-PUSH-02：前 4 次有机会才推且只推链接

- 前置：当次 slot 至少 1 篇 score ≥ threshold
- 步骤：运行 slot=14:00
- 期望：
  - notification_log 记录 1 条成功推送
  - 推送内容：
    - 仅含摘要 + URL（不含长文）
    - URL 指向 /analysis/{analysis_id}
  - 钉钉端点开需登录（若未登录）

#### TC-PUSH-03：22:00 必推（有机会）

- 前置：当天存在机会
- 步骤：运行 slot=22:00
- 期望：
  - 必有 1 条 daily 推送记录
  - URL 指向 /daily/{date}
  - 日报页展示 top opportunities

#### TC-PUSH-04：22:00 必推（无机会 → 文案固定）

- 前置：当天所有 score < threshold
- 步骤：运行 slot=22:00
- 期望：
  - 钉钉必收到消息
  - 消息标题或正文明确包含“今日无投资机会”
  - URL 指向 /daily/{date}
  - 日报页顶部显示“今日无投资机会”，但仍有浓缩资讯

------

### 5.5 Web UI 测试（登录 + 适配）

#### TC-UI-01：未登录访问详情页会跳转登录

- 步骤：浏览器无 cookie，直接访问 `/analysis/{id}`
- 期望：
  - 302 到 `/login?next=/analysis/{id}`

#### TC-UI-02：记住我生效

- 步骤：
  1. 登录勾选 remember_me
  2. 关闭浏览器重新打开 `/daily/{date}`
- 期望：
  - 仍保持登录（30 天内）
  - 不需要再次输入密码

#### TC-UI-03：PC 左右分栏

- 步骤：用桌面浏览器访问详情页
- 期望：
  - 左侧显示分析结论区，右侧显示原文区
  - 左侧包含：score、summary、action_steps、risk、checklist、search_suggestions

#### TC-UI-04：移动端上下布局

- 步骤：手机或浏览器移动模式访问详情页
- 期望：
  - 上方为结论，下方为原文（可折叠）
  - 第一屏可看到“做不做、怎么做、风险”

#### TC-UI-05：日报页浓缩资讯

- 步骤：访问 `/daily/{date}`
- 期望：
  - digest_md 正常渲染（markdown）
  - 下方有全量列表（可点进详情）

#### TC-UI-06：历史检索

- 步骤：在 `/history` 设置筛选（日期范围 + min_score + 类型）
- 期望：
  - 列表返回正确结果
  - 点击可进入对应详情页

------

### 5.6 可靠性与恢复测试

#### TC-REL-01：服务重启后继续工作

- 步骤：
  1. 重启 docker compose
  2. 手工触发 `/api/v1/admin/run` 或等待下一 slot
- 期望：
  - token 自动恢复（重新登录/刷新）
  - slot_run 正常生成
  - 不重复分析/不重复推送

#### TC-REL-02：DeepSeek 暂时不可用

- 方法：临时断网或 mock 500/timeout
- 期望：
  - 单篇任务重试并记录失败
  - 22:00 仍能推日报链接（日报页显示失败条目与原因）

#### TC-REL-03：钉钉发送超时

- 方法：mock 超时
- 期望：
  - notification_log 记录失败
  - 重试使用相同 msg_uuid，不产生重复消息

------

## 6. 回归测试清单（你以后改 Prompt/阈值必跑）

每次改动以下任何一项，都至少回归：

- Prompt 文本 / JSON schema
- threshold（推送阈值）
- 定时配置（slots）
- WeRSS token/账号配置
- 钉钉 webhook/secret

必跑用例：

- TC-DS-02、TC-PUSH-01、TC-PUSH-04、TC-IDEMP-02、TC-UI-02

------

## 7. 上线前检查（Go-Live Checklist）

-  WeRSS API 可调用（/api/mps 成功）
-  WeRSS token 自动续期/过期自恢复（模拟 401）
-  DeepSeek 使用 reasoner 且 JSON 输出可解析（抽样 3 篇）
-  钉钉加签发送成功（发一条测试消息）
-  07/12/14/18/22 定时配置正确（可用手工触发验证）
-  22:00 必推逻辑可通过手工触发验证
-  Web 登录 + 记住我可用
-  详情页原文 sanitize 正常（无脚本注入）
-  数据库备份脚本可执行并能恢复

------

## 8. 验收交付方式（你怎么确认“真的可用了”）

建议你用 1 天做“试运行验收”：

1. 早上手工触发 07:00（或把 slot 改到当前时间跑一次），确认无机会不推
2. 中午塞入一篇“明确机会文章”，触发 12:00，确认会推机会链接
3. 晚上触发 22:00，确认无论有无机会都推日报链接
4. 从钉钉点开链接 → 登录一次 → 勾记住我 → 再次打开无需登录
5. 历史页能查到今日全部分析，且每篇能看到原文与结论

------

至此 10 份文档全部齐了（1~10）。如果你接下来要“拿文档交给 AI 工具直接生成代码”，我建议你下一步先选一个技术栈（例如 FastAPI + SQLAlchemy + Alembic + Celery + Redis + Postgres），然后我可以把这 10 份文档再进一步压缩成一份“实现任务清单（逐文件/逐函数/逐接口）”的工程 TODO，方便你直接喂给代码生成工具。