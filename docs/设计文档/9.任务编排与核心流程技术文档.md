# 文档 9/10：任务编排与核心流程技术文档（Scheduler/Worker/幂等/重试/推送策略）

> 目标：把“每天 5 次定时 → 拉取近 3 天文章 → 去重 → 逐篇调用 DeepSeek（思考模型）→ 落库 → 按规则推送 → 22:00 生成日报”的**执行时序、任务拆分、幂等与重试策略**写成工程可直接照做的技术文档。

------

## 1. 总体流程概览（End-to-End）

每天按北京时间触发 5 次：`07:00 / 12:00 / 14:00 / 18:00 / 22:00`

每次 Slot 的执行流程：

1. 创建/获取本次 `slot_run`（幂等：同日同 slot 唯一）
2. 从 WeRSS 拉取最近 72 小时文章元数据（只拿轻量字段）
3. 过滤近 72 小时 + 去重（未入库 external_id 的才入库）
4. 对新增文章抓全文（HTML），清洗为纯文本，写入 `content_item`
5. 找出待分析 `content_item.analyzed_status=0` → 入队逐篇分析任务
6. 等待分析结束 → 汇总本 slot 机会列表（score≥阈值）
7. 推送：
   - 前 4 次（07/12/14/18）：若本 slot 新增机会为空 → 不推；否则推“最高分机会详情链接”
   - 22:00：生成/更新当日日报 → **必推日报链接**（无机会则“今日无投资机会”）

------

## 2. 任务系统组件与责任边界

### 2.1 Scheduler（Celery Beat）

- 责任：按北京时间 5 个时间点触发 `run_slot(slot)`（只负责触发，不做重活）
- 要点：timezone=Asia/Shanghai；容器内 TZ=Asia/Shanghai

### 2.2 Worker（Celery Worker）

- 责任：执行 `run_slot` 的编排逻辑、入库、逐篇分析、推送
- 并发：由于你每天≤10篇，`concurrency=2` 足够（避免过多并发触发限流）

### 2.3 Broker/Backend（Redis）

- 责任：任务队列与状态（同时可用于 session / token 缓存）

------

## 3. 任务拆分（Task Graph）

推荐任务定义（从粗到细）：

- `run_slot(slot: str)`：一个 slot 的总编排
  - `ingest_window(run_id)`：拉取近 72 小时文章并入库（只新增）
    - `fetch_articles_meta(window)`：分公众号/分页拉元数据
    - `fetch_article_detail(article_id)`：拉全文 HTML
    - `normalize_and_store(article)`：清洗、hash、入库
  - `enqueue_analyses(run_id)`：将待分析文章逐篇入队
    - `analyze_one(content_item_id, run_id)`：单篇 DeepSeek 分析
  - `finalize_and_notify(run_id)`：汇总并按规则推送（含 22:00 日报）

> 说明：也可以把 `fetch_article_detail` 和 `normalize_and_store` 合并为一个“入库任务”，但拆开便于重试与日志定位。

------

## 4. 幂等设计（最关键的“不会重复分析/不会重复推送”）

### 4.1 幂等键定义

1. **Slot Run 幂等**

- DB 约束：`slot_run.unique(run_date, slot)`
- 逻辑：`run_slot(slot)` 一开始 `get_or_create_slot_run(run_date, slot)`
- 若已存在且 status=success：直接退出（避免重复推送）
- 若已存在且 status=running：说明重复触发（可直接退出或检查超时）

1. **文章入库幂等**

- DB 约束：`content_item.external_id unique`（WeRSS article_id）
- 逻辑：对每条 meta，先查是否存在 external_id；不存在才拉详情/入库
- 如并发竞争导致插入冲突：捕获 unique 冲突 → 当作已入库处理

1. **分析幂等**

- DB 约束：`analysis_result.unique(content_item_id)`
- `analyze_one` 开始时先检查是否已有 analysis_result，若有直接返回
- 插入时若 unique 冲突：说明已分析过 → 直接返回成功（幂等）

1. **推送幂等**

- DB 约束：`notification_log.msg_uuid unique`
- `msg_uuid` 建议：`sha1(report_date + slot + push_type + target_url)`
- 发送前插入 notification_log（status=0），插入成功才发送；若插入 unique 冲突说明已推送 → 不再发送
- 发送成功更新 status=1，失败记录 error 并可重试（重试仍用相同 msg_uuid）

------

## 5. 时间窗口与“近 3 天”逻辑（覆盖 22:00 后发文）

### 5.1 窗口计算

- `window_end = now()`（slot 触发时刻）
- `window_start = now() - 72 hours`（3 天）

### 5.2 过滤策略（应用层）

因为 WeRSS 文章列表按 publish_time 降序，且 publish_time 是 Unix 秒级时间戳，你应在应用层筛选：

- `publish_time >= (window_start_epoch_seconds)`

### 5.3 “晚 10 点后发文”覆盖

- 如果作者在 22:00 后发布、你当天未抓到：
  - 次日 07:00 的窗口仍包含该文章（在 72 小时内），因此能补分析。

------

## 6. WeRSS 拉取策略（减少带宽 + 更稳）

### 6.1 两阶段拉取（推荐）

1. **Meta 阶段（轻量）**

- `GET /api/articles?mp_id=...&limit=...&offset=...&has_content=false`
- 得到 `id/title/url/mp_name/publish_time/status` 等

1. **Detail 阶段（重）**

- 仅对未入库 external_id 的文章：`GET /api/articles/{article_id}` 获取 `content`（HTML）

### 6.2 Token 维护

- token 默认 3 天过期，因此 Worker 需要自动 refresh 或重新登录
- 若 API 返回 401：触发 refresh → 失败则 login
- token 建议缓存到 Redis（key：`werss:token` + `expires_at`）

------

## 7. DeepSeek 调用策略（思考模型 + JSON 强制 + 重试）

### 7.1 调用约束

- model 固定 `deepseek-reasoner`（思考模型）
- response_format 固定 `json_object`
- prompt 必须包含 “json” 与示例
- 绝不回传 `reasoning_content` 到下一轮 messages（否则 400）

### 7.2 输入截断策略（防止超长）

- `content_text` 建议限制到 12k~20k 字符（可配置）
- 若截断：在 user prompt 末尾加一句提示“正文过长已截断，可能缺失关键信息，需核验原文”

### 7.3 重试策略（最多 3 次）

触发条件：

- HTTP 429/5xx
- JSON 解析失败
- schema 校验失败
- content 为空

动作：

- 第 1 次：原样重试
- 第 2 次：在 user prompt 追加“务必只输出 JSON，不要输出任何其它字符”
- 第 3 次：要求按示例字段顺序输出，缺字段补空值

仍失败：

- `content_item.analyzed_status=3`（失败待重试）
- 在日报 failures 区域展示（不阻塞全局）

------

## 8. 推送策略（严格符合你的规则）

### 8.1 阈值与机会判定

- `threshold = settings.push_score_threshold`（默认 60）
- 机会判定：
  - `score >= threshold` 视为“可推送机会”
  - `score < threshold` 视为“仅资讯/观察”

### 8.2 前 4 次（07/12/14/18）

- 若本 slot 新增的分析结果中 **没有** score≥threshold：不推送
- 若有：选取“最高分” analysis_id 作为落地页
  - 推送标题：`【机会提醒】{slot} 发现 {N} 条（最高分 {max_score}）`
  - 推送链接：`/analysis/{top_analysis_id}`

> “本 slot 新增”指：run_id=本 slot_run 的 analysis_result（避免重复推历史机会）。

### 8.3 22:00（必推）

- 先生成/更新当日日报 `daily_report`
- 推送标题：
  - 有机会：`【日报】{date}：{opportunities_count} 条机会（最高分 {max_score}）`
  - 无机会：`【日报】{date}：今日无投资机会`
- 推送链接：`/daily/{date}`

------

## 9. 当日日报生成（22:00）技术细节

### 9.1 输入数据

- 当天（北京时间）所有 `analysis_result`
  - 包括低分、无机会、失败（失败用简略信息）
- “compact 结构”传给日报 prompt：
  - title, mp_name, published_at, score, has_opportunity, top_type, summary, analysis_url, opportunities_brief

### 9.2 输出数据

- `daily_digest` prompt 输出 JSON：
  - has_opportunity
  - top_opportunities（最多 3）
  - digest_md（浓缩资讯）
  - watchlist（未来关注）
  - stats（总分析篇数/机会数/失败数）

### 9.3 写库

- `daily_report(report_date)` upsert：
  - digest_md/digest_json
  - slots_done（当天已完成的 slot 列表）
  - stats

------

## 10. 错误处理与补偿机制（保证 22:00 必推）

### 10.1 slot 失败的定义

- `slot_run.status=2`：
  - ingest 全部失败（WeRSS 不可用）
  - 或者 analyze 全部失败（DeepSeek 不可用）
  - 或 finalize 阶段异常

### 10.2 22:00 必推保障策略

即使当日分析失败，也要在 22:00 发消息：

- 若日报生成失败：
  - 仍推送 `/daily/{date}`
  - 日报页展示“日报生成失败，请稍后刷新”并列出失败原因（来自 slot_run.error）

### 10.3 自动补偿（可选但推荐）

- 若某个 slot_run 失败：
  - 在下一个 slot 触发时，优先尝试重跑失败队列（`analyzed_status=3` 的文章）
- 但要限制总量，避免每次都重试旧失败造成阻塞（你每天量小，问题不大）

------

## 11. 关键时序图（文本版）

### 11.1 前 4 次（有机会才推）

```
Beat -> run_slot(14:00)
  -> get_or_create slot_run(2026-01-08,14:00)
  -> ingest_window(72h):
       WeRSS list metas
       for new ids: WeRSS get detail -> store content_item
  -> enqueue analyses:
       for each pending content_item: analyze_one -> analysis_result/opportunity
  -> finalize:
       select opportunities for this run (score>=threshold)
       if empty: no push
       else: push top analysis link
  -> slot_run status=success
```

### 11.2 22:00（必推）

```
Beat -> run_slot(22:00)
  -> ingest + analyze (同上)
  -> generate_daily_report(date)
  -> push daily link (always)
  -> slot_run status=success
```

------

## 12. 运维观测点（你需要看的“是否正常”）

### 12.1 每日必看（可在 Dashboard 展示）

- 今日 5 个 slot 是否全部完成（slots_done）
- 今日分析篇数/失败数
- 今日机会数与最高分
- 22:00 推送是否成功（notification_log）

### 12.2 告警触发建议（后续可接）

- 连续 2 个 slot ingest=0 且 WeRSS 正常 → 可能授权停摆
- 22:00 notification 失败 → 强提醒
- DeepSeek 429 连续出现 → 降低并发/延长退避

------

## 13. 参数与默认值（便于实现统一配置）

- `window_days = 3`
- `schedule_slots = ["07:00","12:00","14:00","18:00","22:00"]`
- `push_score_threshold = 60`
- `max_articles_per_slot = 50`（保险值，你实际≤10）
- `deepseek_max_retries = 3`
- `deepseek_content_truncate_chars = 16000`
- `worker_concurrency = 2`
- `remember_me_days = 30`

------

如果这份任务编排与流程文档 OK，最后我将输出 **文档 10/10：测试与验收文档（测试用例、验收清单、回归测试、数据校验、上线前检查）**，把每条需求都落成可执行的测试项（尤其是 22:00 必推、前 4 次不打扰、已分析不再分析、token 3 天游走续期等）。