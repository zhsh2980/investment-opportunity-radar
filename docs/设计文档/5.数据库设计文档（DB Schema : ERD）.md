According to a document from **2026-01-08**,WeRSS 建议同机用 `http://localhost:8001` 访问，API 基础路径为 `/api`，并且（除 RSS 订阅外）API 需要 Bearer Token 认证、Token 默认有效期为 259200 秒（3 天）。

下面是**第 5 份文档：数据库设计文档（Schema/ERD + 索引/唯一约束/幂等/保留策略）**完整稿。

------

# 机会雷达（Investment Opportunity Radar）数据库设计文档（DB Schema / ERD）

## 1. 设计目标

1. **可追溯**：长期保存“原文（HTML）+ 分析结论（JSON/Markdown）+ 当日日报 + 推送记录 + Prompt 版本”。
2. **幂等**：同一文章只分析一次；同一时段推送不会重复发。
3. **查询友好**：支持按日期/评分/机会类型/关键词快速检索；日报页一屏加载。
4. **可扩展**：未来新增其它内容渠道（网站/RSS 等）无需改核心表结构。
5. **安全**：不在数据库里存 WeRSS Token（建议存 Redis 缓存）；数据库仅存自身账号密码哈希等必要信息。

------

## 2. 数据库选型与约定

### 2.1 选型

- **PostgreSQL**（推荐 14+）
  - 原因：JSONB、全文检索、索引能力强；适合“结构化 + 半结构化（模型 JSON）”混合存储。

> 小规模也能用 SQLite，但你要做 Web/任务队列/长期扩展，Postgres 更稳。

### 2.2 通用约定

- 字符集：UTF-8
- 时区：统一存储为 `timestamptz`（显示时按 Asia/Shanghai）
- 主键：`bigserial`（或 `generated always as identity`）
- JSON：统一用 `jsonb`
- 大字段：原文 HTML/长摘要利用 Postgres TOAST（无需手工分表）

------

## 3. ERD（实体关系图）

```
app_user
   |
   | 1:N
   v
audit_log (可选)

prompt_version 1:N analysis_result N:1 content_item
                      |
                      | 1:N
                      v
                 opportunity

slot_run 1:N analysis_result
slot_run 1:1 daily_report (仅 22:00 生成/更新)

daily_report 1:N report_item (可选，或由 analysis_result 动态生成)

notification_log (独立，记录每次推送)
```

> 说明：
>
> - `content_item`：存“文章快照”（原文/元数据）
> - `analysis_result`：存“单篇文章的 DeepSeek 输出（强制 JSON）”
> - `opportunity`：把 JSON 里的机会点“规范化抽取”为可检索行（便于筛选/统计/列表）
> - `slot_run`：记录每个时段的批次执行（07/12/14/18/22）

------

## 4. 表结构详述

### 4.1 `app_user`（登录账号）

用于 Web 登录（Cookie Session + Remember Me）。

| 字段          | 类型         | 约束                  | 说明               |
| ------------- | ------------ | --------------------- | ------------------ |
| id            | bigserial    | PK                    |                    |
| username      | varchar(64)  | UNIQUE, NOT NULL      | 登录名             |
| password_hash | varchar(255) | NOT NULL              | bcrypt/argon2 哈希 |
| is_active     | boolean      | NOT NULL default true |                    |
| created_at    | timestamptz  | NOT NULL              |                    |
| updated_at    | timestamptz  | NOT NULL              |                    |
| last_login_at | timestamptz  |                       |                    |

**索引**

- `unique(username)`

------

### 4.2 `settings`（系统配置，阈值等）

| 字段       | 类型        | 约束     | 说明                      |
| ---------- | ----------- | -------- | ------------------------- |
| key        | varchar(64) | PK       | 如 `push_score_threshold` |
| value_json | jsonb       | NOT NULL | 支持热更新                |
| updated_at | timestamptz | NOT NULL |                           |

建议默认配置项：

- `push_score_threshold`: 60
- `remember_me_days`: 30
- `schedule_slots`: ["07:00","12:00","14:00","18:00","22:00"]
- `window_days`: 3

------

### 4.3 `prompt_version`（Prompt 版本管理）

| 字段            | 类型        | 约束                   | 说明                                    |
| --------------- | ----------- | ---------------------- | --------------------------------------- |
| id              | bigserial   | PK                     |                                         |
| name            | varchar(64) | NOT NULL               | `opportunity_analyzer` / `daily_digest` |
| version         | int         | NOT NULL               | 递增                                    |
| is_active       | boolean     | NOT NULL default false | 同 name 仅 1 条为 true                  |
| threshold       | int         | NOT NULL               | 默认 60（可改）                         |
| prompt_text     | text        | NOT NULL               | 完整提示词                              |
| response_schema | jsonb       | NOT NULL               | 期望 JSON Schema（用于校验）            |
| created_at      | timestamptz | NOT NULL               |                                         |

**约束**

- `unique(name, version)`
- 同一 `name` 下仅允许 1 条 `is_active=true`（用事务保证，或 partial unique index）

**索引**

- `index(name, is_active)`

------

### 4.4 `slot_run`（批次运行记录：每天 5 次）

| 字段            | 类型        | 约束                  | 说明                                     |
| --------------- | ----------- | --------------------- | ---------------------------------------- |
| id              | bigserial   | PK                    |                                          |
| run_date        | date        | NOT NULL              | 北京时间自然日                           |
| slot            | varchar(5)  | NOT NULL              | "07:00"/"12:00"/"14:00"/"18:00"/"22:00"  |
| window_start_at | timestamptz | NOT NULL              | now - 3 days                             |
| window_end_at   | timestamptz | NOT NULL              | now                                      |
| status          | smallint    | NOT NULL              | 0=running,1=success,2=failed             |
| stats           | jsonb       | NOT NULL default '{}' | 数量统计：拉取/新增/分析成功/失败/机会数 |
| started_at      | timestamptz | NOT NULL              |                                          |
| finished_at     | timestamptz |                       |                                          |
| error           | text        |                       |                                          |

**幂等约束**

- `unique(run_date, slot)`：同一时段重复触发时，直接复用该 run 记录（避免重复推送与重复汇总）。

------

### 4.5 `content_item`（文章快照：来自 WeRSS）

> 文章元信息来自 WeRSS `/api/articles` 与 `/api/articles/{id}`，其中 `has_content` 控制是否带 `content`（HTML）字段；`publish_time` 是 Unix 时间戳（秒）。

| 字段               | 类型         | 约束                       | 说明                                       |
| ------------------ | ------------ | -------------------------- | ------------------------------------------ |
| id                 | bigserial    | PK                         |                                            |
| source_type        | varchar(32)  | NOT NULL                   | 目前固定 `werss`（预留扩展）               |
| source_id          | varchar(64)  | NOT NULL default 'default' | 预留（未来多实例）                         |
| external_id        | varchar(255) | UNIQUE, NOT NULL           | WeRSS article_id                           |
| mp_id              | varchar(255) |                            | WeRSS mp_id                                |
| mp_name            | text         |                            | 公众号名                                   |
| title              | text         | NOT NULL                   |                                            |
| url                | text         |                            | 原文链接                                   |
| description        | text         |                            | WeRSS description                          |
| pic_url            | text         |                            | WeRSS pic_url                              |
| published_at       | timestamptz  | NOT NULL                   | publish_time 转换而来                      |
| werss_publish_time | bigint       | NOT NULL                   | 原始 publish_time（秒）                    |
| status             | int          | NOT NULL default 1         | WeRSS status（1=正常等，原样存）           |
| raw_html           | text         |                            | 原文 HTML（WeRSS content）                 |
| raw_text           | text         |                            | HTML 清洗后的纯文本                        |
| content_hash       | char(64)     | NOT NULL                   | sha256(raw_html)                           |
| fetched_at         | timestamptz  | NOT NULL                   | 我方抓取入库时间                           |
| analyzed_status    | smallint     | NOT NULL default 0         | 0=未分析 1=已分析 2=跳过 3=失败待重试      |
| analyzed_at        | timestamptz  |                            |                                            |
| meta               | jsonb        | NOT NULL default '{}'      | 其它字段（WeRSS created_at/updated_at 等） |

**索引（强烈建议）**

- `index(published_at desc)`
- `index(mp_id, published_at desc)`
- `index(analyzed_status, published_at desc)`
- `gin(to_tsvector('simple', coalesce(title,'') || ' ' || coalesce(raw_text,'')))`（全文检索，可选）

**说明（窗口筛选）**

- 我方按“最近 3 天”窗口处理；由于 WeRSS 的 `publish_time` 是 Unix 秒级时间戳，建议应用层筛选。

------

### 4.6 `analysis_result`（单篇文章分析结果）

| 字段              | 类型        | 约束                 | 说明                                  |
| ----------------- | ----------- | -------------------- | ------------------------------------- |
| id                | bigserial   | PK                   |                                       |
| content_item_id   | bigint      | UNIQUE, NOT NULL, FK | 1 篇文章只分析 1 次                   |
| run_id            | bigint      | FK                   | 哪个 slot_run 产出                    |
| prompt_version_id | bigint      | NOT NULL, FK         | 对应 prompt 版本                      |
| model             | varchar(64) | NOT NULL             | 固定 `deepseek-reasoner`              |
| score             | int         | NOT NULL             | 0-100                                 |
| has_opportunity   | boolean     | NOT NULL             | 通常 score>=threshold                 |
| result_json       | jsonb       | NOT NULL             | 模型强制 JSON 原文                    |
| summary_md        | text        | NOT NULL             | 展示用 markdown（从 JSON 提取或另存） |
| created_at        | timestamptz | NOT NULL             |                                       |

**索引**

- `index(score desc)`
- `index(has_opportunity, score desc)`
- `index(created_at desc)`
- `index(prompt_version_id)`

> 如果未来你要“Prompt 更新后重跑同一文章”，可以把 UNIQUE 从 `(content_item_id)` 调整为 `(content_item_id, prompt_version_id)`；但当前需求是“分析过就不再分析”，所以先用 `unique(content_item_id)`。

------

### 4.7 `opportunity`（机会点规范化表：便于检索/过滤）

> 目的：模型 JSON 里可能有多个机会点，把它们抽取成行，UI 列表与筛选更快。

| 字段                | 类型         | 约束                  | 说明                                         |
| ------------------- | ------------ | --------------------- | -------------------------------------------- |
| id                  | bigserial    | PK                    |                                              |
| analysis_id         | bigint       | NOT NULL, FK          |                                              |
| idx                 | int          | NOT NULL              | JSON 中机会点序号（0..n-1）                  |
| type                | varchar(64)  | NOT NULL              | `convertible_bond_ipo` / `fund_arbitrage` 等 |
| title               | text         | NOT NULL              | 机会标题                                     |
| score_hint          | int          |                       | 可选：机会子评分                             |
| confidence          | numeric(4,3) |                       | 0~1                                          |
| time_window_start   | timestamptz  |                       |                                              |
| time_window_end     | timestamptz  |                       |                                              |
| how_to              | jsonb        | NOT NULL default '[]' | 执行步骤数组                                 |
| constraints         | jsonb        | NOT NULL default '[]' | 门槛/限制/风控                               |
| need_search_queries | jsonb        | NOT NULL default '[]' | 让模型“上网搜索”的关键词                     |
| numbers             | jsonb        | NOT NULL default '{}' | 代码/溢价率/收益区间等                       |
| created_at          | timestamptz  | NOT NULL              |                                              |

**约束**

- `unique(analysis_id, idx)`

**索引**

- `index(type, created_at desc)`
- `index(time_window_start)`
- `index(confidence desc)`
- `gin(how_to)`, `gin(need_search_queries)`（可选）

------

### 4.8 `daily_report`（当日日报：22:00 必推）

| 字段        | 类型        | 约束                  | 说明                           |
| ----------- | ----------- | --------------------- | ------------------------------ |
| id          | bigserial   | PK                    |                                |
| report_date | date        | UNIQUE, NOT NULL      | 北京时间自然日                 |
| digest_md   | text        | NOT NULL              | 当日浓缩资讯（markdown）       |
| digest_json | jsonb       | NOT NULL default '{}' | 可选：结构化 digest（便于 UI） |
| slots_done  | jsonb       | NOT NULL default '[]' | ["07:00","12:00"...]           |
| stats       | jsonb       | NOT NULL default '{}' | 总篇数/机会数/失败数等         |
| created_at  | timestamptz | NOT NULL              |                                |
| updated_at  | timestamptz | NOT NULL              |                                |

**索引**

- `index(report_date desc)`

> 22:00 运行时生成/更新当日记录，然后推送日报链接。

------

### 4.9 `notification_log`（推送记录：幂等与审计）

| 字段        | 类型        | 约束                  | 说明                       |
| ----------- | ----------- | --------------------- | -------------------------- |
| id          | bigserial   | PK                    |                            |
| report_date | date        | NOT NULL              |                            |
| slot        | varchar(5)  | NOT NULL              |                            |
| push_type   | varchar(16) | NOT NULL              | `opportunity` / `daily`    |
| msg_uuid    | varchar(64) | UNIQUE, NOT NULL      | 幂等键（同一推送不重复发） |
| target_url  | text        | NOT NULL              | 推送链接目标               |
| title       | text        | NOT NULL              | 消息标题                   |
| payload     | jsonb       | NOT NULL              | 发送体（markdown 等）      |
| response    | jsonb       | NOT NULL default '{}' | 钉钉返回                   |
| status      | smallint    | NOT NULL              | 0=失败 1=成功              |
| error       | text        |                       |                            |
| sent_at     | timestamptz | NOT NULL              |                            |

**幂等建议**

- `msg_uuid = sha1(report_date + slot + push_type + target_url)`
- 同一 `(report_date, slot, push_type)` 也可以加唯一约束（可选），但 `msg_uuid` 已足够。

**索引**

- `index(report_date desc, slot)`
- `index(status, sent_at desc)`

------

### 4.10 `audit_log`（可选：管理操作审计）

记录谁改了 prompt、改了阈值、手工触发任务等（不做也行，但建议留）。

------

## 5. 关键约束与幂等策略（务必落库）

### 5.1 “已分析不再分析”

- `analysis_result.unique(content_item_id)` + `content_item.analyzed_status`
- Worker 获取待分析列表时只取 `analyzed_status=0` 的文章。
- 即便任务重复触发：插入 `analysis_result` 会因 UNIQUE 失败而自然幂等（捕获冲突转为“已存在”）。

### 5.2 “同一时段不重复推送”

- `slot_run.unique(run_date, slot)` 确保一个时段只有一个 run 记录
- `notification_log.msg_uuid unique` 确保重复重试不会重复发

### 5.3 最近三天窗口

- WeRSS 的 `publish_time` 为 Unix 时间戳（秒），且建议在应用层筛选日期范围；文章列表默认按 publish_time 降序。

------

## 6. 索引策略（性能要点）

### 6.1 典型查询与索引对照

1. **今日机会列表**：按日期 + `score desc`

- 走 `analysis_result(created_at desc)` / `analysis_result(score desc)`
- 或 join `content_item(published_at)` 限定今日

1. **按机会类型过滤**：

- 走 `opportunity(type, created_at desc)`

1. **全文检索（标题/正文）**：

- `content_item` 上建 `tsvector` GIN 索引（可选，后期再上）

1. **日报页加载**：

- 直接 `daily_report` 一条记录 + 当天 `analysis_result` 列表（索引 created_at/report_date）

------

## 7. 数据保留与归档策略（建议默认值）

你目前每天 ≤10 篇文章，量很小，可以“全量长期保存”。但为了长期可控，建议：

- `content_item/raw_html/raw_text`：长期保留（用于回溯）
- `analysis_result/result_json`：长期保留（用于复盘 prompt 效果）
- `opportunity`：长期保留（便于统计）
- `slot_run`：保留 180 天（或更久）
- `notification_log`：保留 180 天
- `audit_log`：保留 180 天

> 清理策略做成一条维护任务（每周跑一次），后续文档 8（运维）会落脚本。

------

## 8. 安全与权限（数据库层）

### 8.1 账号权限

- 建议创建 DB 用户：
  - `radar_app`：仅拥有本 schema 的读写权限
  - 禁止使用超级用户连接应用

### 8.2 敏感信息

- **不建议**把 WeRSS Token 存数据库；WeRSS API 同机也需要 token 且 token 会过期（默认 3 天），应由 Worker 自动刷新并缓存到 Redis/内存。
- DeepSeek Key、钉钉 secret、WeRSS 账号密码：全部用环境变量/密钥文件注入（不入库）

------

## 9. DDL（可直接落库的建表草案）

> 下面是简化版示例（你实现时可用 Alembic/SQLAlchemy 生成）。
> **注意**：这里仅展示关键字段与约束，生产可补充 NOT NULL、默认值与触发器。

```sql
create table app_user (
  id bigserial primary key,
  username varchar(64) not null unique,
  password_hash varchar(255) not null,
  is_active boolean not null default true,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now(),
  last_login_at timestamptz
);

create table settings (
  key varchar(64) primary key,
  value_json jsonb not null,
  updated_at timestamptz not null default now()
);

create table prompt_version (
  id bigserial primary key,
  name varchar(64) not null,
  version int not null,
  is_active boolean not null default false,
  threshold int not null,
  prompt_text text not null,
  response_schema jsonb not null,
  created_at timestamptz not null default now(),
  unique (name, version)
);

create table slot_run (
  id bigserial primary key,
  run_date date not null,
  slot varchar(5) not null,
  window_start_at timestamptz not null,
  window_end_at timestamptz not null,
  status smallint not null,
  stats jsonb not null default '{}'::jsonb,
  started_at timestamptz not null default now(),
  finished_at timestamptz,
  error text,
  unique (run_date, slot)
);

create table content_item (
  id bigserial primary key,
  source_type varchar(32) not null,
  source_id varchar(64) not null default 'default',
  external_id varchar(255) not null unique,
  mp_id varchar(255),
  mp_name text,
  title text not null,
  url text,
  description text,
  pic_url text,
  published_at timestamptz not null,
  werss_publish_time bigint not null,
  status int not null default 1,
  raw_html text,
  raw_text text,
  content_hash char(64) not null,
  fetched_at timestamptz not null default now(),
  analyzed_status smallint not null default 0,
  analyzed_at timestamptz,
  meta jsonb not null default '{}'::jsonb
);

create index idx_content_published_at on content_item (published_at desc);
create index idx_content_mp_published on content_item (mp_id, published_at desc);
create index idx_content_analyzed_status on content_item (analyzed_status, published_at desc);

create table analysis_result (
  id bigserial primary key,
  content_item_id bigint not null references content_item(id) on delete cascade,
  run_id bigint references slot_run(id) on delete set null,
  prompt_version_id bigint not null references prompt_version(id),
  model varchar(64) not null,
  score int not null,
  has_opportunity boolean not null,
  result_json jsonb not null,
  summary_md text not null,
  created_at timestamptz not null default now(),
  unique (content_item_id)
);

create index idx_analysis_score on analysis_result (score desc);
create index idx_analysis_has_opp on analysis_result (has_opportunity, score desc);
create index idx_analysis_created_at on analysis_result (created_at desc);

create table opportunity (
  id bigserial primary key,
  analysis_id bigint not null references analysis_result(id) on delete cascade,
  idx int not null,
  type varchar(64) not null,
  title text not null,
  score_hint int,
  confidence numeric(4,3),
  time_window_start timestamptz,
  time_window_end timestamptz,
  how_to jsonb not null default '[]'::jsonb,
  constraints jsonb not null default '[]'::jsonb,
  need_search_queries jsonb not null default '[]'::jsonb,
  numbers jsonb not null default '{}'::jsonb,
  created_at timestamptz not null default now(),
  unique (analysis_id, idx)
);

create index idx_opp_type_created on opportunity (type, created_at desc);

create table daily_report (
  id bigserial primary key,
  report_date date not null unique,
  digest_md text not null,
  digest_json jsonb not null default '{}'::jsonb,
  slots_done jsonb not null default '[]'::jsonb,
  stats jsonb not null default '{}'::jsonb,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

create table notification_log (
  id bigserial primary key,
  report_date date not null,
  slot varchar(5) not null,
  push_type varchar(16) not null,
  msg_uuid varchar(64) not null unique,
  target_url text not null,
  title text not null,
  payload jsonb not null,
  response jsonb not null default '{}'::jsonb,
  status smallint not null,
  error text,
  sent_at timestamptz not null default now()
);

create index idx_notify_date_slot on notification_log (report_date desc, slot);
```

------

## 10. 与 WeRSS 字段映射（便于实现抓取入库）

WeRSS 的文章列表/详情返回字段中包含：

- `id`（文章 ID）、`mp_id`、`mp_name`、`title`、`url`、`description`、`content`（HTML）、`status`、`publish_time`（Unix 秒）、`created_at/updated_at` 等。

映射建议：

- `external_id` ← WeRSS `id`
- `werss_publish_time` ← WeRSS `publish_time`
- `published_at` ← `to_timestamp(publish_time)`（记得按秒）
- `raw_html` ← WeRSS `content`（只有 `has_content=true` 或 detail 才有）

------

如果你认可这份数据库设计，下一份我会输出 **第 6 份文档：Prompt 与输出 JSON Schema 文档**（会把两套 Prompt：`opportunity_analyzer` 与 `daily_digest` 的**完整提示词模板**、强制 JSON Schema、评分规则、阈值含义、字段解释、以及“发现机会就去上网搜索”的写法全部定死，方便你直接拿去实现）。