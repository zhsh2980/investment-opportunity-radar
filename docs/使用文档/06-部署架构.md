# 06 - 部署架构

## 6.1 容器服务

### 服务列表

| 容器名 | 服务 | 镜像 | 端口 | 说明 |
|--------|------|------|------|------|
| `radar-web` | FastAPI | 自建 | 8000 | Web 应用 |
| `radar-worker` | Celery Worker | 自建 | - | 异步任务执行 |
| `radar-beat` | Celery Beat | 自建 | - | 定时任务调度 |
| `radar-postgres` | PostgreSQL | postgres:15 | 5432 | 主数据库 |
| `radar-redis` | Redis | redis:7-alpine | 6379 | 消息队列 |

### 容器健康检查

| 容器 | 健康检查 |
|------|----------|
| postgres | `pg_isready -U radar` |
| redis | `redis-cli ping` |
| web | `curl -f http://localhost:8000/healthz` |

---

## 6.2 端口映射

### 内部网络

```
Docker Network: radar-network

┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  radar-web  │────▶│radar-postgres│◀────│radar-worker │
│   :8000     │     │    :5432     │     │             │
└─────────────┘     └─────────────┘     └─────────────┘
       │                   ▲                    │
       │                   │                    │
       │            ┌──────┴──────┐             │
       └───────────▶│ radar-redis │◀────────────┘
                    │    :6379    │
                    └─────────────┘
```

### 外部暴露

| 服务 | 内部端口 | 外部端口 | 说明 |
|------|----------|----------|------|
| Nginx | 80 | 8080 | 通过 Nginx 反向代理 |
| Web | 8000 | - | 不直接暴露 |
| PostgreSQL | 5432 | - | 仅内部访问 |
| Redis | 6379 | - | 仅内部访问 |

---

## 6.3 服务依赖

### 启动顺序

```
1. postgres (先启动, 等待健康)
       ↓
2. redis (并行启动, 等待健康)
       ↓
3. web, worker, beat (依赖前两者)
```

### 依赖关系图

```
postgres ──────┬──────▶ web
               │           
redis ─────────┼──────▶ worker
               │           
               └──────▶ beat
```

---

## 6.4 部署命令

### 首次部署

```bash
# 1. 克隆代码
git clone git@github.com:zhsh2980/investment-opportunity-radar.git
cd investment-opportunity-radar

# 2. 配置环境变量
cp .env.example .env
vim .env  # 编辑填入真实值

# 3. 启动服务
docker compose up -d --build

# 4. 初始化数据库
docker exec radar-web python src/manage.py init-db

# 5. 检查服务状态
docker compose ps
```

### 更新部署

```bash
# 拉取最新代码
git pull origin main

# 重新构建并启动
docker compose up -d --build web worker beat

# 如有数据库变更
docker exec radar-postgres psql -U radar -d radar -c "ALTER TABLE ..."
```

### 常用运维命令

```bash
# 查看日志
docker compose logs -f web
docker compose logs -f worker

# 重启服务
docker compose restart web

# 进入容器
docker exec -it radar-web bash
docker exec -it radar-postgres psql -U radar -d radar

# 查看 Celery 任务队列
docker exec radar-worker celery -A src.app.celery_app inspect active
```

---

## 6.5 生产环境建议

### 安全加固

| 项目 | 建议 |
|------|------|
| HTTPS | 使用 Nginx + Let's Encrypt |
| 防火墙 | 仅开放 80/443 端口 |
| 数据库 | 不暴露外部端口 |
| 密钥 | 使用强密码, 定期轮换 |

### 性能优化

| 项目 | 建议 |
|------|------|
| Web 并发 | 增加 Gunicorn workers |
| Worker 并发 | 调整 Celery concurrency |
| 数据库 | 添加连接池, 索引优化 |
| 缓存 | 更多使用 Redis 缓存 |

### 监控告警

| 项目 | 工具建议 |
|------|----------|
| 容器状态 | Docker stats / Portainer |
| 日志 | ELK / Loki |
| 告警 | 钉钉 Webhook / Prometheus |

---

## 6.6 服务器信息

### 当前部署服务器

| 项目 | 值 |
|------|-----|
| IP | 154.8.205.159 |
| 端口 | 8080 (Nginx) |
| 路径 | /srv/opportunity-insight/ |
| 用户 | ubuntu |

### 目录结构

```
/srv/opportunity-insight/
├── app/                    # 代码目录 (git clone)
├── docker-compose.yml      # 编排文件
├── .env                    # 环境变量
└── data/                   # 持久化数据
    ├── postgres/
    └── redis/
```
