# 05 - 配置说明

## 5.1 环境变量

### 完整环境变量列表

| 变量名 | 必填 | 默认值 | 说明 |
|--------|------|--------|------|
| `DATABASE_URL` | ✅ | - | PostgreSQL 连接串 |
| `REDIS_URL` | ✅ | - | Redis 连接串 |
| `WERSS_BASE_URL` | ✅ | - | WeRSS API 地址 |
| `WERSS_USERNAME` | ✅ | - | WeRSS 用户名 |
| `WERSS_PASSWORD` | ✅ | - | WeRSS 密码 |
| `DEEPSEEK_API_KEY` | ✅ | - | DeepSeek API Key |
| `DEEPSEEK_BASE_URL` | | `https://api.deepseek.com` | DeepSeek API 地址 |
| `DINGTALK_WEBHOOK` | ✅ | - | 钉钉 Webhook URL |
| `DINGTALK_SECRET` | ✅ | - | 钉钉加签密钥 |
| `SECRET_KEY` | ✅ | - | 会话加密密钥 |
| `ADMIN_USERNAME` | | `admin` | 管理员用户名 |
| `ADMIN_PASSWORD` | ✅ | - | 管理员密码 |

### 示例 `.env` 文件

```bash
# 数据库
DATABASE_URL=postgresql://radar:radar_secret@postgres:5432/radar
POSTGRES_DB=radar
POSTGRES_USER=radar
POSTGRES_PASSWORD=radar_secret

# Redis
REDIS_URL=redis://redis:6379/0

# WeRSS
WERSS_BASE_URL=http://your-werss-server:8080
WERSS_USERNAME=your_username
WERSS_PASSWORD=your_password

# DeepSeek
DEEPSEEK_API_KEY=sk-xxxxxxxxxxxx
DEEPSEEK_BASE_URL=https://api.deepseek.com

# 钉钉
DINGTALK_WEBHOOK=https://oapi.dingtalk.com/robot/send?access_token=xxxxx
DINGTALK_SECRET=SECxxxxxx

# 安全
SECRET_KEY=your-super-secret-key-at-least-32-chars

# 管理员
ADMIN_USERNAME=admin
ADMIN_PASSWORD=YourSecurePassword123
```

---

## 5.2 配置文件

### docker-compose.yml 关键配置

```yaml
services:
  web:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      # ... 其他环境变量
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  worker:
    build: .
    command: celery -A src.app.celery_app worker --loglevel=info
    environment:
      # 与 web 相同
    depends_on:
      - redis
      - postgres

  beat:
    build: .
    command: celery -A src.app.celery_app beat --loglevel=info
    depends_on:
      - redis
```

### Nginx 配置 (`nginx/default.conf`)

```nginx
server {
    listen 80;
    server_name _;

    location / {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /static/ {
        alias /app/src/app/web/static/;
    }
}
```

---

## 5.3 敏感信息

### 敏感文件位置

| 文件 | 内容 | 权限建议 |
|------|------|----------|
| `.env` | 所有敏感环境变量 | 600 (仅所有者读写) |
| `docs/key/` | SSH 密钥等 | 600 |

### 敏感信息清单

| 信息 | 来源 | 用途 |
|------|------|------|
| `WERSS_PASSWORD` | WeRSS 后台 | 获取文章 |
| `DEEPSEEK_API_KEY` | DeepSeek 控制台 | AI 分析 |
| `DINGTALK_SECRET` | 钉钉机器人设置 | 消息签名 |
| `SECRET_KEY` | 自行生成 | 会话加密 |
| `ADMIN_PASSWORD` | 自行设置 | 登录系统 |

### 生成密钥命令

```bash
# 生成 SECRET_KEY
python -c "import secrets; print(secrets.token_urlsafe(32))"

# 生成安全密码
python -c "import secrets; print(secrets.token_urlsafe(16))"
```

---

## 5.4 配置优先级

```
环境变量 > .env 文件 > 代码默认值
```

### 配置加载代码位置

`src/app/core/config.py`:

```python
class Settings(BaseSettings):
    database_url: str
    redis_url: str
    werss_base_url: str
    # ...
    
    class Config:
        env_file = ".env"
```
