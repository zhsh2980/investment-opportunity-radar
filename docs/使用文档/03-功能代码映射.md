# 03 - 功能代码映射

## 3.1 Web 页面路由

### 页面路由表

| 页面 | URL | 路由文件 | 函数名 | 模板文件 |
|------|-----|----------|--------|----------|
| 登录页 | `/login` | `main.py` | `login_page` | `login.html` |
| 首页 Dashboard | `/` | `routers/pages.py` | `dashboard` | `pages/dashboard.html` |
| 日报页 | `/daily/{date}` | `routers/pages.py` | `daily_report` | `pages/daily.html` |
| 日报重定向 | `/daily/` | `routers/pages.py` | `daily_redirect` | - (重定向) |
| 分析详情页 | `/analysis/{id}` | `routers/pages.py` | `analysis_detail` | `pages/analysis.html` |
| 历史列表页 | `/history` | `routers/pages.py` | `history` | `pages/history.html` |
| Prompt 管理页 | `/prompts` | `routers/pages.py` | `prompts_page` | `pages/prompts.html` |
| 设置页 | `/settings` | `routers/pages.py` | `settings_page` | `pages/settings.html` |

### 路由文件位置

```
src/app/
├── main.py                      # /login 路由
└── web/routers/
    ├── pages.py                 # 所有页面路由
    ├── auth.py                  # 认证 API
    └── admin.py                 # 管理 API
```

---

## 3.2 API 端点

### 认证 API (`routers/auth.py`)

| 端点 | 方法 | 函数名 | 说明 |
|------|------|--------|------|
| `/api/auth/login` | POST | `login` | 用户登录 |
| `/api/auth/logout` | POST | `logout` | 退出登录 |
| `/api/auth/me` | GET | `me` | 获取当前用户 |

### 设置 API (`routers/admin.py`)

| 端点 | 方法 | 函数名 | 说明 |
|------|------|--------|------|
| `/api/settings` | GET | `get_settings` | 获取设置 |
| `/api/settings` | POST | `update_settings` | 更新设置 |

### Prompt API (`routers/admin.py`)

| 端点 | 方法 | 函数名 | 说明 |
|------|------|--------|------|
| `/api/prompts` | POST | `create_prompt` | 创建新版本 |
| `/api/prompts/{id}` | GET | `get_prompt` | 获取详情 |
| `/api/prompts/{id}/activate` | POST | `activate_prompt` | 激活版本 |

### 分析 API (`routers/admin.py`)

| 端点 | 方法 | 函数名 | 说明 |
|------|------|--------|------|
| `/api/analyses` | GET | `list_analyses` | 分析列表 (分页) |
| `/api/analyses/{id}` | GET | `get_analysis` | 分析详情 |
| `/api/analyses/{id}/status` | PUT | `update_analysis_status` | 更新执行状态 |

### 导出 API (`routers/admin.py`)

| 端点 | 方法 | 函数名 | 说明 |
|------|------|--------|------|
| `/api/export/analyses` | GET | `export_analyses` | 导出 JSON/CSV |

**参数**:
- `format`: `json` 或 `csv`
- `start_date`: 开始日期 (YYYY-MM-DD)
- `end_date`: 结束日期
- `min_score`: 最低分数

---

## 3.3 后台任务

### Celery 任务 (`tasks/slot_task.py`)

| 任务函数 | 说明 | 触发方式 |
|----------|------|----------|
| `slot_task` | 某个时段的抓取+分析任务 | Celery Beat 定时 |
| `analyze_single_article` | 分析单篇文章 | 被 slot_task 调用 |

### 定时调度配置 (`celery_app.py`)

```python
app.conf.beat_schedule = {
    'slot-07': {'task': 'slot_task', 'schedule': crontab(hour=7, minute=0), 'args': ('07:00',)},
    'slot-12': {'task': 'slot_task', 'schedule': crontab(hour=12, minute=0), 'args': ('12:00',)},
    'slot-14': {'task': 'slot_task', 'schedule': crontab(hour=14, minute=0), 'args': ('14:00',)},
    'slot-18': {'task': 'slot_task', 'schedule': crontab(hour=18, minute=0), 'args': ('18:00',)},
    'slot-22': {'task': 'slot_task', 'schedule': crontab(hour=22, minute=0), 'args': ('22:00',)},
}
```

---

## 3.4 外部服务客户端

### 客户端文件位置

```
src/app/clients/
├── werss.py      # WeRSS API 客户端
├── deepseek.py   # DeepSeek API 客户端
└── dingtalk.py   # 钉钉推送客户端
```

### WeRSS 客户端 (`clients/werss.py`)

| 方法 | 说明 |
|------|------|
| `get_articles()` | 获取文章列表 |
| `get_article_detail()` | 获取文章详情 |
| `refresh_token()` | 刷新 Token |

### DeepSeek 客户端 (`clients/deepseek.py`)

| 方法 | 说明 |
|------|------|
| `analyze_article()` | 分析文章内容 |
| `_parse_response()` | 解析 AI 响应 |

### 钉钉客户端 (`clients/dingtalk.py`)

| 方法 | 说明 |
|------|------|
| `send_opportunity()` | 发送机会通知 |
| `send_daily_report()` | 发送日报 |
| `_sign()` | 生成签名 |

---

## 3.5 业务服务

### 服务文件位置

```
src/app/services/
├── analyzer.py       # 分析服务
└── daily_report.py   # 日报生成服务
```

| 服务 | 文件 | 主要方法 |
|------|------|----------|
| 分析服务 | `analyzer.py` | `analyze_and_save()` |
| 日报服务 | `daily_report.py` | `generate_daily_report()` |

---

## 3.6 核心模块

### 认证安全 (`core/security.py`)

| 函数 | 说明 |
|------|------|
| `hash_password()` | 密码哈希 |
| `verify_password()` | 验证密码 |
| `create_session_token()` | 创建会话 Token |
| `verify_session_token()` | 验证会话 Token |

### 配置加载 (`core/config.py`)

| 函数/类 | 说明 |
|---------|------|
| `Settings` | Pydantic 配置模型 |
| `get_settings()` | 获取配置单例 |

---

## 3.7 模板与样式

### 模板继承关系

```
base.html (基础布局)
├── login.html
└── pages/
    ├── dashboard.html
    ├── daily.html
    ├── analysis.html
    ├── history.html
    ├── prompts.html
    └── settings.html
```

### CSS 文件分工

| 文件 | 内容 |
|------|------|
| `app.css` | CSS 变量、登录页、基础组件 |
| `pages.css` | 导航栏、各页面布局、表格、卡片 |

---

## 3.8 推送逻辑

### 核心代码位置

| 文件 | 函数 | 说明 |
|------|------|------|
| `tasks/slot.py` | `execute_slot()` | 定时/手动分析主流程 |
| `services/analyzer.py` | `should_push_opportunity()` | 判断是否推送 |
| `services/analyzer.py` | `push_opportunity_alert()` | 推送机会通知 |
| `services/analyzer.py` | `push_manual_summary()` | 手动分析无机会时的汇总通知 |
| `services/analyzer.py` | `push_no_opportunity_today()` | 最后一次定时无机会时的通知 |
| `services/analyzer.py` | `generate_and_push_daily_report()` | 日报推送 |

### 推送策略汇总

| 场景 | 分析方式 | 有机会时 | 无机会时 |
|------|----------|----------|----------|
| **非最后一次定时** | 逐篇分析 | **立即推送** | 不发任何通知 |
| **最后一次定时** | 逐篇分析 | **立即推送** | 发送"今日暂无机会"通知 |
| **最后一次定时** | - | - | **必发日报**（无论有无机会） |
| **手动分析** | 逐篇分析 | **立即推送** | 发送"没有发现机会"通知 |

### 推送条件 (`should_push_opportunity`)

文章必须同时满足以下条件才会触发推送：

```python
1. slot != 最后一个时间点  # 最后时间点的机会通知在分析中处理
2. score >= threshold       # 默认阈值 60 分
3. has_opportunity == True  # AI 判断有投资机会
4. 当天已推送次数 < 4       # 每天最多推 4 条
```

### 流程图

```
定时/手动触发
    ↓
获取文章 (WeRSS)
    ↓
【循环】逐篇 AI 分析 (DeepSeek)
    │
    ├─ 有机会 且 满足推送条件？
    │      └─ 是 → 【立即推送】机会通知
    │
    └─ 继续分析下一篇...
    ↓
分析全部完成
    ↓
判断场景：
    ├─ 最后一次定时：
    │      ├─ 无机会 → 发送"今日暂无机会"通知
    │      └─ 必发日报
    ├─ 手动模式：
    │      └─ 无机会 → 发送汇总通知
    └─ 非最后一次定时：
           └─ 无机会 → 不发任何通知
```

### 分析前正文检查

在分析每篇文章前，会检查是否有正文内容：

| 函数 | 说明 |
|------|------|
| `has_content(item)` | 检查文章是否有正文（raw_text > 50字符 或 raw_html > 100字符） |
| `try_refresh_content(session, item)` | 调用 WeRSS API 重新获取正文并更新数据库 |

**流程**：
```
检查本地正文
    ├─ 有正文 → 正常分析
    └─ 无正文 → 调用 WeRSS API 重新获取
                    ├─ 获取到正文 → 更新数据库 → 分析
                    └─ 仍无正文 → 跳过（不标记已分析，下次继续尝试）
```

**设计原因**：WeRSS 可能延迟获取正文，跳过而不标记已分析可以在后续定时任务中重试。
