# 03 - 功能代码映射

## 3.1 Web 页面路由

### 页面路由表

| 页面 | URL | 路由文件 | 函数名 | 模板文件 |
|------|-----|----------|--------|----------|
| 登录页 | `/login` | `main.py` | `login_page` | `login.html` |
| 首页 Dashboard | `/` | `routers/pages.py` | `dashboard` | `pages/dashboard.html` |
| 日报页 | `/daily/{date}` | `routers/pages.py` | `daily_report` | `pages/daily.html` |
| 日报重定向 | `/daily/` | `routers/pages.py` | `daily_redirect` | - (重定向) |
| 分析详情页 | `/analysis/{id}` | `routers/pages.py` | `analysis_detail` | `pages/analysis.html` |
| 历史列表页 | `/history` | `routers/pages.py` | `history` | `pages/history.html` |
| Prompt 管理页 | `/prompts` | `routers/pages.py` | `prompts_page` | `pages/prompts.html` |
| 设置页 | `/settings` | `routers/pages.py` | `settings_page` | `pages/settings.html` |

### 路由文件位置

```
src/app/
├── main.py                      # /login 路由
└── web/routers/
    ├── pages.py                 # 所有页面路由
    ├── auth.py                  # 认证 API
    └── admin.py                 # 管理 API
```

---

## 3.2 API 端点

### 认证 API (`routers/auth.py`)

| 端点 | 方法 | 函数名 | 说明 |
|------|------|--------|------|
| `/api/auth/login` | POST | `login` | 用户登录 |
| `/api/auth/logout` | POST | `logout` | 退出登录 |
| `/api/auth/me` | GET | `me` | 获取当前用户 |

### 设置 API (`routers/admin.py`)

| 端点 | 方法 | 函数名 | 说明 |
|------|------|--------|------|
| `/api/settings` | GET | `get_settings` | 获取设置 |
| `/api/settings` | POST | `update_settings` | 更新设置 |

### Prompt API (`routers/admin.py`)

| 端点 | 方法 | 函数名 | 说明 |
|------|------|--------|------|
| `/api/prompts` | POST | `create_prompt` | 创建新版本 |
| `/api/prompts/{id}` | GET | `get_prompt` | 获取详情 |
| `/api/prompts/{id}/activate` | POST | `activate_prompt` | 激活版本 |

### 分析 API (`routers/admin.py`)

| 端点 | 方法 | 函数名 | 说明 |
|------|------|--------|------|
| `/api/analyses` | GET | `list_analyses` | 分析列表 (分页) |
| `/api/analyses/{id}` | GET | `get_analysis` | 分析详情 |
| `/api/analyses/{id}/status` | PUT | `update_analysis_status` | 更新执行状态 |

### 导出 API (`routers/admin.py`)

| 端点 | 方法 | 函数名 | 说明 |
|------|------|--------|------|
| `/api/export/analyses` | GET | `export_analyses` | 导出 JSON/CSV |

**参数**:
- `format`: `json` 或 `csv`
- `start_date`: 开始日期 (YYYY-MM-DD)
- `end_date`: 结束日期
- `min_score`: 最低分数

---

## 3.3 后台任务

### Celery 任务 (`tasks/slot_task.py`)

| 任务函数 | 说明 | 触发方式 |
|----------|------|----------|
| `slot_task` | 某个时段的抓取+分析任务 | Celery Beat 定时 |
| `analyze_single_article` | 分析单篇文章 | 被 slot_task 调用 |

### 定时调度配置 (`celery_app.py`)

```python
app.conf.beat_schedule = {
    'slot-07': {'task': 'slot_task', 'schedule': crontab(hour=7, minute=0), 'args': ('07:00',)},
    'slot-12': {'task': 'slot_task', 'schedule': crontab(hour=12, minute=0), 'args': ('12:00',)},
    'slot-14': {'task': 'slot_task', 'schedule': crontab(hour=14, minute=0), 'args': ('14:00',)},
    'slot-18': {'task': 'slot_task', 'schedule': crontab(hour=18, minute=0), 'args': ('18:00',)},
    'slot-22': {'task': 'slot_task', 'schedule': crontab(hour=22, minute=0), 'args': ('22:00',)},
}
```

---

## 3.4 外部服务客户端

### 客户端文件位置

```
src/app/clients/
├── werss.py      # WeRSS API 客户端
├── deepseek.py   # DeepSeek API 客户端
└── dingtalk.py   # 钉钉推送客户端
```

### WeRSS 客户端 (`clients/werss.py`)

| 方法 | 说明 |
|------|------|
| `get_articles()` | 获取文章列表 |
| `get_article_detail()` | 获取文章详情 |
| `refresh_token()` | 刷新 Token |

### DeepSeek 客户端 (`clients/deepseek.py`)

| 方法 | 说明 |
|------|------|
| `analyze_article()` | 分析文章内容 |
| `_parse_response()` | 解析 AI 响应 |

### 钉钉客户端 (`clients/dingtalk.py`)

| 方法 | 说明 |
|------|------|
| `send_opportunity()` | 发送机会通知 |
| `send_daily_report()` | 发送日报 |
| `_sign()` | 生成签名 |

---

## 3.5 业务服务

### 服务文件位置

```
src/app/services/
├── analyzer.py       # 分析服务
└── daily_report.py   # 日报生成服务
```

| 服务 | 文件 | 主要方法 |
|------|------|----------|
| 分析服务 | `analyzer.py` | `analyze_and_save()` |
| 日报服务 | `daily_report.py` | `generate_daily_report()` |

---

## 3.6 核心模块

### 认证安全 (`core/security.py`)

| 函数 | 说明 |
|------|------|
| `hash_password()` | 密码哈希 |
| `verify_password()` | 验证密码 |
| `create_session_token()` | 创建会话 Token |
| `verify_session_token()` | 验证会话 Token |

### 配置加载 (`core/config.py`)

| 函数/类 | 说明 |
|---------|------|
| `Settings` | Pydantic 配置模型 |
| `get_settings()` | 获取配置单例 |

---

## 3.7 模板与样式

### 模板继承关系

```
base.html (基础布局)
├── login.html
└── pages/
    ├── dashboard.html
    ├── daily.html
    ├── analysis.html
    ├── history.html
    ├── prompts.html
    └── settings.html
```

### CSS 文件分工

| 文件 | 内容 |
|------|------|
| `app.css` | CSS 变量、登录页、基础组件 |
| `pages.css` | 导航栏、各页面布局、表格、卡片 |
