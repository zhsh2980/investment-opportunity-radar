# 07 - 开发指南

## 7.1 本地开发环境

### 环境要求

| 工具 | 版本 | 用途 |
|------|------|------|
| Python | 3.11+ | 主语言 |
| Docker | 20+ | 容器运行 |
| Docker Compose | 2.0+ | 容器编排 |
| Git | 2.0+ | 版本控制 |

### 快速启动

```bash
# 1. 克隆仓库
git clone git@github.com:zhsh2980/investment-opportunity-radar.git
cd investment-opportunity-radar

# 2. 创建虚拟环境
python -m venv venv
source venv/bin/activate  # Mac/Linux
# venv\Scripts\activate   # Windows

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置环境变量
cp .env.example .env
# 编辑 .env 填入配置

# 5. 启动依赖服务 (PostgreSQL + Redis)
docker compose up -d postgres redis

# 6. 初始化数据库
python src/manage.py init-db

# 7. 启动开发服务器
uvicorn src.app.main:app --reload --host 0.0.0.0 --port 8000
```

### 启动 Celery (可选)

```bash
# 新开终端, 启动 Worker
celery -A src.app.celery_app worker --loglevel=info

# 新开终端, 启动 Beat (定时任务)
celery -A src.app.celery_app beat --loglevel=info
```

---

## 7.2 常用命令

### 开发命令

| 命令 | 说明 |
|------|------|
| `uvicorn src.app.main:app --reload` | 启动开发服务器 |
| `python -m py_compile src/app/main.py` | 语法检查 |
| `python src/manage.py init-db` | 初始化数据库 |
| `python src/manage.py init-prompts` | 初始化 Prompts |

### Docker 命令

| 命令 | 说明 |
|------|------|
| `docker compose up -d` | 启动所有服务 |
| `docker compose up -d --build web` | 重建并启动 web |
| `docker compose logs -f web` | 查看 web 日志 |
| `docker compose ps` | 查看服务状态 |
| `docker compose down` | 停止所有服务 |

### Git 命令

| 命令 | 说明 |
|------|------|
| `git add . && git commit -m "msg"` | 提交 |
| `git push origin main` | 推送 |
| `git pull origin main` | 拉取 |

### 数据库命令

```bash
# 进入 PostgreSQL
docker exec -it radar-postgres psql -U radar -d radar

# 常用 SQL
\dt                           # 列出所有表
\d+ analysis_result           # 查看表结构
SELECT COUNT(*) FROM content_item;  # 统计
```

---

## 7.3 调试技巧

### 查看请求日志

```python
# 在 main.py 添加
import logging
logging.basicConfig(level=logging.DEBUG)
```

### 调试 Celery 任务

```bash
# 前台运行 Worker (带详细日志)
celery -A src.app.celery_app worker --loglevel=debug

# 手动触发任务
python -c "from src.app.tasks.slot_task import slot_task; slot_task.delay('07:00')"
```

### 调试数据库查询

```python
# 在代码中打印 SQL
import logging
logging.getLogger('sqlalchemy.engine').setLevel(logging.DEBUG)
```

### 常见问题排查

| 问题 | 排查方法 |
|------|----------|
| 页面 500 错误 | 查看 `docker compose logs web` |
| 任务未执行 | 检查 Worker 日志, Beat 是否运行 |
| 数据库连接失败 | 检查 DATABASE_URL, PostgreSQL 是否启动 |
| 登录失败 | 检查用户是否创建, 密码是否正确 |

---

## 7.4 代码规范

### 文件命名

- Python 文件: `snake_case.py`
- 类名: `PascalCase`
- 函数/变量: `snake_case`
- 常量: `UPPER_CASE`

### 目录约定

| 目录 | 放什么 |
|------|--------|
| `domain/` | 数据模型 |
| `clients/` | 外部服务客户端 |
| `services/` | 业务逻辑 |
| `tasks/` | Celery 任务 |
| `web/routers/` | API/页面路由 |
| `web/templates/` | Jinja2 模板 |
| `web/static/` | 静态资源 |

### 注释规范

```python
def analyze_article(article_id: int) -> dict:
    """
    分析单篇文章
    
    Args:
        article_id: 文章 ID
        
    Returns:
        分析结果字典
    """
    pass
```

---

## 7.5 添加新功能指南

### 添加新页面

1. **添加路由** (`web/routers/pages.py`)
   ```python
   @router.get("/new-page", response_class=HTMLResponse)
   async def new_page(request: Request, db: Session = Depends(get_db)):
       return templates.TemplateResponse("pages/new_page.html", {...})
   ```

2. **创建模板** (`web/templates/pages/new_page.html`)
   ```html
   {% extends "base.html" %}
   {% block content %}
   <div class="new-page">...</div>
   {% endblock %}
   ```

3. **添加样式** (`web/static/pages.css`)
   ```css
   .new-page { ... }
   ```

4. **更新导航** (`web/templates/base.html`)

### 添加新 API

1. **在 `admin.py` 添加端点**
2. **定义 Pydantic 模型** (请求/响应)
3. **实现业务逻辑**
4. **更新文档**

### 添加新数据表

1. **定义模型** (`domain/models.py`)
2. **添加到 `__all__`**
3. **创建迁移** (手动 ALTER TABLE 或使用 Alembic)
4. **更新文档**

### 添加新定时任务

1. **创建任务函数** (`tasks/new_task.py`)
2. **在 `celery_app.py` 添加调度**
   ```python
   'new-task': {
       'task': 'new_task',
       'schedule': crontab(hour=8, minute=0),
   }
   ```
3. **重启 Beat**

---

## 7.6 测试

### 手动测试

```bash
# 测试登录
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "xxx"}'

# 测试 API
curl http://localhost:8000/api/settings \
  -H "Cookie: session_token=xxx"
```

### 健康检查

```bash
curl http://localhost:8000/healthz
# 返回: {"status": "ok", ...}
```
