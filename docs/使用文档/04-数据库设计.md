# 04 - 数据库设计

## 4.1 ER 图

```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│    app_user     │      │   slot_run      │      │  prompt_version │
├─────────────────┤      ├─────────────────┤      ├─────────────────┤
│ id (PK)         │      │ id (PK)         │      │ id (PK)         │
│ username        │      │ slot            │      │ name            │
│ password_hash   │      │ run_date        │      │ version         │
│ created_at      │      │ status          │      │ system_prompt   │
└─────────────────┘      │ articles_found  │      │ user_template   │
                         │ articles_analyzed│     │ threshold       │
                         │ opportunities    │      │ is_active       │
                         └────────┬────────┘      │ created_at      │
                                  │               └────────┬────────┘
                                  │                        │
                                  │                        │
┌─────────────────┐      ┌───────▼────────┐      ┌────────▼────────┐
│  content_item   │◀─────│ analysis_result│──────▶│   opportunity   │
├─────────────────┤      ├────────────────┤      ├─────────────────┤
│ id (PK)         │      │ id (PK)        │      │ id (PK)         │
│ biz_id (UK)     │      │ content_item_id│      │ analysis_id (FK)│
│ title           │      │ run_id (FK)    │      │ idx             │
│ mp_name         │      │ prompt_version │      │ title           │
│ url             │      │ model          │      │ score           │
│ raw_html        │      │ score          │      │ opportunity_type│
│ raw_text        │      │ has_opportunity│      │ summary         │
│ published_at    │      │ result_json    │      │ action_steps    │
│ fetched_at      │      │ summary_md     │      │ time_window     │
└─────────────────┘      │ action_status  │      │ key_numbers     │
                         │ created_at     │      │ constraints     │
                         └────────────────┘      │ evidence_json   │
                                                 └─────────────────┘

┌─────────────────┐      ┌─────────────────┐
│  daily_report   │      │    push_log     │
├─────────────────┤      ├─────────────────┤
│ id (PK)         │      │ id (PK)         │
│ report_date(UK) │      │ ref_type        │
│ digest_md       │      │ ref_id          │
│ summary         │      │ channel         │
│ created_at      │      │ pushed_at       │
└─────────────────┘      │ success         │
                         │ error_msg       │
┌─────────────────┐      └─────────────────┘
│    settings     │
├─────────────────┤
│ id (PK)         │
│ key (UK)        │
│ value_json      │
│ updated_at      │
└─────────────────┘
```

---

## 4.2 表结构说明

### 4.2.1 app_user (用户表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT | PK | 主键 |
| username | VARCHAR(64) | UNIQUE, NOT NULL | 用户名 |
| password_hash | VARCHAR(128) | NOT NULL | 密码哈希 (bcrypt) |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |

**代码位置**: `src/app/domain/models.py` - `AppUser`

---

### 4.2.2 content_item (文章内容表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT | PK | 主键 |
| biz_id | VARCHAR(64) | UNIQUE | WeRSS 文章 ID |
| title | VARCHAR(512) | NOT NULL | 文章标题 |
| mp_name | VARCHAR(128) | | 公众号名称 |
| url | TEXT | | 原文链接 |
| raw_html | TEXT | | 原始 HTML |
| raw_text | TEXT | | 纯文本 |
| published_at | TIMESTAMP | NOT NULL | 发布时间 |
| fetched_at | TIMESTAMP | NOT NULL | 抓取时间 |

**索引**: `idx_content_biz_id`, `idx_content_published`

**代码位置**: `src/app/domain/models.py` - `ContentItem`

---

### 4.2.3 analysis_result (分析结果表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT | PK | 主键 |
| content_item_id | BIGINT | FK, UNIQUE | 关联文章 (1:1) |
| run_id | BIGINT | FK | 关联运行批次 |
| prompt_version_id | BIGINT | FK | 使用的 Prompt 版本 |
| model | VARCHAR(64) | NOT NULL | AI 模型名 |
| score | INTEGER | NOT NULL | 机会评分 (0-100) |
| has_opportunity | BOOLEAN | NOT NULL | 是否有机会 |
| result_json | JSON | NOT NULL | 完整分析结果 |
| summary_md | TEXT | NOT NULL | 一句话总结 |
| action_status | VARCHAR(32) | | 执行状态 |
| created_at | TIMESTAMP | NOT NULL | 分析时间 |

**action_status 可选值**:
- `pending` - 待处理
- `executed` - 已执行
- `skipped` - 不执行
- `watching` - 观望中

**索引**: `idx_analysis_score`, `idx_analysis_has_opp`, `idx_analysis_created_at`

**代码位置**: `src/app/domain/models.py` - `AnalysisResult`

---

### 4.2.4 opportunity (机会点表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT | PK | 主键 |
| analysis_id | BIGINT | FK | 关联分析结果 |
| idx | INTEGER | NOT NULL | 排序序号 |
| title | VARCHAR(256) | NOT NULL | 机会标题 |
| score | INTEGER | NOT NULL | 单项评分 |
| opportunity_type | VARCHAR(64) | | 机会类型 |
| summary | TEXT | | 简要说明 |
| action_steps | JSON | | 行动步骤 (数组) |
| time_window | JSON | | 时间窗口 |
| key_numbers | JSON | | 关键数字 |
| constraints | JSON | | 约束条件 |
| evidence_json | JSON | | 原文证据 |

**代码位置**: `src/app/domain/models.py` - `Opportunity`

---

### 4.2.5 slot_run (任务运行记录表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT | PK | 主键 |
| slot | VARCHAR(8) | NOT NULL | 时段 (07:00 等) |
| run_date | DATE | NOT NULL | 运行日期 |
| status | VARCHAR(16) | NOT NULL | 状态 |
| started_at | TIMESTAMP | | 开始时间 |
| finished_at | TIMESTAMP | | 结束时间 |
| articles_found | INTEGER | | 发现文章数 |
| articles_analyzed | INTEGER | | 分析文章数 |
| opportunities_found | INTEGER | | 发现机会数 |
| error_msg | TEXT | | 错误信息 |

**status 可选值**: `pending`, `running`, `success`, `failed`

**唯一约束**: `(slot, run_date)`

**代码位置**: `src/app/domain/models.py` - `SlotRun`

---

### 4.2.6 daily_report (日报表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT | PK | 主键 |
| report_date | DATE | UNIQUE | 报告日期 |
| digest_md | TEXT | | Markdown 日报内容 |
| summary | TEXT | | 简要总结 |
| created_at | TIMESTAMP | NOT NULL | 生成时间 |

**代码位置**: `src/app/domain/models.py` - `DailyReport`

---

### 4.2.7 prompt_version (Prompt 版本表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT | PK | 主键 |
| name | VARCHAR(64) | NOT NULL | Prompt 名称 |
| version | INTEGER | NOT NULL | 版本号 |
| system_prompt | TEXT | NOT NULL | 系统提示词 |
| user_template | TEXT | NOT NULL | 用户提示词模板 |
| threshold | INTEGER | | 推送阈值 |
| is_active | BOOLEAN | NOT NULL | 是否激活 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |

**唯一约束**: `(name, version)`

**代码位置**: `src/app/domain/models.py` - `PromptVersion`

---

### 4.2.8 settings (系统设置表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT | PK | 主键 |
| key | VARCHAR(64) | UNIQUE | 设置键名 |
| value_json | JSON | NOT NULL | 设置值 |
| updated_at | TIMESTAMP | | 更新时间 |

**常用 key**:
- `push_score_threshold` - 推送阈值 (默认 60)
- `remember_me_days` - 登录记住天数 (默认 30)
- `window_days` - 分析窗口天数 (默认 3)

**代码位置**: `src/app/domain/models.py` - `Settings`

---

### 4.2.9 push_log (推送日志表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | BIGINT | PK | 主键 |
| ref_type | VARCHAR(32) | NOT NULL | 引用类型 (analysis/daily) |
| ref_id | BIGINT | NOT NULL | 引用 ID |
| channel | VARCHAR(32) | NOT NULL | 渠道 (dingtalk) |
| pushed_at | TIMESTAMP | NOT NULL | 推送时间 |
| success | BOOLEAN | NOT NULL | 是否成功 |
| error_msg | TEXT | | 错误信息 |

**唯一约束**: `(ref_type, ref_id, channel)` - 防止重复推送

**代码位置**: `src/app/domain/models.py` - `PushLog`

---

## 4.3 表关系

```
app_user          (独立)
settings          (独立)
prompt_version    (独立, 被 analysis_result 引用)
daily_report      (独立)

content_item  ─1:1─►  analysis_result  ─1:N─►  opportunity
                            │
                            ▼
                        slot_run

push_log          (引用 analysis_result 或 daily_report)
```

---

## 4.4 常用查询示例

### 获取今日高分机会

```sql
SELECT ar.id, ar.score, ar.summary_md, ci.title, ci.mp_name
FROM analysis_result ar
JOIN content_item ci ON ar.content_item_id = ci.id
WHERE ar.has_opportunity = true
  AND ar.score >= 60
  AND DATE(ci.published_at) = CURRENT_DATE
ORDER BY ar.score DESC;
```

### 获取某日的运行状态

```sql
SELECT slot, status, articles_found, opportunities_found
FROM slot_run
WHERE run_date = '2026-01-09'
ORDER BY slot;
```

### 统计各评分区间的文章数

```sql
SELECT 
    CASE 
        WHEN score >= 80 THEN '高分 (80+)'
        WHEN score >= 60 THEN '中分 (60-79)'
        ELSE '低分 (<60)'
    END as score_range,
    COUNT(*) as count
FROM analysis_result
GROUP BY score_range;
```

### 获取待处理的机会

```sql
SELECT ar.id, ar.score, ci.title
FROM analysis_result ar
JOIN content_item ci ON ar.content_item_id = ci.id
WHERE ar.has_opportunity = true
  AND ar.action_status = 'pending'
ORDER BY ar.score DESC;
```

### 获取活跃的 Prompt

```sql
SELECT name, version, threshold
FROM prompt_version
WHERE is_active = true;
```
