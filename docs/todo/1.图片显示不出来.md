# 问题：分析详情页图片显示不出来

## 问题描述

在分析详情页（如 `/analysis/24`）中，右侧"原文内容"区域的微信公众号文章图片无法显示，提示"此图片来自微信公众号平台，未经允许不可以引用"。

但同一篇文章在 WeRSS 平台上可以正常显示图片。

## 问题原因

### 微信图片防盗链机制

微信服务器会检查请求图片时的 `Referer` 请求头：
- 如果 `Referer` 不是微信域名（如 `mp.weixin.qq.com`），则拒绝返回图片
- 当前系统直接引用微信图片 URL，浏览器请求时 `Referer` 是 `154.8.205.159:8080`
- 微信检测到非法 `Referer`，返回防盗链提示图

### WeRSS 为什么能显示

分析 WeRSS 源码（`driver/wxarticle.py`）发现：

1. **`proxy_images` 函数**：遍历所有 `<img>` 标签，将微信图片 URL 替换为 WeRSS 服务器的代理 URL
2. **`get_image_url` 函数**：生成代理 URL，格式为 `{base_url}/static/res/logo/{原始URL}`
3. WeRSS 服务端代理请求微信图片，服务端请求不受防盗链限制

### 当前代码位置

问题代码在 `src/app/web/templates/pages/analysis.html` 第 247 行：
```html
{{ content_item.raw_html | safe }}
```

直接渲染了原始 HTML，其中图片 URL 仍指向微信服务器。

---

## 解决方案

### 方案 A：自建图片代理服务（推荐长期方案）

**原理**：类似 WeRSS，创建后端代理路由，服务端请求微信图片后返回给前端。

**实现步骤**：
1. 新建代理 API 路由 `/api/proxy/image?url=xxx`
2. 在存储或显示 HTML 时，替换所有 `<img src="微信URL">` 为 `<img src="/api/proxy/image?url=微信URL">`
3. 可选：添加图片缓存机制

**优点**：
- ✅ 可靠性高，完全绕过防盗链
- ✅ 可缓存图片，减少微信请求
- ✅ 不依赖微信策略变化

**缺点**：
- ⚠️ 需要后端开发
- ⚠️ 增加服务器带宽负担
- ⚠️ 可能需要磁盘缓存

---

### 方案 B：添加 `no-referrer` Meta 标签（推荐快速方案）

**原理**：告诉浏览器请求图片时不发送 `Referer` 头。

**实现步骤**：
在 `src/app/web/templates/base.html` 的 `<head>` 中添加：
```html
<meta name="referrer" content="no-referrer">
```

**优点**：
- ✅ 改动极小，1 行代码
- ✅ 立即生效，无需后端改动

**缺点**：
- ⚠️ 可能影响其他需要 Referer 的功能
- ⚠️ 微信可能更新策略使其失效
- ⚠️ 部分情况可能仍被拦截

---

### 方案 C：抓取时下载图片

**原理**：在从 WeRSS 拉取文章时，就把图片下载保存到本地或 CDN。

**优点**：
- ✅ 图片永久可用，不依赖微信服务器
- ✅ 访问速度快

**缺点**：
- ⚠️ 开发量较大
- ⚠️ 占用存储空间
- ⚠️ 需要修改数据抓取逻辑

---

### 方案 D：使用第三方图片代理

**原理**：使用 `images.weserv.nl` 等免费图片代理服务。

**实现**：
替换图片 URL 为 `https://images.weserv.nl/?url=原始微信图片URL`

**优点**：
- ✅ 无需自建代理服务
- ✅ 开发量小

**缺点**：
- ⚠️ 依赖第三方服务稳定性
- ⚠️ 可能有速度和带宽限制
- ⚠️ 隐私考虑

---

## 推荐策略

1. **先尝试方案 B**（1 分钟改动），验证是否有效
2. 如果方案 B 无效或后续失效，再实现**方案 A**

---

## 相关文件

- `src/app/web/templates/pages/analysis.html` - 分析详情页模板
- `src/app/web/templates/base.html` - 基础模板（方案 B 修改位置）
- `src/app/services/analyzer.py` - 文章内容处理逻辑
