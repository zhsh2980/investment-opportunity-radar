# 投资机会雷达 - 开发工作流文档

> **开发模式**：MacBook（本地 AI 辅助开发）→ GitHub（代码托管）→ 腾讯云服务器（生产运行）

---

## 1. 环境概览

| 环境 | 用途 | 特点 |
|-----|------|------|
| **MacBook（本地）** | AI 工具开发代码 | 代码编写、测试、提交 |
| **GitHub** | 代码托管与版本控制 | 中转站，连接本地和服务器 |
| **腾讯云服务器** | 生产运行 | 运行服务、访问 WeRSS |

---

## 2. 分支策略（简化版）

只使用 **main 分支**，适合个人项目：

```
main（默认分支）
 ├── 本地开发 → commit → push
 └── 服务器 git pull → 重启服务
```

> [!TIP]
> 如果后续需要更规范的流程，可以再添加 `dev` 分支做开发隔离。

---

## 3. 日常开发流程

### 3.1 本地开发（MacBook）

```bash
# 1. 开发代码（使用 AI 工具）
# 2. 测试通过后，提交代码
git add .
git commit -m "feat: 描述你的改动"

# 3. 推送到 GitHub
git push origin main
```

### 3.2 部署到服务器（腾讯云）

**方式一：手动 SSH 部署**

```bash
# 从本地 SSH 到服务器，拉取代码并重启
ssh -i docs/key/你的密钥.pem ubuntu@服务器IP "cd /srv/radar && git pull && sudo systemctl restart radar"
```

**方式二：使用部署脚本（推荐）**

```bash
# 创建后可一键部署
./scripts/deploy.sh
```

---

## 4. 首次服务器配置

### 4.1 服务器 SSH 免密登录

在本地 `~/.ssh/config` 添加：

```
Host radar-server
    HostName 你的服务器IP
    User ubuntu
    IdentityFile ~/path/to/your-key.pem
```

之后可以简化为：

```bash
ssh radar-server
```

### 4.2 服务器添加 GitHub Deploy Key

```bash
# 1. 在服务器生成 SSH key
ssh radar-server
ssh-keygen -t ed25519 -C "radar-deploy" -f ~/.ssh/radar_deploy -N ""
cat ~/.ssh/radar_deploy.pub

# 2. 复制公钥，添加到 GitHub 仓库
# Settings → Deploy keys → Add deploy key（不勾选 write access）

# 3. 配置 SSH（443 端口，绕过网络限制）
cat >> ~/.ssh/config <<'EOF'
Host github.com
    HostName ssh.github.com
    Port 443
    User git
    IdentityFile ~/.ssh/radar_deploy
EOF

# 4. 测试连接
ssh -T git@github.com
```

### 4.3 服务器目录结构

```
/srv/radar/
├── app/              # 代码目录（git clone 下来的）
├── data/             # 持久化数据（数据库、日志）
├── .env              # 环境变量（不提交到 GitHub）
└── docker-compose.yml
```

---

## 5. 工作流示意图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           开发工作流                                      │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────┐     git push      ┌──────────────┐     git pull      ┌──────────────┐
│              │ ────────────────► │              │ ────────────────► │              │
│   MacBook    │                   │    GitHub    │                   │   腾讯云     │
│  (本地开发)   │                   │  (代码托管)   │                   │  (生产运行)  │
│              │ ◄──── 无需同步 ──── │              │ ◄─── 无需推送 ──── │              │
└──────────────┘                   └──────────────┘                   └──────────────┘
      │                                                                      │
      │  AI 工具开发                                                          │  运行服务
      │  代码编写测试                                                          │  访问 WeRSS
      │  git commit                                                          │  定时任务
      ▼                                                                      ▼
```

---

## 6. 常用命令速查

### 本地（MacBook）

| 操作 | 命令 |
|-----|------|
| 提交代码 | `git add . && git commit -m "message"` |
| 推送到 GitHub | `git push origin main` |
| 一键部署 | `./scripts/deploy.sh` |
| 查看服务器日志 | `ssh radar-server "journalctl -u radar -f"` |

### 服务器

| 操作 | 命令 |
|-----|------|
| 拉取最新代码 | `cd /srv/radar/app && git pull` |
| 重启服务 | `sudo systemctl restart radar` |
| 查看服务状态 | `sudo systemctl status radar` |
| 查看实时日志 | `journalctl -u radar -f` |

---

## 7. 注意事项

> [!IMPORTANT]
> - `docs/key/` 目录已加入 `.gitignore`，**永远不要提交密钥到 GitHub**
> - 服务器的 `.env` 文件包含敏感信息，**不要提交**
> - 每次部署前确保本地代码已通过测试

> [!TIP]
> - 使用 SSH 443 端口可以绕过大多数网络限制
> - 服务器 Deploy Key 只有只读权限，更安全

---

## 8. 静态资源缓存清理 (Cache Busting)

> [!WARNING]
> **修改 JS/CSS 文件后，必须更新版本号，否则用户浏览器会使用缓存的旧文件！**

### 为什么需要？

浏览器会缓存 `.js` 和 `.css` 文件以提升加载速度。当你修改了这些文件并部署后，用户的浏览器可能仍然使用旧版本，导致功能异常或样式不对。

### 如何操作？

1. **修改静态文件时**：同时更新 `base.html` 中对应资源的版本号参数。

   ```html
   <!-- 修改前 -->
   <script src="/static/app.js?v=3"></script>
   <link rel="stylesheet" href="/static/app.css?v=2">

   <!-- 修改后（版本号 +1） -->
   <script src="/static/app.js?v=4"></script>
   <link rel="stylesheet" href="/static/app.css?v=3">
   ```

2. **涉及的文件**：
   - `src/app/web/templates/base.html` — `app.js` 和 `app.css` 引用
   - `src/app/web/templates/login.html` — 登录页单独的 CSS 引用（如有）

3. **验证方式**：
   - 部署后，用 `Cmd+Shift+R` (Mac) 或 `Ctrl+Shift+R` (Windows) 强制刷新
   - 或在 URL 后加 `?v=xxx` 参数验证

### 最佳实践

| 场景 | 操作 |
|-----|------|
| 只修改 Python/HTML | 无需改版本号，HTML 已设置不缓存 |
| 修改 `app.js` | 更新 `base.html` 中 `app.js?v=N` |
| 修改 `app.css` 或 `pages.css` | 更新 `base.html` 中对应 CSS 的 `?v=N` |
| 大版本发布 | 所有静态资源版本号统一递增 |

> [!TIP]
> **未来优化**：可以引入构建工具（如 Vite）自动生成文件哈希，彻底解决手动管理版本号的问题。
